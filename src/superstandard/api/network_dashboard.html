<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANP Network Topology Dashboard - SuperStandard</title>
    <link rel="stylesheet" href="/design-system.css">
    <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: var(--color-neutral-50);
        }

        .app-layout {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav-bar {
            background: var(--color-white);
            border-bottom: 1px solid var(--color-neutral-200);
            padding: var(--spacing-4) var(--spacing-6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .nav-brand h1 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary-700);
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: var(--spacing-2);
        }

        .nav-link {
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--radius-md);
            color: var(--color-neutral-700);
            text-decoration: none;
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
            transition: var(--transition-color);
        }

        .nav-link:hover {
            background: var(--color-neutral-100);
            color: var(--color-neutral-900);
        }

        .nav-link.active {
            background: var(--color-primary-100);
            color: var(--color-primary-700);
        }

        .dashboard-header {
            background: var(--gradient-primary);
            padding: var(--spacing-8) var(--spacing-6);
            color: var(--color-white);
        }

        .header-content {
            max-width: 1536px;
            margin: 0 auto;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-6);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }

        .header-title h1 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            margin: 0;
        }

        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-4);
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--color-success-400);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-3);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-4);
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: var(--spacing-4);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide);
            margin-bottom: var(--spacing-2);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            line-height: var(--line-height-tight);
        }

        .stat-subtext {
            font-size: var(--font-size-xs);
            opacity: 0.8;
            margin-top: var(--spacing-1);
        }

        .main-content {
            max-width: 1536px;
            margin: 0 auto;
            padding: var(--spacing-6);
            width: 100%;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--spacing-6);
            margin-bottom: var(--spacing-6);
        }

        .visualization-panel {
            background: var(--color-white);
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .panel-header {
            padding: var(--spacing-5) var(--spacing-6);
            border-bottom: 1px solid var(--color-neutral-200);
            background: var(--color-neutral-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-neutral-900);
            margin: 0;
        }

        .panel-actions {
            display: flex;
            gap: var(--spacing-2);
        }

        .panel-body {
            padding: 0;
            position: relative;
        }

        #networkGraph {
            width: 100%;
            height: 600px;
            background: var(--color-neutral-50);
        }

        .graph-legend {
            position: absolute;
            bottom: var(--spacing-4);
            left: var(--spacing-4);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: var(--spacing-4);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            display: flex;
            gap: var(--spacing-4);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-size: var(--font-size-sm);
            color: var(--color-neutral-700);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--color-white);
            box-shadow: var(--shadow-sm);
        }

        .sidebar-panel {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-6);
        }

        .filter-card {
            background: var(--color-white);
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .filter-body {
            padding: var(--spacing-6);
        }

        .form-group {
            margin-bottom: var(--spacing-5);
        }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-neutral-900);
            margin-bottom: var(--spacing-2);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: var(--spacing-3) var(--spacing-4);
            font-size: var(--font-size-base);
            font-family: inherit;
            color: var(--color-neutral-900);
            background: var(--color-white);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-md);
            transition: var(--transition-base);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-primary-600);
            box-shadow: 0 0 0 3px var(--color-primary-100);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3) var(--spacing-5);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-base);
            width: 100%;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--color-primary-700);
            color: var(--color-white);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background: var(--color-primary-600);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--color-white);
            color: var(--color-neutral-700);
            border-color: var(--color-neutral-300);
        }

        .btn-secondary:hover {
            background: var(--color-neutral-50);
            border-color: var(--color-neutral-400);
        }

        .btn-icon {
            padding: var(--spacing-2);
            aspect-ratio: 1;
        }

        .agent-list-card {
            background: var(--color-white);
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .agent-list {
            max-height: 500px;
            overflow-y: auto;
            padding: var(--spacing-4);
        }

        .agent-item {
            background: var(--color-white);
            border: 1px solid var(--color-neutral-200);
            border-left: 4px solid var(--color-success-500);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            margin-bottom: var(--spacing-3);
            transition: var(--transition-base);
            cursor: pointer;
        }

        .agent-item:hover {
            background: var(--color-neutral-50);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .agent-item.degraded {
            border-left-color: var(--color-warning-500);
        }

        .agent-item.unhealthy {
            border-left-color: var(--color-error-500);
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-2);
        }

        .agent-id {
            font-weight: var(--font-weight-semibold);
            color: var(--color-neutral-900);
            font-size: var(--font-size-sm);
        }

        .agent-type {
            font-size: var(--font-size-xs);
            color: var(--color-neutral-600);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide);
        }

        .agent-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-1);
            padding: 2px 8px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide);
        }

        .agent-badge.healthy {
            background: var(--color-success-100);
            color: var(--color-success-700);
        }

        .agent-badge.degraded {
            background: var(--color-warning-100);
            color: var(--color-warning-700);
        }

        .agent-badge.unhealthy {
            background: var(--color-error-100);
            color: var(--color-error-700);
        }

        .agent-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-3);
            font-size: var(--font-size-xs);
            color: var(--color-neutral-600);
            margin-bottom: var(--spacing-2);
        }

        .agent-capabilities {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-2);
        }

        .capability-tag {
            padding: 2px 8px;
            background: var(--color-primary-100);
            color: var(--color-primary-700);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: var(--z-index-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-4);
            animation: fadeIn var(--duration-normal) var(--ease-out);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--color-white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp var(--duration-slow) var(--ease-out);
        }

        .modal-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--color-neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-neutral-900);
            margin: 0;
        }

        .modal-close {
            padding: var(--spacing-2);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-neutral-500);
            font-size: var(--font-size-xl);
            line-height: 1;
            transition: color var(--duration-normal);
        }

        .modal-close:hover {
            color: var(--color-neutral-900);
        }

        .modal-body {
            padding: var(--spacing-6);
            overflow-y: auto;
            flex: 1;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-3) 0;
            border-bottom: 1px solid var(--color-neutral-200);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: var(--font-weight-semibold);
            color: var(--color-neutral-700);
            font-size: var(--font-size-sm);
        }

        .detail-value {
            color: var(--color-neutral-900);
            font-size: var(--font-size-sm);
            text-align: right;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-12) var(--spacing-6);
            color: var(--color-neutral-600);
        }

        .empty-state-icon {
            font-size: var(--font-size-5xl);
            opacity: 0.3;
            margin-bottom: var(--spacing-6);
        }

        .empty-state-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-neutral-900);
            margin-bottom: var(--spacing-3);
        }

        .empty-state-message {
            font-size: var(--font-size-base);
            color: var(--color-neutral-600);
            margin-bottom: var(--spacing-6);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scrollbar styling */
        .agent-list::-webkit-scrollbar {
            width: 8px;
        }

        .agent-list::-webkit-scrollbar-track {
            background: var(--color-neutral-100);
            border-radius: var(--radius-sm);
        }

        .agent-list::-webkit-scrollbar-thumb {
            background: var(--color-neutral-300);
            border-radius: var(--radius-sm);
        }

        .agent-list::-webkit-scrollbar-thumb:hover {
            background: var(--color-neutral-400);
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-4);
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            .nav-links {
                flex-direction: column;
                gap: var(--spacing-1);
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Navigation Bar -->
        <nav class="nav-bar">
            <div class="nav-brand">
                <h1>SuperStandard</h1>
            </div>
            <div class="nav-links">
                <a href="/dashboard/admin" class="nav-link">Admin</a>
                <a href="/dashboard/network" class="nav-link active">Network</a>
                <a href="/dashboard/coordination" class="nav-link">Coordination</a>
                <a href="/dashboard/consciousness" class="nav-link">Consciousness</a>
                <a href="/dashboard/user" class="nav-link">User Panel</a>
            </div>
        </nav>

        <!-- Dashboard Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-top">
                    <div class="header-title">
                        <h1>Network Topology</h1>
                        <span class="live-badge">
                            <span class="live-dot"></span>
                            LIVE
                        </span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportTopology()">
                            Export Topology
                        </button>
                        <button class="btn btn-secondary" onclick="refreshNetwork()">
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">Total Agents</div>
                        <div class="stat-value" id="totalAgents">0</div>
                        <div class="stat-subtext">Registered on network</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Healthy</div>
                        <div class="stat-value" id="healthyAgents">0</div>
                        <div class="stat-subtext">Operating normally</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Capabilities</div>
                        <div class="stat-value" id="totalCapabilities">0</div>
                        <div class="stat-subtext">Unique skills available</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Connectivity</div>
                        <div class="stat-value" id="networkHealth">100%</div>
                        <div class="stat-subtext">Network health score</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-grid">
                <!-- Network Visualization -->
                <div class="visualization-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">Agent Network Graph</h2>
                        <div class="panel-actions">
                            <button class="btn btn-secondary btn-icon" onclick="fitNetwork()" title="Fit to screen">
                                <span>‚äï</span>
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div id="networkGraph"></div>
                        <div class="graph-legend">
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #22c55e;"></span>
                                <span>Healthy</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #f97316;"></span>
                                <span>Degraded</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #ef4444;"></span>
                                <span>Unhealthy</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #6366f1;"></span>
                                <span>Selected</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar-panel">
                    <!-- Search & Filter -->
                    <div class="filter-card">
                        <div class="panel-header">
                            <h2 class="panel-title">Agent Discovery</h2>
                        </div>
                        <div class="filter-body">
                            <div class="form-group">
                                <label class="form-label">Search by ID or Capability</label>
                                <input type="text" class="form-input" id="searchInput" placeholder="Enter agent ID or capability...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agent Type</label>
                                <select class="form-select" id="typeFilter">
                                    <option value="">All Types</option>
                                    <option value="analyst">Analyst</option>
                                    <option value="optimizer">Optimizer</option>
                                    <option value="manager">Manager</option>
                                    <option value="processor">Processor</option>
                                    <option value="coordinator">Coordinator</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Health Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="healthy">Healthy</option>
                                    <option value="degraded">Degraded</option>
                                    <option value="unhealthy">Unhealthy</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="filter-card">
                        <div class="panel-header">
                            <h2 class="panel-title">Network Metrics</h2>
                        </div>
                        <div class="filter-body">
                            <div class="detail-row">
                                <span class="detail-label">Discoveries (24h)</span>
                                <span class="detail-value" id="discoveries24h">0</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Heartbeat Rate</span>
                                <span class="detail-value" id="heartbeatRate">0/min</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Avg Response Time</span>
                                <span class="detail-value" id="avgResponseTime">0ms</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Network Uptime</span>
                                <span class="detail-value" id="networkUptime">99.9%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent List -->
            <div class="agent-list-card">
                <div class="panel-header">
                    <h2 class="panel-title">Registered Agents (<span id="agentCount">0</span>)</h2>
                    <div class="panel-actions">
                        <input type="text" class="form-input" id="quickSearch" placeholder="Quick search..." style="width: 250px;">
                    </div>
                </div>
                <div class="agent-list" id="agentList">
                    <!-- Agents will be dynamically populated -->
                </div>
            </div>
        </main>
    </div>

    <!-- Agent Detail Modal -->
    <div class="modal-overlay" id="agentModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalAgentId">Agent Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Details will be dynamically populated -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_URL = `${WS_PROTOCOL}//${window.location.host}/ws/network`;

        // State
        let agents = [];
        let network = null;
        let ws = null;
        let filteredAgents = [];

        // Initialize vis-network
        function initNetwork() {
            const container = document.getElementById('networkGraph');
            const data = {
                nodes: [],
                edges: []
            };

            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: {
                        size: 12,
                        color: '#3f3f46',
                        face: 'Inter, sans-serif'
                    },
                    borderWidth: 2,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.1)',
                        size: 10,
                        x: 0,
                        y: 2
                    }
                },
                edges: {
                    width: 1,
                    color: {
                        color: '#e4e4e7',
                        highlight: '#a1a1aa',
                        hover: '#d4d4d8'
                    },
                    smooth: {
                        type: 'continuous'
                    }
                },
                physics: {
                    enabled: true,
                    forceAtlas2Based: {
                        gravitationalConstant: -50,
                        centralGravity: 0.01,
                        springLength: 150,
                        springConstant: 0.08,
                        damping: 0.4,
                        avoidOverlap: 0.5
                    },
                    maxVelocity: 50,
                    solver: 'forceAtlas2Based',
                    timestep: 0.35,
                    stabilization: {
                        enabled: true,
                        iterations: 100,
                        updateInterval: 25
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200,
                    hideEdgesOnDrag: true,
                    hideEdgesOnZoom: true
                }
            };

            network = new vis.Network(container, data, options);

            // Event handlers
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const agentId = params.nodes[0];
                    showAgentDetails(agentId);
                }
            });

            network.on('hoverNode', function(params) {
                network.canvas.body.container.style.cursor = 'pointer';
            });

            network.on('blurNode', function(params) {
                network.canvas.body.container.style.cursor = 'default';
            });
        }

        // Update network visualization
        function updateNetwork() {
            if (!network) return;

            const nodes = agents.map(agent => ({
                id: agent.agent_id,
                label: agent.agent_id,
                title: `${agent.agent_id}\nType: ${agent.agent_type}\nStatus: ${agent.health_status}`,
                color: getNodeColor(agent.health_status),
                size: agent.agent_type === 'coordinator' ? 30 : 20
            }));

            // Create edges based on agent capabilities (agents with similar capabilities connect)
            const edges = [];
            for (let i = 0; i < agents.length; i++) {
                for (let j = i + 1; j < agents.length; j++) {
                    const agent1 = agents[i];
                    const agent2 = agents[j];

                    // Connect agents with shared capabilities
                    const sharedCaps = agent1.capabilities.filter(cap =>
                        agent2.capabilities.includes(cap)
                    );

                    if (sharedCaps.length > 0) {
                        edges.push({
                            from: agent1.agent_id,
                            to: agent2.agent_id,
                            width: sharedCaps.length,
                            title: `Shared: ${sharedCaps.join(', ')}`
                        });
                    }
                }
            }

            network.setData({ nodes, edges });
        }

        // Get node color based on status
        function getNodeColor(status) {
            const colors = {
                healthy: '#22c55e',
                degraded: '#f97316',
                unhealthy: '#ef4444'
            };
            return {
                background: colors[status] || colors.healthy,
                border: '#ffffff',
                highlight: {
                    background: '#6366f1',
                    border: '#4f46e5'
                },
                hover: {
                    background: colors[status] || colors.healthy,
                    border: '#3f3f46'
                }
            };
        }

        // Fetch agents from API
        async function fetchAgents() {
            try {
                const response = await fetch(`${API_BASE}/api/anp/agents`);
                const data = await response.json();

                if (data.success) {
                    agents = data.agents || [];
                    filteredAgents = agents;
                    updateNetwork();
                    renderAgentList();
                    updateStats();
                }
            } catch (error) {
                console.error('[Network] Failed to fetch agents:', error);
            }
        }

        // Fetch network stats
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/api/anp/stats`);
                const data = await response.json();

                document.getElementById('discoveries24h').textContent = data.discoveries_24h || 0;
                document.getElementById('heartbeatRate').textContent = `${data.heartbeat_rate || 0}/min`;
                document.getElementById('networkUptime').textContent = `${data.network_uptime || 99.9}%`;
            } catch (error) {
                console.error('[Network] Failed to fetch stats:', error);
            }
        }

        // Update dashboard stats
        function updateStats() {
            const healthy = agents.filter(a => a.health_status === 'healthy').length;
            const allCaps = new Set(agents.flatMap(a => a.capabilities));

            document.getElementById('totalAgents').textContent = agents.length;
            document.getElementById('healthyAgents').textContent = healthy;
            document.getElementById('totalCapabilities').textContent = allCaps.size;
            document.getElementById('networkHealth').textContent = agents.length > 0
                ? `${Math.round((healthy / agents.length) * 100)}%`
                : '100%';
        }

        // Render agent list
        function renderAgentList(agentsList = filteredAgents) {
            const listEl = document.getElementById('agentList');
            document.getElementById('agentCount').textContent = agentsList.length;

            if (agentsList.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üåê</div>
                        <h3 class="empty-state-title">No Agents Found</h3>
                        <p class="empty-state-message">No agents match your current filters. Try adjusting your search criteria.</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = agentsList.map(agent => `
                <div class="agent-item ${agent.health_status}" onclick="showAgentDetails('${agent.agent_id}')">
                    <div class="agent-header">
                        <div>
                            <div class="agent-id">${agent.agent_id}</div>
                            <div class="agent-type">${agent.agent_type}</div>
                        </div>
                        <span class="agent-badge ${agent.health_status}">${agent.health_status}</span>
                    </div>
                    <div class="agent-meta">
                        <span>üìç ${agent.region || 'N/A'}</span>
                        <span>‚ö° Load: ${Math.round((agent.load_score || 0) * 100)}%</span>
                        <span>üîó ${agent.endpoints?.http || 'N/A'}</span>
                    </div>
                    <div class="agent-capabilities">
                        ${agent.capabilities.map(cap => `<span class="capability-tag">${cap}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Show agent details modal
        function showAgentDetails(agentId) {
            const agent = agents.find(a => a.agent_id === agentId);
            if (!agent) return;

            document.getElementById('modalAgentId').textContent = agent.agent_id;
            document.getElementById('modalContent').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Agent ID</span>
                    <span class="detail-value">${agent.agent_id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Type</span>
                    <span class="detail-value">${agent.agent_type}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Health Status</span>
                    <span class="detail-value">
                        <span class="agent-badge ${agent.health_status}">${agent.health_status}</span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Load Score</span>
                    <span class="detail-value">${Math.round((agent.load_score || 0) * 100)}%</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Region</span>
                    <span class="detail-value">${agent.region || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Endpoint</span>
                    <span class="detail-value">${agent.endpoints?.http || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Last Heartbeat</span>
                    <span class="detail-value">${agent.last_heartbeat ? new Date(agent.last_heartbeat).toLocaleString() : 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Capabilities</span>
                    <span class="detail-value">
                        <div class="agent-capabilities">
                            ${agent.capabilities.map(cap => `<span class="capability-tag">${cap}</span>`).join('')}
                        </div>
                    </span>
                </div>
            `;

            document.getElementById('agentModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('agentModal').classList.remove('active');
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredAgents = agents.filter(agent => {
                const matchesSearch = !searchTerm ||
                    agent.agent_id.toLowerCase().includes(searchTerm) ||
                    agent.capabilities.some(cap => cap.toLowerCase().includes(searchTerm));
                const matchesType = !typeFilter || agent.agent_type === typeFilter;
                const matchesStatus = !statusFilter || agent.health_status === statusFilter;

                return matchesSearch && matchesType && matchesStatus;
            });

            renderAgentList(filteredAgents);
        }

        // Quick search
        document.getElementById('quickSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = agents.filter(agent =>
                agent.agent_id.toLowerCase().includes(searchTerm) ||
                agent.agent_type.toLowerCase().includes(searchTerm) ||
                agent.capabilities.some(cap => cap.toLowerCase().includes(searchTerm))
            );
            renderAgentList(filtered);
        });

        // Export topology
        function exportTopology() {
            const topology = {
                timestamp: new Date().toISOString(),
                total_agents: agents.length,
                agents: agents.map(agent => ({
                    id: agent.agent_id,
                    type: agent.agent_type,
                    status: agent.health_status,
                    capabilities: agent.capabilities,
                    region: agent.region,
                    load_score: agent.load_score
                }))
            };

            const blob = new Blob([JSON.stringify(topology, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `network-topology-${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Refresh network
        function refreshNetwork() {
            fetchAgents();
            fetchStats();
        }

        // Fit network to screen
        function fitNetwork() {
            if (network) {
                network.fit({
                    animation: {
                        duration: 500,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log('[Network] WebSocket connected');
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'agent_registered') {
                            console.log('[Network] Agent registered:', data.agent_id);
                            fetchAgents();
                        }
                    } catch (e) {
                        console.error('[Network] WebSocket message error:', e);
                    }
                };

                ws.onclose = () => {
                    console.log('[Network] WebSocket disconnected, reconnecting in 5s...');
                    setTimeout(connectWebSocket, 5000);
                };

                ws.onerror = (error) => {
                    console.error('[Network] WebSocket error:', error);
                };
            } catch (e) {
                console.error('[Network] Failed to connect WebSocket:', e);
                setTimeout(connectWebSocket, 5000);
            }
        }

        // Close modal on overlay click
        document.getElementById('agentModal').addEventListener('click', (e) => {
            if (e.target.id === 'agentModal') {
                closeModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Initialize
        console.log('[Network] Initializing ANP Network Dashboard...');
        initNetwork();
        fetchAgents();
        fetchStats();
        connectWebSocket();

        // Auto-refresh every 5 seconds
        setInterval(fetchAgents, 5000);
        setInterval(fetchStats, 10000);
    </script>
</body>
</html>
