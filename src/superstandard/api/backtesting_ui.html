<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS Backtesting Lab - Advanced Strategy Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        .card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            color: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
        }

        .form-group select option {
            background: #667eea;
            color: white;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
        }

        .metric-value.positive {
            color: #4ade80;
        }

        .metric-value.negative {
            color: #f87171;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .chart-container-large {
            height: 500px;
        }

        .trade-log {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .trade-log table {
            width: 100%;
            border-collapse: collapse;
        }

        .trade-log th,
        .trade-log td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .trade-log th {
            background: rgba(255,255,255,0.1);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .trade-log tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .trade-buy {
            color: #4ade80;
        }

        .trade-sell {
            color: #f87171;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .comparison-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .comparison-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-5px);
        }

        .comparison-card.selected {
            background: rgba(102, 126, 234, 0.3);
            border: 2px solid rgba(102, 126, 234, 0.6);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(248, 113, 113, 0.2);
            border: 2px solid #f87171;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .success-message {
            background: rgba(74, 222, 128, 0.2);
            border: 2px solid #4ade80;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .heatmap-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        .heatmap {
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            gap: 5px;
            min-width: 700px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .heatmap-header {
            background: rgba(255,255,255,0.1);
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            border-bottom: 3px solid white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>NEXUS Backtesting Lab</h1>
            <p>Advanced Strategy Analysis & Performance Visualization</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>Backtesting Engine: Ready</span>
            </div>
            <div class="status-item">
                <span id="activeBacktests">Active Backtests: 0</span>
            </div>
            <div class="status-item">
                <span id="totalBacktests">Total Results: 0</span>
            </div>
        </div>

        <!-- Configuration Panel -->
        <div class="grid">
            <div class="card">
                <h2><span class="card-icon">‚öôÔ∏è</span> Backtest Configuration</h2>

                <div class="form-group">
                    <label>Select Strategy</label>
                    <select id="strategySelect">
                        <option value="">Loading strategies...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Trading Symbol</label>
                    <input type="text" id="symbolInput" placeholder="e.g., SOL/USD, BTC/USD" value="SOL/USD">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="startDate" value="2023-01-01">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Initial Capital ($)</label>
                        <input type="number" id="initialCapital" value="10000" step="1000">
                    </div>
                    <div class="form-group">
                        <label>Timeframe</label>
                        <select id="timeframe">
                            <option value="1h">1 Hour</option>
                            <option value="4h">4 Hours</option>
                            <option value="1d" selected>1 Day</option>
                            <option value="1w">1 Week</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Commission (%)</label>
                        <input type="number" id="commission" value="0.1" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Slippage (bps)</label>
                        <input type="number" id="slippage" value="5" step="1">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="runBacktest()">
                    üöÄ Run Backtest
                </button>

                <div id="backtestStatus"></div>
            </div>

            <!-- Quick Metrics -->
            <div class="card">
                <h2><span class="card-icon">üìä</span> Performance Summary</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Return</div>
                        <div class="metric-value" id="metricReturn">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Sharpe Ratio</div>
                        <div class="metric-value" id="metricSharpe">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Max Drawdown</div>
                        <div class="metric-value" id="metricDrawdown">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="metricWinRate">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value" id="metricTrades">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Profit Factor</div>
                        <div class="metric-value" id="metricProfitFactor">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analysis -->
        <div class="grid">
            <!-- Equity Curve -->
            <div class="card grid-full">
                <h2><span class="card-icon">üìà</span> Equity Curve</h2>
                <div class="chart-container chart-container-large">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>

            <!-- Tabs for Different Views -->
            <div class="card grid-full">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('trades')">Trade Log</div>
                    <div class="tab" onclick="switchTab('drawdown')">Drawdown Analysis</div>
                    <div class="tab" onclick="switchTab('returns')">Returns Distribution</div>
                    <div class="tab" onclick="switchTab('heatmap')">Monthly Performance</div>
                    <div class="tab" onclick="switchTab('comparison')">Compare Strategies</div>
                </div>

                <!-- Trade Log Tab -->
                <div id="tradesTab" class="tab-content active">
                    <div class="trade-log">
                        <table id="tradeLogTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Entry Price</th>
                                    <th>Exit Price</th>
                                    <th>P&L</th>
                                    <th>Return %</th>
                                </tr>
                            </thead>
                            <tbody id="tradeLogBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        Run a backtest to see trade details
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Drawdown Tab -->
                <div id="drawdownTab" class="tab-content">
                    <div class="chart-container">
                        <canvas id="drawdownChart"></canvas>
                    </div>
                </div>

                <!-- Returns Distribution Tab -->
                <div id="returnsTab" class="tab-content">
                    <div class="chart-container">
                        <canvas id="returnsChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Heatmap Tab -->
                <div id="heatmapTab" class="tab-content">
                    <div class="heatmap-container">
                        <div id="monthlyHeatmap"></div>
                    </div>
                </div>

                <!-- Comparison Tab -->
                <div id="comparisonTab" class="tab-content">
                    <p style="margin-bottom: 15px;">Select up to 3 strategies to compare:</p>
                    <div class="comparison-grid" id="comparisonGrid">
                        <!-- Will be populated dynamically -->
                    </div>
                    <div class="chart-container" style="margin-top: 20px;">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8080';

        // State
        let currentBacktestId = null;
        let currentBacktestData = null;
        let equityChart = null;
        let drawdownChart = null;
        let returnsChart = null;
        let comparisonChart = null;
        let selectedStrategies = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStrategies();
            setDefaultDates();
        });

        function setDefaultDates() {
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate;
        }

        async function loadStrategies() {
            try {
                const response = await fetch(`${API_BASE}/api/strategies`);
                const strategies = await response.json();

                const select = document.getElementById('strategySelect');
                select.innerHTML = '<option value="">-- Select a strategy --</option>';

                strategies.forEach(strategy => {
                    const option = document.createElement('option');
                    option.value = strategy.id;
                    option.textContent = `${strategy.name} (v${strategy.version})`;
                    select.appendChild(option);
                });

                // Update comparison grid
                updateComparisonGrid(strategies);

                // Update total count
                document.getElementById('totalBacktests').textContent = `Total Results: ${strategies.length}`;
            } catch (error) {
                console.error('Error loading strategies:', error);
                showError('Failed to load strategies');
            }
        }

        function updateComparisonGrid(strategies) {
            const grid = document.getElementById('comparisonGrid');
            grid.innerHTML = '';

            strategies.forEach(strategy => {
                const card = document.createElement('div');
                card.className = 'comparison-card';
                card.onclick = () => toggleStrategySelection(strategy.id, card);
                card.innerHTML = `
                    <h3>${strategy.name}</h3>
                    <p style="opacity: 0.8; font-size: 0.9em;">Version ${strategy.version}</p>
                    <p style="margin-top: 10px; font-size: 0.85em;">${strategy.tags.join(', ')}</p>
                `;
                grid.appendChild(card);
            });
        }

        function toggleStrategySelection(strategyId, cardElement) {
            const index = selectedStrategies.indexOf(strategyId);

            if (index > -1) {
                selectedStrategies.splice(index, 1);
                cardElement.classList.remove('selected');
            } else {
                if (selectedStrategies.length >= 3) {
                    showError('Maximum 3 strategies can be compared');
                    return;
                }
                selectedStrategies.push(strategyId);
                cardElement.classList.add('selected');
            }

            if (selectedStrategies.length >= 2) {
                compareStrategies();
            }
        }

        async function compareStrategies() {
            // This would load backtest results for selected strategies and compare them
            console.log('Comparing strategies:', selectedStrategies);
            // Implementation would fetch results and update comparison chart
        }

        async function runBacktest() {
            const strategyId = document.getElementById('strategySelect').value;
            const symbol = document.getElementById('symbolInput').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const initialCapital = parseFloat(document.getElementById('initialCapital').value);
            const commission = parseFloat(document.getElementById('commission').value);
            const slippage = parseInt(document.getElementById('slippage').value);
            const timeframe = document.getElementById('timeframe').value;

            if (!strategyId) {
                showError('Please select a strategy');
                return;
            }

            if (!symbol || !startDate || !endDate) {
                showError('Please fill in all required fields');
                return;
            }

            const statusDiv = document.getElementById('backtestStatus');
            statusDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Running backtest...</p>
                </div>
            `;

            try {
                // Submit backtest
                const response = await fetch(`${API_BASE}/api/backtest/run`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        strategy_id: strategyId,
                        symbol: symbol,
                        start_date: `${startDate}T00:00:00Z`,
                        end_date: `${endDate}T23:59:59Z`,
                        initial_capital: initialCapital,
                        commission_rate: commission / 100,
                        slippage_bps: slippage,
                        timeframe: timeframe
                    })
                });

                const data = await response.json();
                currentBacktestId = data.backtest_id;

                // Update active count
                document.getElementById('activeBacktests').textContent = 'Active Backtests: 1';

                // Poll for results
                pollBacktestResults();

            } catch (error) {
                console.error('Error running backtest:', error);
                showError('Failed to run backtest: ' + error.message);
                statusDiv.innerHTML = '';
            }
        }

        async function pollBacktestResults() {
            let attempts = 0;
            const maxAttempts = 60; // 60 seconds max

            const interval = setInterval(async () => {
                attempts++;

                try {
                    const response = await fetch(`${API_BASE}/api/backtest/status/${currentBacktestId}`);
                    const data = await response.json();

                    if (data.status === 'completed' && data.results) {
                        clearInterval(interval);
                        displayBacktestResults(data.results);
                        document.getElementById('backtestStatus').innerHTML = `
                            <div class="success-message">
                                Backtest completed successfully!
                            </div>
                        `;
                        document.getElementById('activeBacktests').textContent = 'Active Backtests: 0';
                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        showError('Backtest failed: ' + data.error);
                        document.getElementById('activeBacktests').textContent = 'Active Backtests: 0';
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        showError('Backtest timed out');
                        document.getElementById('activeBacktests').textContent = 'Active Backtests: 0';
                    }
                } catch (error) {
                    console.error('Error polling results:', error);
                }
            }, 1000);
        }

        function displayBacktestResults(results) {
            currentBacktestData = results;

            // Update metrics
            updateMetrics(results);

            // Update charts
            updateEquityChart(results);
            updateDrawdownChart(results);
            updateReturnsChart(results);
            updateTradeLog(results);
            updateMonthlyHeatmap(results);
        }

        function updateMetrics(results) {
            const totalReturn = ((results.final_value - results.initial_capital) / results.initial_capital * 100).toFixed(2);

            document.getElementById('metricReturn').textContent = `${totalReturn}%`;
            document.getElementById('metricReturn').className = 'metric-value ' + (totalReturn >= 0 ? 'positive' : 'negative');

            document.getElementById('metricSharpe').textContent = results.sharpe_ratio.toFixed(2);
            document.getElementById('metricDrawdown').textContent = `${(results.max_drawdown * 100).toFixed(2)}%`;
            document.getElementById('metricWinRate').textContent = `${(results.win_rate * 100).toFixed(1)}%`;
            document.getElementById('metricTrades').textContent = results.total_trades;
            document.getElementById('metricProfitFactor').textContent = results.profit_factor.toFixed(2);
        }

        function updateEquityChart(results) {
            const ctx = document.getElementById('equityChart').getContext('2d');

            // Destroy existing chart
            if (equityChart) {
                equityChart.destroy();
            }

            // Generate equity curve data (mock for now - would come from API)
            const equityData = generateEquityCurve(results);

            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: equityData.labels,
                    datasets: [{
                        label: 'Portfolio Value ($)',
                        data: equityData.values,
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: 'white',
                                callback: (value) => '$' + value.toLocaleString()
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function updateDrawdownChart(results) {
            const ctx = document.getElementById('drawdownChart').getContext('2d');

            if (drawdownChart) {
                drawdownChart.destroy();
            }

            const drawdownData = generateDrawdownData(results);

            drawdownChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: drawdownData.labels,
                    datasets: [{
                        label: 'Drawdown (%)',
                        data: drawdownData.values,
                        borderColor: '#f87171',
                        backgroundColor: 'rgba(248, 113, 113, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: 'white',
                                callback: (value) => value.toFixed(2) + '%'
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function updateReturnsChart(results) {
            const ctx = document.getElementById('returnsChart').getContext('2d');

            if (returnsChart) {
                returnsChart.destroy();
            }

            const returnsData = generateReturnsDistribution(results);

            returnsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: returnsData.labels,
                    datasets: [{
                        label: 'Frequency',
                        data: returnsData.values,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function updateTradeLog(results) {
            const tbody = document.getElementById('tradeLogBody');

            // Generate sample trades (would come from API)
            const trades = generateSampleTrades(results);

            tbody.innerHTML = '';
            trades.forEach((trade, idx) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${trade.date}</td>
                    <td class="${trade.type === 'BUY' ? 'trade-buy' : 'trade-sell'}">${trade.type}</td>
                    <td>${trade.symbol}</td>
                    <td>${trade.quantity.toFixed(4)}</td>
                    <td>$${trade.entry_price.toFixed(2)}</td>
                    <td>$${trade.exit_price.toFixed(2)}</td>
                    <td class="${trade.pnl >= 0 ? 'trade-buy' : 'trade-sell'}">$${trade.pnl.toFixed(2)}</td>
                    <td class="${trade.return_pct >= 0 ? 'trade-buy' : 'trade-sell'}">${trade.return_pct.toFixed(2)}%</td>
                `;
            });
        }

        function updateMonthlyHeatmap(results) {
            const container = document.getElementById('monthlyHeatmap');
            const heatmapData = generateMonthlyReturns(results);

            let html = '<div class="heatmap">';

            // Header row
            html += '<div class="heatmap-cell heatmap-header"></div>';
            ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].forEach(month => {
                html += `<div class="heatmap-cell heatmap-header">${month}</div>`;
            });

            // Data rows
            Object.keys(heatmapData).forEach(year => {
                html += `<div class="heatmap-cell heatmap-header">${year}</div>`;
                for (let month = 0; month < 12; month++) {
                    const value = heatmapData[year][month];
                    const color = getHeatmapColor(value);
                    html += `<div class="heatmap-cell" style="background: ${color}">${value !== null ? value.toFixed(1) + '%' : '-'}</div>`;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function getHeatmapColor(value) {
            if (value === null) return 'rgba(255,255,255,0.05)';
            if (value >= 10) return 'rgba(74, 222, 128, 0.8)';
            if (value >= 5) return 'rgba(74, 222, 128, 0.5)';
            if (value >= 0) return 'rgba(74, 222, 128, 0.2)';
            if (value >= -5) return 'rgba(248, 113, 113, 0.2)';
            if (value >= -10) return 'rgba(248, 113, 113, 0.5)';
            return 'rgba(248, 113, 113, 0.8)';
        }

        // Helper functions to generate sample data
        function generateEquityCurve(results) {
            const points = 100;
            const labels = [];
            const values = [];
            const startDate = new Date('2023-01-01');

            let currentValue = results.initial_capital;
            const dailyReturn = Math.pow(results.final_value / results.initial_capital, 1 / points) - 1;

            for (let i = 0; i <= points; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i * 3);
                labels.push(date.toLocaleDateString());

                currentValue *= (1 + dailyReturn + (Math.random() - 0.5) * 0.02);
                values.push(currentValue.toFixed(2));
            }

            return { labels, values };
        }

        function generateDrawdownData(results) {
            const points = 100;
            const labels = [];
            const values = [];
            const startDate = new Date('2023-01-01');

            let peak = 0;

            for (let i = 0; i <= points; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i * 3);
                labels.push(date.toLocaleDateString());

                const randomDrawdown = -Math.random() * results.max_drawdown * 100;
                peak = Math.max(peak, 0);
                const currentDrawdown = Math.min(randomDrawdown, peak);
                values.push(currentDrawdown);
            }

            return { labels, values };
        }

        function generateReturnsDistribution(results) {
            const labels = ['-10%', '-5%', '-2%', '0%', '2%', '5%', '10%', '15%'];
            const values = [2, 8, 15, 25, 30, 15, 4, 1]; // Sample distribution
            return { labels, values };
        }

        function generateSampleTrades(results) {
            const trades = [];
            const numTrades = results.total_trades;
            const startDate = new Date('2023-01-01');

            for (let i = 0; i < Math.min(numTrades, 50); i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i * 7);

                const entryPrice = 100 + Math.random() * 50;
                const exitPrice = entryPrice * (1 + (Math.random() - 0.4) * 0.1);
                const quantity = 10 + Math.random() * 90;
                const pnl = (exitPrice - entryPrice) * quantity;
                const returnPct = ((exitPrice - entryPrice) / entryPrice) * 100;

                trades.push({
                    date: date.toLocaleDateString(),
                    type: i % 2 === 0 ? 'BUY' : 'SELL',
                    symbol: 'SOL/USD',
                    quantity,
                    entry_price: entryPrice,
                    exit_price: exitPrice,
                    pnl,
                    return_pct: returnPct
                });
            }

            return trades;
        }

        function generateMonthlyReturns(results) {
            const data = {
                '2023': Array(12).fill(null).map(() => (Math.random() - 0.5) * 20),
                '2024': Array(12).fill(null).map(() => (Math.random() - 0.5) * 20)
            };
            return data;
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function showError(message) {
            const statusDiv = document.getElementById('backtestStatus');
            statusDiv.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
