<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Ensemble Dashboard - Production Deployment</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.2);
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Ensemble Creation */
        .create-ensemble-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1em;
        }

        .form-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Ensemble List */
        .ensemble-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .ensemble-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }

        .ensemble-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .ensemble-item.selected {
            background: rgba(102, 126, 234, 0.3);
            border: 2px solid rgba(102, 126, 234, 0.6);
        }

        .ensemble-item h3 {
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .ensemble-item .meta {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Specialist Grid */
        .specialist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .specialist-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.2s;
        }

        .specialist-card:hover {
            transform: scale(1.05);
        }

        .specialist-type {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 10px;
            text-transform: capitalize;
        }

        .specialist-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            margin: 5px;
        }

        .badge-bull { background: rgba(76, 175, 80, 0.3); }
        .badge-bear { background: rgba(244, 67, 54, 0.3); }
        .badge-volatile { background: rgba(255, 152, 0, 0.3); }
        .badge-sideways { background: rgba(33, 150, 243, 0.3); }
        .badge-generalist { background: rgba(156, 39, 176, 0.3); }

        /* Decision Feed */
        .decision-feed {
            max-height: 500px;
            overflow-y: auto;
        }

        .decision-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .decision-item.buy { border-color: #4caf50; }
        .decision-item.sell { border-color: #f44336; }
        .decision-item.hold { border-color: #2196f3; }

        .decision-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .decision-action {
            font-weight: 600;
            font-size: 1.1em;
            text-transform: uppercase;
        }

        .decision-time {
            font-size: 0.85em;
            opacity: 0.7;
        }

        .decision-details {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analytics-card h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.8em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* Backtest Styles */
        .backtest-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .trade-log-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .trade-log-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .trade-log-table th {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .trade-log-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .trade-log-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .trade-long {
            color: #4ade80;
            font-weight: 600;
        }

        .trade-short {
            color: #f87171;
            font-weight: 600;
        }

        .pnl-positive {
            color: #4ade80;
            font-weight: 600;
        }

        .pnl-negative {
            color: #f87171;
            font-weight: 600;
        }

        /* Pareto Evolution Styles */
        .pareto-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .objectives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .objective-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .objective-checkbox:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(75, 192, 192, 0.5);
        }

        .objective-checkbox input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .objective-checkbox input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #4ade80;
        }

        .objective-checkbox span {
            font-size: 0.95em;
        }

        /* Template Browser */
        .template-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: rgba(102, 126, 234, 0.5);
            border-color: rgba(102, 126, 234, 0.8);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .template-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .template-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .template-risk {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .risk-very_low { background: rgba(33, 150, 243, 0.3); }
        .risk-low { background: rgba(76, 175, 80, 0.3); }
        .risk-medium { background: rgba(255, 152, 0, 0.3); }
        .risk-high { background: rgba(255, 87, 34, 0.3); }
        .risk-very_high { background: rgba(244, 67, 54, 0.3); }

        .template-description {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .template-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .template-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .template-stat-value {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .template-stat-label {
            font-size: 0.75em;
            opacity: 0.8;
        }

        .template-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .template-tag {
            padding: 3px 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            font-size: 0.75em;
        }

        .template-deploy-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-deploy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .template-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .template-modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .specialist-preview {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .specialist-preview-header {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .personality-bars {
            display: grid;
            gap: 8px;
        }

        .personality-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .personality-label {
            width: 140px;
            font-size: 0.85em;
        }

        .personality-fill {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .personality-value {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Agent Ensemble Dashboard</h1>
            <p>Production Deployment & Management</p>
            <div class="connection-status" id="connectionStatus">
                ‚ö™ Connecting...
            </div>
        </header>

        <!-- Global Stats -->
        <div class="card full-width">
            <h2>üìä Global Statistics</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="totalEnsembles">0</div>
                    <div class="stat-label">Total Ensembles</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalSpecialists">0</div>
                    <div class="stat-label">Total Specialists</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalDecisions">0</div>
                    <div class="stat-label">Total Decisions</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="activeClients">1</div>
                    <div class="stat-label">Active Clients</div>
                </div>
            </div>
        </div>

        <!-- Template Browser -->
        <div class="card full-width">
            <h2>üìö Template Library</h2>
            <p style="opacity: 0.9; margin-bottom: 20px;">
                Deploy pre-configured ensembles optimized for different trading styles and markets
            </p>

            <!-- Filters -->
            <div class="template-filters">
                <button class="filter-btn active" onclick="filterTemplates('all')">All Templates</button>
                <button class="filter-btn" onclick="filterTemplates('low')">Low Risk</button>
                <button class="filter-btn" onclick="filterTemplates('medium')">Medium Risk</button>
                <button class="filter-btn" onclick="filterTemplates('high')">High Risk</button>
            </div>

            <!-- Template Grid -->
            <div class="template-grid" id="templateGrid">
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <p>Loading templates...</p>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Create Ensemble -->
            <div class="card">
                <h2>‚ûï Create Ensemble</h2>
                <form class="create-ensemble-form" onsubmit="createEnsemble(event)">
                    <div class="form-group">
                        <label for="ensembleName">Ensemble Name</label>
                        <input type="text" id="ensembleName" placeholder="My Trading Ensemble" required>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="useVoting">
                            <label for="useVoting">Enable Weighted Voting</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="votingThreshold">Voting Threshold</label>
                        <input type="range" id="votingThreshold" min="0" max="1" step="0.05" value="0.6">
                        <span id="thresholdValue">60%</span>
                    </div>

                    <button type="submit">Create Ensemble</button>
                </form>
            </div>

            <!-- Ensemble List -->
            <div class="card">
                <h2>üìã Active Ensembles</h2>
                <div class="ensemble-list" id="ensembleList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>No ensembles yet. Create one to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected Ensemble Details -->
        <div class="card full-width" id="ensembleDetails" style="display: none;">
            <h2>üéØ Ensemble: <span id="selectedEnsembleName">-</span></h2>

            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-box">
                    <div class="stat-value" id="ensembleSpecialists">0</div>
                    <div class="stat-label">Specialists</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="ensembleDecisions">0</div>
                    <div class="stat-label">Decisions Made</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="ensembleRouting">Direct</div>
                    <div class="stat-label">Routing Method</div>
                </div>
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 15px;">Specialists</h3>
            <div class="specialist-grid" id="specialistGrid">
                <div class="empty-state">
                    <p>No specialists added yet</p>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="addDemoSpecialists()">‚ûï Add Demo Specialists</button>
                <button onclick="testDecision()" style="margin-left: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    üé≤ Test Decision
                </button>
                <button onclick="deleteEnsemble()" style="margin-left: 10px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    üóëÔ∏è Delete Ensemble
                </button>
            </div>
        </div>

        <!-- Decision Feed -->
        <div class="card full-width">
            <h2>üìà Live Decision Feed</h2>
            <div class="decision-feed" id="decisionFeed">
                <div class="empty-state">
                    <div class="empty-state-icon">üí§</div>
                    <p>No decisions yet. Test a decision to see it here!</p>
                </div>
            </div>
        </div>

        <!-- Routing Visualization -->
        <div class="card full-width">
            <h2>üéØ Routing Distribution</h2>
            <div class="chart-container">
                <canvas id="routingChart"></canvas>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="card full-width" id="analyticsSection" style="display: none;">
            <h2>üìä Advanced Analytics</h2>

            <div class="analytics-grid">
                <!-- Performance Comparison -->
                <div class="analytics-card">
                    <h3>üìà Performance Over Time</h3>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Regime Distribution -->
                <div class="analytics-card">
                    <h3>üå§Ô∏è Market Regime Distribution</h3>
                    <div class="chart-container">
                        <canvas id="regimeChart"></canvas>
                    </div>
                </div>

                <!-- Confidence Trends -->
                <div class="analytics-card">
                    <h3>üéØ Decision Confidence Trends</h3>
                    <div class="chart-container">
                        <canvas id="confidenceChart"></canvas>
                    </div>
                </div>

                <!-- Specialist Effectiveness -->
                <div class="analytics-card">
                    <h3>‚≠ê Specialist Effectiveness</h3>
                    <div class="chart-container">
                        <canvas id="effectivenessChart"></canvas>
                    </div>
                </div>
            </div>

            <button onclick="refreshAnalytics()" style="margin-top: 20px;">
                üîÑ Refresh Analytics
            </button>
        </div>

        <!-- Backtesting Section -->
        <div class="card full-width" id="backtestSection" style="display: none;">
            <h2>üß™ Strategy Backtesting</h2>

            <div class="main-grid">
                <!-- Backtest Configuration -->
                <div class="card">
                    <h3>‚öôÔ∏è Configure Backtest</h3>
                    <form class="backtest-form" onsubmit="runBacktest(event)">
                        <div class="form-group">
                            <label for="backtestSymbol">Symbol</label>
                            <input type="text" id="backtestSymbol" value="BTC/USD" required>
                        </div>

                        <div class="form-group">
                            <label for="backtestStartDate">Start Date</label>
                            <input type="datetime-local" id="backtestStartDate" required>
                        </div>

                        <div class="form-group">
                            <label for="backtestEndDate">End Date</label>
                            <input type="datetime-local" id="backtestEndDate" required>
                        </div>

                        <div class="form-group">
                            <label for="backtestCapital">Initial Capital ($)</label>
                            <input type="number" id="backtestCapital" value="10000" min="1000" step="1000" required>
                        </div>

                        <div class="form-group">
                            <label for="backtestCommission">Commission Rate (%)</label>
                            <input type="number" id="backtestCommission" value="0.1" min="0" max="5" step="0.01" required>
                        </div>

                        <div class="form-group">
                            <label for="backtestPositionSize">Position Size (%)</label>
                            <input type="number" id="backtestPositionSize" value="95" min="10" max="100" step="5" required>
                        </div>

                        <button type="submit" id="runBacktestBtn">
                            üöÄ Run Backtest
                        </button>
                    </form>
                </div>

                <!-- Backtest Results Summary -->
                <div class="card">
                    <h3>üìä Results Summary</h3>
                    <div id="backtestSummary" class="empty-state">
                        <div class="empty-state-icon">‚è≥</div>
                        <p>Run a backtest to see results</p>
                    </div>
                </div>
            </div>

            <!-- Equity Curve -->
            <div id="backtestEquityCurve" style="display: none; margin-top: 20px;">
                <h3>üí∞ Equity Curve</h3>
                <div class="chart-container">
                    <canvas id="equityCurveChart"></canvas>
                </div>
            </div>

            <!-- Trade Log -->
            <div id="backtestTradeLog" style="display: none; margin-top: 20px;">
                <h3>üìù Trade Log</h3>
                <div class="trade-log-container">
                    <table class="trade-log-table" id="tradeLogTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Direction</th>
                                <th>Entry Time</th>
                                <th>Exit Time</th>
                                <th>Entry Price</th>
                                <th>Exit Price</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                            </tr>
                        </thead>
                        <tbody id="tradeLogBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pareto Evolution Section -->
        <div class="card full-width" id="paretoSection" style="display: none;">
            <h2>üß¨ Multi-Objective Pareto Evolution</h2>
            <p style="margin-bottom: 20px; opacity: 0.9;">
                Discover optimal trade-offs between competing objectives using NSGA-II algorithm.
                Find the Pareto frontier - agents balancing return, risk, consistency, and more!
            </p>

            <div class="main-grid">
                <!-- Configuration -->
                <div class="card">
                    <h3>‚öôÔ∏è Configure Evolution</h3>
                    <form class="pareto-form" onsubmit="runParetoEvolution(event)">
                        <div class="form-group">
                            <label>Objectives (select 2-3)</label>
                            <div class="objectives-grid">
                                <label class="objective-checkbox">
                                    <input type="checkbox" name="objective" value="return" checked>
                                    <span>üìà Return (maximize)</span>
                                </label>
                                <label class="objective-checkbox">
                                    <input type="checkbox" name="objective" value="sharpe_ratio">
                                    <span>‚öñÔ∏è Sharpe Ratio (maximize)</span>
                                </label>
                                <label class="objective-checkbox">
                                    <input type="checkbox" name="objective" value="max_drawdown" checked>
                                    <span>üìâ Max Drawdown (minimize)</span>
                                </label>
                                <label class="objective-checkbox">
                                    <input type="checkbox" name="objective" value="win_rate">
                                    <span>üéØ Win Rate (maximize)</span>
                                </label>
                                <label class="objective-checkbox">
                                    <input type="checkbox" name="objective" value="profit_factor">
                                    <span>üí∞ Profit Factor (maximize)</span>
                                </label>
                                <label class="objective-checkbox">
                                    <input type="checkbox" name="objective" value="total_trades">
                                    <span>üîÑ Trade Frequency</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="paretoPopulation">Population Size</label>
                            <input type="number" id="paretoPopulation" value="20" min="10" max="100" step="10" required>
                        </div>

                        <div class="form-group">
                            <label for="paretoGenerations">Generations</label>
                            <input type="number" id="paretoGenerations" value="10" min="5" max="50" step="5" required>
                        </div>

                        <button type="submit" id="runParetoBtn">
                            üß¨ Run Evolution
                        </button>
                    </form>
                </div>

                <!-- Status -->
                <div class="card">
                    <h3>üìä Evolution Status</h3>
                    <div id="paretoStatus" class="empty-state">
                        <div class="empty-state-icon">‚è≥</div>
                        <p>Configure and run evolution to see results</p>
                    </div>
                </div>
            </div>

            <!-- Pareto Frontier Visualization -->
            <div id="paretoFrontierViz" style="display: none; margin-top: 20px;">
                <h3>üéØ Pareto Frontier</h3>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="paretoFrontierChart"></canvas>
                </div>
            </div>

            <!-- Agent Comparison Table -->
            <div id="paretoAgentTable" style="display: none; margin-top: 20px;">
                <h3>‚≠ê Frontier Agents</h3>
                <div class="trade-log-container">
                    <table class="trade-log-table" id="paretoAgentsTable">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Gen</th>
                                <th>Rank</th>
                                <th>Objectives</th>
                                <th>Crowding Dist.</th>
                            </tr>
                        </thead>
                        <tbody id="paretoAgentsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let ws = null;
        let selectedEnsembleId = null;
        let ensembles = {};
        let decisionCount = 0;
        let routingData = {};

        // Chart
        let routingChart = null;

        // Initialize
        function init() {
            connectWebSocket();
            loadEnsembles();
            initCharts();

            // Update threshold display
            document.getElementById('votingThreshold').addEventListener('input', (e) => {
                document.getElementById('thresholdValue').textContent =
                    Math.round(e.target.value * 100) + '%';
            });
        }

        // WebSocket Connection
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/api/ensemble/stream`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                updateConnectionStatus(true);
                console.log('WebSocket connected');
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
                console.log('WebSocket disconnected');
                setTimeout(connectWebSocket, 3000); // Reconnect
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'üü¢ Connected';
                status.className = 'connection-status connected';
            } else {
                status.textContent = 'üî¥ Disconnected';
                status.className = 'connection-status disconnected';
            }
        }

        function handleMessage(message) {
            console.log('Received message:', message);

            switch(message.type) {
                case 'connection_established':
                    loadEnsembles();
                    break;
                case 'ensemble_created':
                    loadEnsembles();
                    break;
                case 'specialist_added':
                    if (selectedEnsembleId === message.ensemble_id) {
                        loadEnsembleDetails(selectedEnsembleId);
                    }
                    break;
                case 'decision_made':
                    addDecisionToFeed(message);
                    updateRoutingChart(message.specialist_used);
                    decisionCount++;
                    // Refresh analytics after every 5 decisions
                    if (selectedEnsembleId && decisionCount % 5 === 0) {
                        loadAnalytics();
                    }
                    break;
                case 'ensemble_deleted':
                    if (selectedEnsembleId === message.ensemble_id) {
                        selectedEnsembleId = null;
                        document.getElementById('ensembleDetails').style.display = 'none';
                    }
                    loadEnsembles();
                    break;
            }
        }

        // Load ensembles
        async function loadEnsembles() {
            try {
                const response = await fetch('/api/ensemble');
                const data = await response.json();

                ensembles = {};
                data.forEach(e => {
                    ensembles[e.ensemble_id] = e;
                });

                renderEnsembleList(data);
                updateGlobalStats(data);
            } catch (error) {
                console.error('Failed to load ensembles:', error);
            }
        }

        function renderEnsembleList(data) {
            const list = document.getElementById('ensembleList');

            if (data.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>No ensembles yet. Create one to get started!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = data.map(ensemble => `
                <div class="ensemble-item ${selectedEnsembleId === ensemble.ensemble_id ? 'selected' : ''}"
                     onclick="selectEnsemble('${ensemble.ensemble_id}')">
                    <h3>${ensemble.name}</h3>
                    <div class="meta">
                        ${ensemble.ensemble_stats.total_specialists} specialists |
                        ${ensemble.total_decisions} decisions
                    </div>
                </div>
            `).join('');
        }

        function updateGlobalStats(data) {
            document.getElementById('totalEnsembles').textContent = data.length;

            const totalSpecialists = data.reduce((sum, e) =>
                sum + (e.ensemble_stats.total_specialists || 0), 0);
            document.getElementById('totalSpecialists').textContent = totalSpecialists;

            const totalDecisions = data.reduce((sum, e) =>
                sum + (e.total_decisions || 0), 0);
            document.getElementById('totalDecisions').textContent = totalDecisions;
        }

        // Create ensemble
        async function createEnsemble(event) {
            event.preventDefault();

            const name = document.getElementById('ensembleName').value;
            const useVoting = document.getElementById('useVoting').checked;
            const votingThreshold = parseFloat(document.getElementById('votingThreshold').value);

            try {
                const response = await fetch('/api/ensemble/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        use_voting: useVoting,
                        voting_threshold: votingThreshold
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('ensembleName').value = '';
                    await loadEnsembles();
                    selectEnsemble(result.ensemble_id);
                }
            } catch (error) {
                console.error('Failed to create ensemble:', error);
                alert('Failed to create ensemble');
            }
        }

        // Select ensemble
        async function selectEnsemble(ensembleId) {
            selectedEnsembleId = ensembleId;
            await loadEnsembleDetails(ensembleId);
            renderEnsembleList(Object.values(ensembles));
        }

        async function loadEnsembleDetails(ensembleId) {
            try {
                const response = await fetch(`/api/ensemble/${ensembleId}`);
                const data = await response.json();

                document.getElementById('selectedEnsembleName').textContent = data.name;
                document.getElementById('ensembleSpecialists').textContent =
                    data.ensemble_stats.total_specialists || 0;
                document.getElementById('ensembleDecisions').textContent =
                    data.total_decisions || 0;
                document.getElementById('ensembleRouting').textContent =
                    data.ensemble_stats.routing_method || 'direct';

                renderSpecialists(data.ensemble_stats.specialists || {});

                document.getElementById('ensembleDetails').style.display = 'block';

                // Load analytics for this ensemble
                await loadAnalytics();

                // Show backtest section
                showBacktestSection();

                // Show Pareto evolution section
                showParetoSection();
            } catch (error) {
                console.error('Failed to load ensemble details:', error);
            }
        }

        function renderSpecialists(specialists) {
            const grid = document.getElementById('specialistGrid');

            const specialistList = Object.values(specialists);

            if (specialistList.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <p>No specialists added yet</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = specialistList.map(spec => {
                const type = spec.specialist_type.replace('_', ' ');
                const badgeClass = `badge-${spec.specialist_type.split('_')[0]}`;

                return `
                    <div class="specialist-card">
                        <div class="specialist-type">${type}</div>
                        <div class="specialist-badge ${badgeClass}">
                            Gen ${spec.generation}
                        </div>
                        <div class="specialist-badge">
                            Fitness: ${spec.fitness.toFixed(3)}
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                            ${spec.genome_id}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add demo specialists
        async function addDemoSpecialists() {
            if (!selectedEnsembleId) return;

            const specialists = [
                {
                    type: 'bull_specialist',
                    personality: { openness: 0.7, conscientiousness: 0.6, extraversion: 0.8, agreeableness: 0.6, neuroticism: 0.3 },
                    fitness: 0.72
                },
                {
                    type: 'bear_specialist',
                    personality: { openness: 0.4, conscientiousness: 0.9, extraversion: 0.4, agreeableness: 0.5, neuroticism: 0.4 },
                    fitness: 0.68
                },
                {
                    type: 'volatile_specialist',
                    personality: { openness: 0.8, conscientiousness: 0.5, extraversion: 0.6, agreeableness: 0.7, neuroticism: 0.5 },
                    fitness: 0.65
                }
            ];

            for (const spec of specialists) {
                try {
                    await fetch(`/api/ensemble/${selectedEnsembleId}/specialists`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            genome_data: {
                                agent_id: `demo_${spec.type}_${Date.now()}`,
                                generation: 5,
                                personality: spec.personality,
                                fitness_score: spec.fitness,
                                parents: [],
                                mutations: []
                            },
                            specialist_type: spec.type
                        })
                    });
                } catch (error) {
                    console.error('Failed to add specialist:', error);
                }
            }

            setTimeout(() => loadEnsembleDetails(selectedEnsembleId), 500);
        }

        // Test decision
        async function testDecision() {
            if (!selectedEnsembleId) return;

            // Generate random price history
            const prices = [];
            let price = 100;
            for (let i = 0; i < 30; i++) {
                price += (Math.random() - 0.5) * 2;
                prices.push(price);
            }

            try {
                await fetch(`/api/ensemble/${selectedEnsembleId}/decision`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_price: price,
                        price_history: prices
                    })
                });
            } catch (error) {
                console.error('Failed to get decision:', error);
            }
        }

        // Delete ensemble
        async function deleteEnsemble() {
            if (!selectedEnsembleId) return;

            if (!confirm('Are you sure you want to delete this ensemble?')) return;

            try {
                await fetch(`/api/ensemble/${selectedEnsembleId}`, {
                    method: 'DELETE'
                });
                selectedEnsembleId = null;
                document.getElementById('ensembleDetails').style.display = 'none';
                await loadEnsembles();
            } catch (error) {
                console.error('Failed to delete ensemble:', error);
            }
        }

        // Decision feed
        function addDecisionToFeed(message) {
            const feed = document.getElementById('decisionFeed');

            // Remove empty state if present
            if (feed.querySelector('.empty-state')) {
                feed.innerHTML = '';
            }

            const decision = document.createElement('div');
            decision.className = `decision-item ${message.decision}`;
            decision.innerHTML = `
                <div class="decision-header">
                    <span class="decision-action">${message.decision}</span>
                    <span class="decision-time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="decision-details">
                    Regime: ${message.regime} |
                    Specialist: ${message.specialist_used || 'none'} |
                    Confidence: ${(message.confidence * 100).toFixed(0)}%
                </div>
            `;

            feed.insertBefore(decision, feed.firstChild);

            // Keep only last 20 decisions
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Charts
        function initCharts() {
            const ctx = document.getElementById('routingChart').getContext('2d');

            routingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Decisions Routed',
                        data: [],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.6)',
                            'rgba(244, 67, 54, 0.6)',
                            'rgba(255, 152, 0, 0.6)',
                            'rgba(33, 150, 243, 0.6)',
                            'rgba(156, 39, 176, 0.6)'
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(244, 67, 54, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(33, 150, 243, 1)',
                            'rgba(156, 39, 176, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateRoutingChart(specialist) {
            if (!specialist) specialist = 'none';

            routingData[specialist] = (routingData[specialist] || 0) + 1;

            routingChart.data.labels = Object.keys(routingData);
            routingChart.data.datasets[0].data = Object.values(routingData);
            routingChart.update();
        }

        // ====================================================================
        // Template System
        // ====================================================================

        let allTemplates = [];
        let currentFilter = 'all';

        // Load templates
        async function loadTemplates() {
            try {
                const response = await fetch('/api/ensemble/templates');
                allTemplates = await response.json();
                renderTemplates();
            } catch (error) {
                console.error('Failed to load templates:', error);
            }
        }

        // Filter templates
        function filterTemplates(filter) {
            currentFilter = filter;

            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderTemplates();
        }

        // Render templates
        function renderTemplates() {
            const grid = document.getElementById('templateGrid');

            let filteredTemplates = allTemplates;

            if (currentFilter !== 'all') {
                filteredTemplates = allTemplates.filter(t => {
                    const risk = t.risk_level;
                    if (currentFilter === 'low') return risk === 'very_low' || risk === 'low';
                    if (currentFilter === 'medium') return risk === 'medium';
                    if (currentFilter === 'high') return risk === 'high' || risk === 'very_high';
                    return true;
                });
            }

            if (filteredTemplates.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No templates match your filter</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredTemplates.map(template => `
                <div class="template-card">
                    <div class="template-header">
                        <div>
                            <div class="template-title">${template.name}</div>
                        </div>
                        <div class="template-risk risk-${template.risk_level}">
                            ${template.risk_level.replace('_', ' ').toUpperCase()}
                        </div>
                    </div>

                    <div class="template-description">
                        ${template.description.substring(0, 120)}...
                    </div>

                    <div class="template-stats">
                        <div class="template-stat">
                            <div class="template-stat-value">${template.specialist_count}</div>
                            <div class="template-stat-label">Specialists</div>
                        </div>
                        <div class="template-stat">
                            <div class="template-stat-value">${(template.performance_expectations.annual_return * 100).toFixed(0)}%</div>
                            <div class="template-stat-label">Expected Return</div>
                        </div>
                        <div class="template-stat">
                            <div class="template-stat-value">${(template.performance_expectations.max_drawdown * 100).toFixed(0)}%</div>
                            <div class="template-stat-label">Max Drawdown</div>
                        </div>
                        <div class="template-stat">
                            <div class="template-stat-value">${template.performance_expectations.sharpe_ratio.toFixed(1)}</div>
                            <div class="template-stat-label">Sharpe Ratio</div>
                        </div>
                    </div>

                    <div class="template-tags">
                        ${template.metadata.tags.slice(0, 3).map(tag =>
                            `<span class="template-tag">${tag}</span>`
                        ).join('')}
                    </div>

                    <button class="template-deploy-btn" onclick="deployTemplate('${template.template_id}', '${template.name}')">
                        üöÄ Deploy Now
                    </button>
                </div>
            `).join('');
        }

        // Deploy template
        async function deployTemplate(templateId, templateName) {
            if (!confirm(`Deploy "${templateName}" template as a new ensemble?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/ensemble/templates/${templateId}/deploy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ ${result.message}\n\nEnsemble ID: ${result.ensemble_id}\nSpecialists: ${result.specialists_added}`);

                    // Reload ensembles
                    await loadEnsembles();

                    // Select the new ensemble
                    selectEnsemble(result.ensemble_id);
                } else {
                    alert('‚ùå Failed to deploy template');
                }
            } catch (error) {
                console.error('Failed to deploy template:', error);
                alert('‚ùå Failed to deploy template: ' + error.message);
            }
        }

        // ================================================================
        // ANALYTICS DASHBOARD
        // ================================================================

        // Global analytics charts
        let analyticsCharts = {
            performance: null,
            regime: null,
            confidence: null,
            effectiveness: null
        };

        async function loadAnalytics() {
            if (!selectedEnsembleId) {
                console.log('No ensemble selected');
                return;
            }

            try {
                const response = await fetch(`/api/ensemble/${selectedEnsembleId}/analytics`);
                const analytics = await response.json();

                // Show analytics section
                document.getElementById('analyticsSection').style.display = 'block';

                // Render all charts
                renderPerformanceChart(analytics);
                renderRegimeChart(analytics);
                renderConfidenceChart(analytics);
                renderEffectivenessChart(analytics);

            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function renderPerformanceChart(analytics) {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            // Destroy existing chart
            if (analyticsCharts.performance) {
                analyticsCharts.performance.destroy();
            }

            // Prepare data - show win rate over time for each specialist
            const performanceHistory = analytics.performance_history || [];

            if (performanceHistory.length === 0) {
                return;
            }

            // Extract specialist names
            const specialists = Object.keys(performanceHistory[0]?.specialists || {});

            const datasets = specialists.map((specialist, idx) => {
                const colors = [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 206, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)'
                ];

                return {
                    label: specialist,
                    data: performanceHistory.map(snapshot => ({
                        x: snapshot.total_decisions,
                        y: (snapshot.specialists[specialist]?.win_rate || 0) * 100
                    })),
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    tension: 0.3,
                    fill: true
                };
            });

            analyticsCharts.performance = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Total Decisions',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Win Rate (%)',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: 'Specialist Win Rates Over Time',
                            color: '#fff'
                        }
                    }
                }
            });
        }

        function renderRegimeChart(analytics) {
            const ctx = document.getElementById('regimeChart').getContext('2d');

            if (analyticsCharts.regime) {
                analyticsCharts.regime.destroy();
            }

            const regimeDistribution = analytics.routing_analytics?.regime_distribution || {};

            analyticsCharts.regime = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(regimeDistribution),
                    datasets: [{
                        data: Object.values(regimeDistribution),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',   // bull - green
                            'rgba(255, 99, 132, 0.8)',   // bear - red
                            'rgba(255, 206, 86, 0.8)',   // volatile - yellow
                            'rgba(153, 102, 255, 0.8)'   // sideways - purple
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: 'Market Regime Distribution',
                            color: '#fff'
                        }
                    }
                }
            });
        }

        function renderConfidenceChart(analytics) {
            const ctx = document.getElementById('confidenceChart').getContext('2d');

            if (analyticsCharts.confidence) {
                analyticsCharts.confidence.destroy();
            }

            const confidenceData = analytics.routing_analytics?.confidence_over_time || [];

            analyticsCharts.confidence = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: confidenceData.map((_, idx) => idx),
                    datasets: [{
                        label: 'Confidence',
                        data: confidenceData.map(item => item.confidence * 100),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Decision Number',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Confidence (%)',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: 'Decision Confidence Trend',
                            color: '#fff'
                        }
                    }
                }
            });
        }

        function renderEffectivenessChart(analytics) {
            const ctx = document.getElementById('effectivenessChart').getContext('2d');

            if (analyticsCharts.effectiveness) {
                analyticsCharts.effectiveness.destroy();
            }

            const specialistPerf = analytics.specialist_performance || {};
            const specialists = Object.keys(specialistPerf);

            analyticsCharts.effectiveness = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: specialists,
                    datasets: [
                        {
                            label: 'Win Rate',
                            data: specialists.map(s => specialistPerf[s]?.win_rate * 100 || 0),
                            backgroundColor: 'rgba(75, 192, 192, 0.8)'
                        },
                        {
                            label: 'Performance Score',
                            data: specialists.map(s => specialistPerf[s]?.performance_score * 100 || 0),
                            backgroundColor: 'rgba(54, 162, 235, 0.8)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Score (%)',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: 'Specialist Effectiveness Comparison',
                            color: '#fff'
                        }
                    }
                }
            });
        }

        async function refreshAnalytics() {
            await loadAnalytics();
        }

        // ================================================================
        // END ANALYTICS DASHBOARD
        // ================================================================

        // ================================================================
        // BACKTEST FUNCTIONS
        // ================================================================

        // Global backtest state
        let currentBacktestId = null;
        let equityCurveChart = null;

        async function runBacktest(event) {
            event.preventDefault();

            if (!selectedEnsembleId) {
                alert('Please select an ensemble first');
                return;
            }

            const button = document.getElementById('runBacktestBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Running Backtest...';

            try {
                const startDate = new Date(document.getElementById('backtestStartDate').value).toISOString();
                const endDate = new Date(document.getElementById('backtestEndDate').value).toISOString();
                const capital = parseFloat(document.getElementById('backtestCapital').value);
                const commission = parseFloat(document.getElementById('backtestCommission').value) / 100;
                const positionSize = parseFloat(document.getElementById('backtestPositionSize').value) / 100;

                const response = await fetch('/api/backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ensemble_id: selectedEnsembleId,
                        symbol: document.getElementById('backtestSymbol').value,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: capital,
                        commission_rate: commission,
                        slippage_rate: 0.0005,
                        position_size: positionSize
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentBacktestId = result.backtest_id;
                    await loadBacktestResults(result.backtest_id);
                } else {
                    alert('‚ùå Backtest failed');
                }

            } catch (error) {
                console.error('Backtest error:', error);
                alert('‚ùå Backtest failed: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Run Backtest';
            }
        }

        async function loadBacktestResults(backtestId) {
            try {
                const response = await fetch(`/api/backtest/${backtestId}`);
                const result = await response.json();

                // Display summary
                displayBacktestSummary(result.metrics, result.config);

                // Display equity curve
                displayEquityCurve(result.equity_curve);

                // Display trade log
                displayTradeLog(result.trades);

            } catch (error) {
                console.error('Failed to load backtest results:', error);
            }
        }

        function displayBacktestSummary(metrics, config) {
            const summary = document.getElementById('backtestSummary');

            const returnClass = metrics.total_return_percent >= 0 ? 'pnl-positive' : 'pnl-negative';

            summary.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value ${returnClass}">${metrics.total_return_percent.toFixed(2)}%</div>
                        <div class="stat-label">Total Return</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${metrics.win_rate.toFixed(2)}</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${metrics.total_trades}</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${metrics.sharpe_ratio.toFixed(2)}</div>
                        <div class="stat-label">Sharpe Ratio</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${metrics.max_drawdown_percent.toFixed(2)}%</div>
                        <div class="stat-label">Max Drawdown</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${metrics.profit_factor.toFixed(2)}</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">$${metrics.final_equity.toFixed(2)}</div>
                        <div class="stat-label">Final Equity</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${metrics.avg_trade_duration.toFixed(1)}h</div>
                        <div class="stat-label">Avg Trade Duration</div>
                    </div>
                </div>
            `;
        }

        function displayEquityCurve(equityCurve) {
            const container = document.getElementById('backtestEquityCurve');
            container.style.display = 'block';

            const ctx = document.getElementById('equityCurveChart').getContext('2d');

            if (equityCurveChart) {
                equityCurveChart.destroy();
            }

            equityCurveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: equityCurve.map((_, idx) => idx),
                    datasets: [{
                        label: 'Equity',
                        data: equityCurve.map(e => e.equity),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Equity ($)',
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: 'Equity Curve Over Time',
                            color: '#fff'
                        }
                    }
                }
            });
        }

        function displayTradeLog(trades) {
            const container = document.getElementById('backtestTradeLog');
            const tbody = document.getElementById('tradeLogBody');

            container.style.display = 'block';

            tbody.innerHTML = trades.map(trade => {
                const directionClass = trade.direction === 'long' ? 'trade-long' : 'trade-short';
                const pnlClass = trade.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const pnlSign = trade.pnl >= 0 ? '+' : '';

                return `
                    <tr>
                        <td>${trade.trade_id}</td>
                        <td class="${directionClass}">${trade.direction.toUpperCase()}</td>
                        <td>${new Date(trade.entry_time).toLocaleString()}</td>
                        <td>${trade.exit_time ? new Date(trade.exit_time).toLocaleString() : '-'}</td>
                        <td>$${trade.entry_price.toFixed(2)}</td>
                        <td>${trade.exit_price ? '$' + trade.exit_price.toFixed(2) : '-'}</td>
                        <td class="${pnlClass}">${pnlSign}$${trade.pnl.toFixed(2)}</td>
                        <td class="${pnlClass}">${pnlSign}${trade.pnl_percent.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');
        }

        // Show backtest section when ensemble is selected
        function showBacktestSection() {
            if (selectedEnsembleId) {
                document.getElementById('backtestSection').style.display = 'block';

                // Set default dates (last 7 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);

                document.getElementById('backtestStartDate').value = startDate.toISOString().slice(0, 16);
                document.getElementById('backtestEndDate').value = endDate.toISOString().slice(0, 16);
            }
        }

        // ================================================================
        // END BACKTEST FUNCTIONS
        // ================================================================

        // ================================================================
        // PARETO EVOLUTION FUNCTIONS
        // ================================================================

        // Global Pareto state
        let currentEvolutionId = null;
        let paretoFrontierChart = null;

        async function runParetoEvolution(event) {
            event.preventDefault();

            if (!selectedEnsembleId) {
                alert('Please select an ensemble first');
                return;
            }

            // Get selected objectives
            const checkboxes = document.querySelectorAll('input[name="objective"]:checked');
            const objectives = [];

            checkboxes.forEach(cb => {
                const type = cb.value;
                const minimize = type === 'max_drawdown'; // Only drawdown should be minimized

                objectives.push({
                    type: type,
                    minimize: minimize,
                    weight: 1.0
                });
            });

            if (objectives.length < 2) {
                alert('Please select at least 2 objectives');
                return;
            }

            if (objectives.length > 4) {
                alert('Please select at most 4 objectives for visualization');
                return;
            }

            const button = document.getElementById('runParetoBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Evolving...';

            // Update status
            const status = document.getElementById('paretoStatus');
            status.innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">‚è≥</div>
                    <div class="stat-label">Running NSGA-II Evolution...</div>
                </div>
            `;

            try {
                const population = parseInt(document.getElementById('paretoPopulation').value);
                const generations = parseInt(document.getElementById('paretoGenerations').value);

                // Use backtest configuration from backtest section
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);
                const endDate = new Date();

                const response = await fetch('/api/pareto/evolve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ensemble_id: selectedEnsembleId,
                        population_size: population,
                        num_generations: generations,
                        objectives: objectives,
                        backtest_config: {
                            symbol: 'BTC/USD',
                            start_date: startDate.toISOString(),
                            end_date: endDate.toISOString(),
                            initial_capital: 10000.0,
                            commission_rate: 0.001,
                            slippage_rate: 0.0005,
                            position_size: 0.95
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentEvolutionId = result.evolution_id;

                    // Update status
                    status.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value pnl-positive">${result.pareto_frontier_size}</div>
                                <div class="stat-label">Pareto Frontier</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${result.total_fronts}</div>
                                <div class="stat-label">Total Fronts</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${result.generations_completed}</div>
                                <div class="stat-label">Generations</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${result.objectives.length}</div>
                                <div class="stat-label">Objectives</div>
                            </div>
                        </div>
                    `;

                    // Load and display results
                    await loadParetoResults(result.evolution_id);
                } else {
                    alert('‚ùå Evolution failed');
                }

            } catch (error) {
                console.error('Pareto evolution error:', error);
                alert('‚ùå Evolution failed: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'üß¨ Run Evolution';
            }
        }

        async function loadParetoResults(evolutionId) {
            try {
                const response = await fetch(`/api/pareto/${evolutionId}`);
                const result = await response.json();

                // Display Pareto frontier chart
                renderParetoFrontier(result);

                // Display agent comparison table
                displayParetoAgents(result);

            } catch (error) {
                console.error('Failed to load Pareto results:', error);
            }
        }

        function renderParetoFrontier(result) {
            const container = document.getElementById('paretoFrontierViz');
            container.style.display = 'block';

            const ctx = document.getElementById('paretoFrontierChart').getContext('2d');

            if (paretoFrontierChart) {
                paretoFrontierChart.destroy();
            }

            // Get the first two objectives for X and Y axes
            const objectives = Object.keys(result.pareto_frontier[0].objectives);
            const xObjective = objectives[0];
            const yObjective = objectives[1];

            // Prepare data
            const frontierData = result.pareto_frontier.map(agent => ({
                x: agent.objectives[xObjective],
                y: agent.objectives[yObjective],
                agent_id: agent.agent_id
            }));

            paretoFrontierChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Pareto Frontier',
                        data: frontierData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgb(75, 192, 192)',
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xObjective.replace('_', ' ').toUpperCase(),
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yObjective.replace('_', ' ').toUpperCase(),
                                color: '#fff'
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        title: {
                            display: true,
                            text: `Pareto Frontier: ${xObjective} vs ${yObjective}`,
                            color: '#fff',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `${xObjective}: ${point.x.toFixed(2)}`,
                                        `${yObjective}: ${point.y.toFixed(2)}`,
                                        `Agent: ${point.agent_id.substring(0, 8)}...`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayParetoAgents(result) {
            const container = document.getElementById('paretoAgentTable');
            const tbody = document.getElementById('paretoAgentsBody');

            container.style.display = 'block';

            tbody.innerHTML = result.pareto_frontier.map(agent => {
                // Format objectives
                const objectivesStr = Object.entries(agent.objectives)
                    .map(([key, val]) => `${key}: ${val.toFixed(2)}`)
                    .join(', ');

                return `
                    <tr>
                        <td>${agent.agent_id.substring(0, 12)}...</td>
                        <td>${agent.generation}</td>
                        <td class="pnl-positive">${agent.dominance_rank}</td>
                        <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">
                            ${objectivesStr}
                        </td>
                        <td>${agent.crowding_distance.toFixed(3)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Show Pareto section when ensemble is selected
        function showParetoSection() {
            if (selectedEnsembleId) {
                document.getElementById('paretoSection').style.display = 'block';
            }
        }

        // ================================================================
        // END PARETO EVOLUTION FUNCTIONS
        // ================================================================

        // Initialize on load
        window.addEventListener('load', () => {
            init();
            loadTemplates();
        });
    </script>
</body>
</html>
