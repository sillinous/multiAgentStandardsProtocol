<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS Strategy Research Lab</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #667eea;
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .strategy-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .strategy-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .strategy-item:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .strategy-item.selected {
            background: #e7f0ff;
            border-color: #667eea;
        }

        .strategy-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .strategy-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .metric {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .metric-good {
            color: #28a745;
        }

        .metric-bad {
            color: #dc3545;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-running {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .results-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .result-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .result-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .ws-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .ws-connected {
            background: #d4edda;
            color: #155724;
        }

        .ws-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .ws-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .ws-dot.connected {
            background: #28a745;
        }

        .ws-dot.disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .price-ticker {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .price-item {
            display: inline-block;
            margin-right: 20px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .price-symbol {
            font-weight: 600;
            color: #333;
            margin-right: 8px;
        }

        .price-value {
            font-size: 18px;
            font-weight: 700;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ NEXUS Strategy Research Lab</h1>
            <p class="subtitle">AI-Powered Trading Strategy Development & Validation</p>
            <div style="margin-top: 10px; display: flex; gap: 15px; align-items: center;">
                <span class="ws-indicator" id="wsIndicator">
                    <span class="ws-dot disconnected"></span>
                    <span>Connecting...</span>
                </span>
                <div class="price-ticker" id="priceTicker" style="margin: 0; padding: 8px 15px;">
                    <span style="color: #666; font-size: 12px;">Real-time prices loading...</span>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Left Column: Strategy Generation & Library -->
            <div>
                <div class="card">
                    <h2>ü§ñ AI Strategy Generator</h2>

                    <div class="form-group">
                        <label for="tokenAddress">Token Symbol</label>
                        <input type="text" id="tokenAddress" placeholder="e.g., SOL/USD, BTC/USD, ETH/USD" value="SOL/USD">
                    </div>

                    <div class="form-group">
                        <label for="analysisType">Analysis Type</label>
                        <select id="analysisType">
                            <option value="comprehensive">Comprehensive Analysis</option>
                            <option value="technical">Technical Analysis Only</option>
                            <option value="fundamental">Fundamental Analysis Only</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="useSwarm" style="width: auto; margin-right: 8px;">
                            Use Swarm Intelligence (6 AI models consensus)
                        </label>
                    </div>

                    <div class="button-group">
                        <button onclick="generateStrategy()" id="generateBtn">
                            ‚ú® Generate Strategy
                        </button>
                        <button onclick="loadStrategies()" id="refreshBtn">
                            üîÑ Refresh Library
                        </button>
                    </div>

                    <div id="generationResult" class="hidden"></div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>üìö Strategy Library</h2>
                    <div class="strategy-list" id="strategyList">
                        <p style="color: #666; text-align: center; padding: 20px;">Loading strategies...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Strategy Details & Actions -->
            <div>
                <div class="card">
                    <h2>üìä Strategy Details</h2>
                    <div id="strategyDetails">
                        <p style="color: #666; text-align: center; padding: 40px;">
                            Select a strategy from the library to view details
                        </p>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>‚ö° Quick Actions</h2>

                    <div class="button-group">
                        <button onclick="runBacktest()" id="backtestBtn" disabled>
                            üìà Run Backtest
                        </button>
                        <button onclick="startPaperTrading()" id="paperTradeBtn" disabled>
                            üìù Paper Trade
                        </button>
                        <button onclick="calculateRisk()" id="riskBtn" disabled>
                            ‚ö†Ô∏è Risk Analysis
                        </button>
                    </div>

                    <div id="actionResults" class="results-panel hidden">
                        <h3 style="margin-bottom: 15px;">Results</h3>
                        <div id="actionResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Panel: Backtesting Results -->
        <div class="card">
            <h2>üìâ Backtest Results</h2>
            <div id="backtestResults">
                <p style="color: #666; text-align: center; padding: 20px;">
                    Run a backtest to see performance metrics
                </p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let selectedStrategy = null;
        let ws = null;
        let priceData = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStrategies();
            connectWebSocket();
        });

        // WebSocket Connection
        function connectWebSocket() {
            const wsUrl = API_BASE.replace('http', 'ws') + '/ws/market-data';
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                updateWSIndicator(true);
                // Subscribe to common crypto pairs
                ws.send(JSON.stringify({
                    action: 'subscribe_prices',
                    symbols: ['BTC/USD', 'ETH/USD', 'SOL/USD']
                }));
                ws.send(JSON.stringify({
                    action: 'subscribe_events'
                }));
            };

            ws.onclose = () => {
                updateWSIndicator(false);
                setTimeout(connectWebSocket, 5000); // Reconnect after 5s
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'price_update') {
                    updatePriceTicker(data.symbol, data.price);
                }
            };
        }

        function updateWSIndicator(connected) {
            const indicator = document.getElementById('wsIndicator');
            const dot = indicator.querySelector('.ws-dot');
            const text = indicator.querySelector('span:last-child');

            if (connected) {
                indicator.className = 'ws-indicator ws-connected';
                dot.className = 'ws-dot connected';
                text.textContent = 'Live Data';
            } else {
                indicator.className = 'ws-indicator ws-disconnected';
                dot.className = 'ws-dot disconnected';
                text.textContent = 'Disconnected';
            }
        }

        function updatePriceTicker(symbol, price) {
            priceData[symbol] = price;
            const ticker = document.getElementById('priceTicker');
            ticker.innerHTML = Object.entries(priceData).map(([sym, prc]) => `
                <span class="price-item">
                    <span class="price-symbol">${sym}</span>
                    <span class="price-value">$${prc.toFixed(2)}</span>
                </span>
            `).join('');
        }

        // Generate Strategy
        async function generateStrategy() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Generating...';

            const payload = {
                token_address: document.getElementById('tokenAddress').value,
                analysis_type: document.getElementById('analysisType').value,
                use_swarm: document.getElementById('useSwarm').checked
            };

            try {
                const response = await fetch(`${API_BASE}/api/trading/strategy/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('success', '‚úÖ Strategy generated successfully!');

                    // Save strategy
                    await saveStrategy(data);

                    // Reload library
                    await loadStrategies();
                } else {
                    showAlert('error', `‚ùå Error: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                showAlert('error', `‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚ú® Generate Strategy';
            }
        }

        async function saveStrategy(data) {
            const strategyPayload = {
                name: `AI Strategy - ${data.symbol || 'Unknown'} - ${new Date().toLocaleString()}`,
                description: `Auto-generated strategy using ${data.agent}`,
                strategy_type: 'ai_generated',
                code: JSON.stringify(data.signal || data),
                parameters: data.signal || {},
                tags: ['ai_generated', data.symbol || 'unknown']
            };

            await fetch(`${API_BASE}/api/strategies`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(strategyPayload)
            });
        }

        // Load Strategies
        async function loadStrategies() {
            try {
                const response = await fetch(`${API_BASE}/api/strategies?limit=50&sort_by=created_at`);
                const strategies = await response.json();

                const listEl = document.getElementById('strategyList');

                if (strategies.length === 0) {
                    listEl.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No strategies yet. Generate your first strategy!</p>';
                    return;
                }

                listEl.innerHTML = strategies.map(s => `
                    <div class="strategy-item" onclick="selectStrategy('${s.id}')">
                        <div class="strategy-name">${s.name}</div>
                        <div class="strategy-meta">
                            <span class="metric">üìä Backtests: ${s.total_backtests || 0}</span>
                            ${s.best_sharpe_ratio ? `<span class="metric metric-good">Sharpe: ${s.best_sharpe_ratio.toFixed(2)}</span>` : ''}
                            ${s.best_total_return_pct ? `<span class="metric ${s.best_total_return_pct > 0 ? 'metric-good' : 'metric-bad'}">Return: ${s.best_total_return_pct.toFixed(2)}%</span>` : ''}
                            <span class="metric">üìÖ ${new Date(s.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading strategies:', error);
            }
        }

        // Select Strategy
        async function selectStrategy(strategyId) {
            try {
                const response = await fetch(`${API_BASE}/api/strategies/${strategyId}`);
                selectedStrategy = await response.json();

                // Update UI
                document.querySelectorAll('.strategy-item').forEach(el => el.classList.remove('selected'));
                event.currentTarget.classList.add('selected');

                // Show details
                const detailsEl = document.getElementById('strategyDetails');
                detailsEl.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 10px;">${selectedStrategy.name}</h3>
                        <p style="color: #666; margin-bottom: 15px;">${selectedStrategy.description}</p>

                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-label">Version</div>
                                <div class="result-value">${selectedStrategy.version}</div>
                            </div>
                            <div class="result-card">
                                <div class="result-label">Backtests</div>
                                <div class="result-value">${selectedStrategy.total_backtests || 0}</div>
                            </div>
                            ${selectedStrategy.best_sharpe_ratio ? `
                            <div class="result-card">
                                <div class="result-label">Best Sharpe</div>
                                <div class="result-value">${selectedStrategy.best_sharpe_ratio.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${selectedStrategy.best_total_return_pct ? `
                            <div class="result-card">
                                <div class="result-label">Best Return</div>
                                <div class="result-value ${selectedStrategy.best_total_return_pct > 0 ? 'metric-good' : 'metric-bad'}">
                                    ${selectedStrategy.best_total_return_pct.toFixed(2)}%
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Strategy Code</label>
                        <textarea readonly>${selectedStrategy.code}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Parameters</label>
                        <textarea readonly>${JSON.stringify(selectedStrategy.parameters, null, 2)}</textarea>
                    </div>
                `;

                // Enable action buttons
                document.getElementById('backtestBtn').disabled = false;
                document.getElementById('paperTradeBtn').disabled = false;
                document.getElementById('riskBtn').disabled = false;
            } catch (error) {
                showAlert('error', `Error loading strategy: ${error.message}`);
            }
        }

        // Run Backtest
        async function runBacktest() {
            if (!selectedStrategy) return;

            const btn = document.getElementById('backtestBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Running...';

            try {
                // Start backtest
                const response = await fetch(`${API_BASE}/api/backtest/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        strategy_id: selectedStrategy.id,
                        symbol: 'SOL/USD',
                        start_date: '2023-01-01T00:00:00Z',
                        end_date: '2024-01-01T00:00:00Z',
                        timeframe: '1d',
                        initial_capital: 10000.0,
                        commission_rate: 0.001
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('info', `‚è≥ Backtest started: ${data.backtest_id}`);

                    // Poll for results
                    pollBacktestResults(data.backtest_id);
                } else {
                    showAlert('error', `Error: ${data.detail}`);
                }
            } catch (error) {
                showAlert('error', `Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üìà Run Backtest';
            }
        }

        async function pollBacktestResults(backtestId) {
            const maxAttempts = 30;
            let attempts = 0;

            const poll = setInterval(async () => {
                attempts++;

                try {
                    const response = await fetch(`${API_BASE}/api/backtest/status/${backtestId}`);
                    const data = await response.json();

                    if (data.status === 'completed') {
                        clearInterval(poll);
                        displayBacktestResults(data);
                        showAlert('success', '‚úÖ Backtest completed!');
                    } else if (data.status === 'failed') {
                        clearInterval(poll);
                        showAlert('error', `‚ùå Backtest failed: ${data.error}`);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(poll);
                        showAlert('error', '‚è±Ô∏è Backtest timed out');
                    }
                } catch (error) {
                    clearInterval(poll);
                    showAlert('error', `Error: ${error.message}`);
                }
            }, 2000);
        }

        function displayBacktestResults(data) {
            const resultsEl = document.getElementById('backtestResults');
            const m = data.metrics;

            resultsEl.innerHTML = `
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-label">Total Return</div>
                        <div class="result-value ${m.total_return_pct > 0 ? 'metric-good' : 'metric-bad'}">
                            ${m.total_return_pct.toFixed(2)}%
                        </div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Sharpe Ratio</div>
                        <div class="result-value">${m.sharpe_ratio.toFixed(2)}</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Max Drawdown</div>
                        <div class="result-value metric-bad">${m.max_drawdown_pct.toFixed(2)}%</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Win Rate</div>
                        <div class="result-value">${(m.win_rate * 100).toFixed(1)}%</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Total Trades</div>
                        <div class="result-value">${m.total_trades}</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Profit Factor</div>
                        <div class="result-value">${m.profit_factor.toFixed(2)}</div>
                    </div>
                </div>
            `;
        }

        // Start Paper Trading
        async function startPaperTrading() {
            if (!selectedStrategy) return;

            showAlert('info', 'üìù Paper trading feature coming soon! Use the API directly for now.');
        }

        // Calculate Risk
        async function calculateRisk() {
            if (!selectedStrategy) return;

            showAlert('info', '‚ö†Ô∏è Risk analysis feature coming soon! Use the API directly for now.');
        }

        // Utility Functions
        function showAlert(type, message) {
            const resultEl = document.getElementById('generationResult');
            resultEl.className = `alert alert-${type}`;
            resultEl.textContent = message;
            resultEl.classList.remove('hidden');

            setTimeout(() => {
                resultEl.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
