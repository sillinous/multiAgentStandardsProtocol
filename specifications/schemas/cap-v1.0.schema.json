{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://superstandard.org/schemas/cap/v1.0.json",
  "title": "Code Analysis Protocol (CAP) v1.0",
  "description": "Standard protocol for automated code analysis, quality metrics, vulnerability scanning, and code intelligence. Supports static analysis, dynamic analysis, security scanning, and code quality assessment.",
  "version": "1.0.0",
  "type": "object",
  "required": ["protocol", "version"],
  "properties": {
    "protocol": {
      "type": "string",
      "const": "CAP"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "default": "1.0.0"
    },
    "analysis_type": {
      "type": "string",
      "enum": [
        "static_analysis",
        "dynamic_analysis",
        "security_scan",
        "quality_metrics",
        "dependency_audit",
        "test_coverage",
        "complexity_analysis",
        "code_smell_detection",
        "performance_profiling"
      ]
    },
    "analysis_request": {
      "$ref": "#/$defs/AnalysisRequest"
    },
    "analysis_result": {
      "$ref": "#/$defs/AnalysisResult"
    },
    "quality_metrics": {
      "$ref": "#/$defs/QualityMetrics"
    },
    "security_findings": {
      "$ref": "#/$defs/SecurityFindings"
    }
  },
  "$defs": {
    "AnalysisRequest": {
      "type": "object",
      "description": "Request for code analysis",
      "required": ["analysis_id", "target"],
      "properties": {
        "analysis_id": {
          "type": "string",
          "format": "uuid"
        },
        "target": {
          "type": "object",
          "description": "Code to analyze",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["file", "directory", "repository", "snippet", "function", "class"]
            },
            "location": {
              "type": "string",
              "description": "Path, URL, or identifier"
            },
            "language": {
              "type": "string",
              "description": "Programming language (auto-detect if not specified)"
            },
            "version": {
              "type": "string",
              "description": "Language/framework version"
            },
            "content": {
              "type": "string",
              "description": "Inline code content"
            }
          }
        },
        "analysis_config": {
          "type": "object",
          "properties": {
            "depth": {
              "type": "string",
              "enum": ["quick", "standard", "deep", "comprehensive"],
              "default": "standard"
            },
            "include_tests": {
              "type": "boolean",
              "default": true
            },
            "include_dependencies": {
              "type": "boolean",
              "default": false
            },
            "exclude_patterns": {
              "type": "array",
              "description": "Glob patterns to exclude",
              "items": {"type": "string"}
            },
            "rules": {
              "type": "object",
              "description": "Analysis rule configuration",
              "properties": {
                "enabled_rules": {
                  "type": "array",
                  "items": {"type": "string"}
                },
                "disabled_rules": {
                  "type": "array",
                  "items": {"type": "string"}
                },
                "severity_threshold": {
                  "type": "string",
                  "enum": ["info", "warning", "error", "critical"],
                  "default": "warning"
                }
              }
            },
            "output_format": {
              "type": "string",
              "enum": ["json", "sarif", "html", "markdown"],
              "default": "json"
            }
          }
        },
        "requested_by": {
          "type": "string",
          "description": "Agent ID requesting analysis"
        },
        "priority": {
          "type": "string",
          "enum": ["low", "normal", "high", "urgent"],
          "default": "normal"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "AnalysisResult": {
      "type": "object",
      "description": "Code analysis results",
      "properties": {
        "analysis_id": {"type": "string"},
        "status": {
          "type": "string",
          "enum": ["completed", "failed", "partial", "in_progress"]
        },
        "summary": {
          "type": "object",
          "properties": {
            "total_files_analyzed": {"type": "integer"},
            "total_lines_of_code": {"type": "integer"},
            "total_issues_found": {"type": "integer"},
            "critical_issues": {"type": "integer"},
            "high_issues": {"type": "integer"},
            "medium_issues": {"type": "integer"},
            "low_issues": {"type": "integer"},
            "analysis_duration_ms": {"type": "integer"}
          }
        },
        "issues": {
          "type": "array",
          "items": {"$ref": "#/$defs/CodeIssue"}
        },
        "quality_metrics": {"$ref": "#/$defs/QualityMetrics"},
        "security_findings": {"$ref": "#/$defs/SecurityFindings"},
        "recommendations": {
          "type": "array",
          "description": "Actionable recommendations",
          "items": {
            "type": "object",
            "properties": {
              "title": {"type": "string"},
              "description": {"type": "string"},
              "priority": {
                "type": "string",
                "enum": ["low", "medium", "high", "critical"]
              },
              "effort": {
                "type": "string",
                "enum": ["trivial", "easy", "moderate", "hard"],
                "description": "Estimated effort to fix"
              },
              "impact": {
                "type": "string",
                "enum": ["low", "medium", "high"],
                "description": "Impact of implementing recommendation"
              }
            }
          }
        },
        "analyzed_at": {"type": "string", "format": "date-time"},
        "analyzer_version": {"type": "string"}
      }
    },
    "CodeIssue": {
      "type": "object",
      "description": "Individual code issue found",
      "properties": {
        "issue_id": {"type": "string"},
        "rule_id": {
          "type": "string",
          "description": "Rule that triggered this issue"
        },
        "severity": {
          "type": "string",
          "enum": ["info", "warning", "error", "critical"]
        },
        "category": {
          "type": "string",
          "enum": [
            "bug",
            "vulnerability",
            "code_smell",
            "performance",
            "maintainability",
            "security",
            "style",
            "documentation",
            "best_practice"
          ]
        },
        "title": {"type": "string"},
        "description": {"type": "string"},
        "location": {
          "type": "object",
          "properties": {
            "file": {"type": "string"},
            "start_line": {"type": "integer"},
            "end_line": {"type": "integer"},
            "start_column": {"type": "integer"},
            "end_column": {"type": "integer"},
            "code_snippet": {"type": "string"}
          }
        },
        "cwe_id": {
          "type": "array",
          "description": "CWE (Common Weakness Enumeration) IDs",
          "items": {"type": "string"}
        },
        "cve_id": {
          "type": "array",
          "description": "CVE (Common Vulnerabilities and Exposures) IDs",
          "items": {"type": "string"}
        },
        "fix_available": {"type": "boolean"},
        "suggested_fix": {
          "type": "object",
          "properties": {
            "description": {"type": "string"},
            "diff": {"type": "string"},
            "automated": {
              "type": "boolean",
              "description": "Can be auto-fixed"
            }
          }
        },
        "references": {
          "type": "array",
          "description": "Documentation/reference links",
          "items": {"type": "string", "format": "uri"}
        }
      }
    },
    "QualityMetrics": {
      "type": "object",
      "description": "Code quality metrics",
      "properties": {
        "maintainability_index": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Overall maintainability score (0-100)"
        },
        "cyclomatic_complexity": {
          "type": "object",
          "properties": {
            "average": {"type": "number"},
            "max": {"type": "number"},
            "files_over_threshold": {"type": "integer"}
          }
        },
        "cognitive_complexity": {
          "type": "number",
          "description": "How hard code is to understand"
        },
        "test_coverage": {
          "type": "object",
          "properties": {
            "line_coverage": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "branch_coverage": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "function_coverage": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "uncovered_lines": {"type": "integer"}
          }
        },
        "code_duplication": {
          "type": "object",
          "properties": {
            "duplicated_lines": {"type": "integer"},
            "duplicated_blocks": {"type": "integer"},
            "duplication_percentage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            }
          }
        },
        "documentation_coverage": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Percentage of functions/classes documented"
        },
        "technical_debt": {
          "type": "object",
          "properties": {
            "total_minutes": {"type": "integer"},
            "debt_ratio": {"type": "number"},
            "high_interest_issues": {"type": "integer"}
          }
        }
      }
    },
    "SecurityFindings": {
      "type": "object",
      "description": "Security-specific findings",
      "properties": {
        "vulnerability_count": {
          "type": "object",
          "properties": {
            "critical": {"type": "integer"},
            "high": {"type": "integer"},
            "medium": {"type": "integer"},
            "low": {"type": "integer"}
          }
        },
        "vulnerabilities": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "vulnerability_id": {"type": "string"},
              "title": {"type": "string"},
              "severity": {
                "type": "string",
                "enum": ["critical", "high", "medium", "low", "info"]
              },
              "cvss_score": {
                "type": "number",
                "minimum": 0,
                "maximum": 10
              },
              "description": {"type": "string"},
              "affected_component": {"type": "string"},
              "exploit_available": {"type": "boolean"},
              "patch_available": {"type": "boolean"},
              "remediation": {"type": "string"}
            }
          }
        },
        "dependency_vulnerabilities": {
          "type": "array",
          "description": "Vulnerabilities in dependencies",
          "items": {
            "type": "object",
            "properties": {
              "package_name": {"type": "string"},
              "current_version": {"type": "string"},
              "vulnerable_version_range": {"type": "string"},
              "fixed_version": {"type": "string"},
              "severity": {"type": "string"},
              "cve_ids": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          }
        },
        "secrets_detected": {
          "type": "array",
          "description": "Hardcoded secrets found",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["api_key", "password", "token", "private_key", "certificate"]
              },
              "file": {"type": "string"},
              "line": {"type": "integer"},
              "confidence": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              }
            }
          }
        },
        "security_hotspots": {
          "type": "array",
          "description": "Areas requiring security review",
          "items": {
            "type": "object",
            "properties": {
              "category": {
                "type": "string",
                "enum": [
                  "injection",
                  "authentication",
                  "authorization",
                  "cryptography",
                  "data_protection",
                  "input_validation"
                ]
              },
              "file": {"type": "string"},
              "line": {"type": "integer"},
              "description": {"type": "string"}
            }
          }
        }
      }
    }
  },
  "examples": [
    {
      "protocol": "CAP",
      "version": "1.0.0",
      "analysis_type": "static_analysis",
      "analysis_request": {
        "analysis_id": "analysis_550e8400",
        "target": {
          "type": "repository",
          "location": "https://github.com/org/repo",
          "language": "python",
          "version": "3.11"
        },
        "analysis_config": {
          "depth": "comprehensive",
          "include_tests": true,
          "include_dependencies": true,
          "rules": {
            "severity_threshold": "warning"
          }
        },
        "requested_by": "apqc_11_3_qa_agent_001",
        "priority": "high",
        "timestamp": "2025-11-16T14:00:00Z"
      }
    },
    {
      "protocol": "CAP",
      "version": "1.0.0",
      "analysis_type": "security_scan",
      "analysis_result": {
        "analysis_id": "analysis_550e8400",
        "status": "completed",
        "summary": {
          "total_files_analyzed": 487,
          "total_lines_of_code": 45320,
          "total_issues_found": 23,
          "critical_issues": 2,
          "high_issues": 5,
          "medium_issues": 11,
          "low_issues": 5,
          "analysis_duration_ms": 8450
        },
        "quality_metrics": {
          "maintainability_index": 78.5,
          "cyclomatic_complexity": {
            "average": 4.2,
            "max": 15,
            "files_over_threshold": 3
          },
          "test_coverage": {
            "line_coverage": 0.85,
            "branch_coverage": 0.78,
            "function_coverage": 0.92
          }
        },
        "security_findings": {
          "vulnerability_count": {
            "critical": 2,
            "high": 3,
            "medium": 5,
            "low": 8
          },
          "vulnerabilities": [
            {
              "vulnerability_id": "vuln_001",
              "title": "SQL Injection in user query",
              "severity": "critical",
              "cvss_score": 9.1,
              "description": "Unsanitized user input in SQL query",
              "affected_component": "database_handler.py:line 156",
              "exploit_available": true,
              "patch_available": true,
              "remediation": "Use parameterized queries or ORM"
            }
          ],
          "secrets_detected": [
            {
              "type": "api_key",
              "file": "config.py",
              "line": 23,
              "confidence": "high"
            }
          ]
        },
        "analyzed_at": "2025-11-16T14:05:00Z",
        "analyzer_version": "CAP/1.0.0"
      }
    }
  ]
}
