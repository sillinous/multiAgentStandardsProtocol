<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APQC Agent Platform - Master Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-in;
        }

        header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            animation: slideUp 0.8s ease-out;
        }

        .tab-button {
            background: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2.8em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            animation: slideUp 1s ease-out;
        }

        .search-section {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn.secondary:hover {
            background: #e0e0e0;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .agent-card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .agent-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            transform: translateY(-3px);
        }

        .agent-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .agent-card .id {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .agent-card .category {
            display: inline-block;
            background: #f0f0f0;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
        }

        .agent-card .action-btn {
            margin-top: 15px;
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .agent-card .action-btn:hover {
            background: #764ba2;
        }

        .category-browser {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea30;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            transform: translateY(-3px);
        }

        .category-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .category-card .count {
            font-size: 1.8em;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Integration Catalog Styles */
        .integration-category-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .integration-category-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .integration-category-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .integrations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .integration-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .integration-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .integration-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .integration-card .name {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .integration-card .category-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .integration-card .description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .integration-card .capabilities {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .integration-card .capability-tag {
            background: #f0f0f0;
            color: #555;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .integration-card .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .integration-card .btn-configure {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .integration-card .btn-configure:hover {
            background: #667eea;
            color: white;
        }

        .integration-card .btn-configure.configured {
            border-color: #27ae60;
            color: #27ae60;
        }

        .integration-card .btn-configure.configured:hover {
            background: #27ae60;
            color: white;
        }

        .integration-card .config-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
        }

        .integration-card .config-status.configured {
            background: #27ae60;
            box-shadow: 0 0 8px rgba(39, 174, 96, 0.5);
        }

        .credential-form-group {
            margin-bottom: 18px;
        }

        .credential-form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .credential-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .credential-form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .credential-form-group input.has-value {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .credential-form-group .field-hint {
            font-size: 0.8em;
            color: #888;
            margin-top: 4px;
        }

        .credential-form-group .field-hint code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .detail-item {
            margin-bottom: 20px;
        }

        .detail-item label {
            font-weight: 600;
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .detail-item .value {
            color: #333;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            word-break: break-word;
        }

        /* BPMN Modal - Larger for diagram viewing */
        .bpmn-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .bpmn-container {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            overflow: hidden;
            position: relative;
        }

        .bpmn-xml-view {
            width: 100%;
            height: 100%;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow: auto;
            white-space: pre;
            border: none;
            resize: none;
        }

        .bpmn-toolbar {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 10px;
        }

        .bpmn-toolbar button {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .bpmn-toolbar button:hover {
            background: #f0f0f0;
        }

        .bpmn-toolbar button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .bpmn-info {
            display: flex;
            gap: 20px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea10, #764ba210);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .bpmn-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .bpmn-info-item label {
            font-weight: 600;
            color: #667eea;
        }

        .btn-bpmn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: #1a1a2e;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75em;
            transition: all 0.2s;
        }

        .btn-bpmn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 233, 123, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination button {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .results-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .result-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-right: 10px;
        }

        .result-badge.success {
            background: #d4fc79;
            color: #56ab2f;
        }

        .result-badge.error {
            background: #ffecd2;
            color: #f45c43;
        }

        /* BPMN Standard Diagram Styles */
        .bpmn-standard-container {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 8px;
        }

        .bpmn-standard-container .bjs-container {
            width: 100% !important;
            height: 100% !important;
        }

        .bpmn-view-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 0;
        }

        .bpmn-view-tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .bpmn-view-tab:hover {
            background: #e8e8e8;
        }

        .bpmn-view-tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .bpmn-view-pane {
            display: none;
            height: calc(100% - 50px);
        }

        .bpmn-view-pane.active {
            display: block;
        }

        .bpmn-diagram-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .bpmn-control-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .bpmn-control-btn:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }
    </style>
    <!-- BPMN.js Modeler for Interactive BPMN 2.0 Editing -->
    <script src="https://unpkg.com/bpmn-js@17.11.1/dist/bpmn-modeler.production.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.11.1/dist/assets/bpmn-font/css/bpmn-embedded.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ APQC Agent Platform</h1>
            <p>Comprehensive Agent Management & Workflow Orchestration</p>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <h3>Total Agents</h3>
                <div class="value" id="totalAgents">-</div>
            </div>
            <div class="stat-card">
                <h3>Categories</h3>
                <div class="value" id="totalCategories">-</div>
            </div>
            <div class="stat-card">
                <h3>Workflows</h3>
                <div class="value" id="totalWorkflows">-</div>
            </div>
            <div class="stat-card">
                <h3>Success Rate</h3>
                <div class="value" id="successRate">-</div>
            </div>
            <div class="stat-card" id="apiHealthCard" style="cursor: pointer;" onclick="checkApiHealth()" title="Click to refresh">
                <h3>API Status</h3>
                <div class="value" id="apiHealth" style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                    <span id="apiHealthDot" style="width: 10px; height: 10px; border-radius: 50%; background: #f39c12;"></span>
                    <span id="apiHealthText">Checking...</span>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs-container">
            <button class="tab-button active" onclick="switchTab('agents')">üîç Agent Explorer</button>
            <button class="tab-button" onclick="switchTab('categories')">üìÇ Browse Categories</button>
            <button class="tab-button" onclick="switchTab('integrations')">üîå Integrations</button>
            <button class="tab-button" onclick="switchTab('ai')">ü§ñ AI Processing</button>
            <button class="tab-button" onclick="switchTab('orchestration')">üé≠ Orchestration</button>
            <button class="tab-button" onclick="switchTab('execute')">üöÄ Execute Workflows</button>
            <button class="tab-button" onclick="switchTab('workflow')">üìã Test Workflow</button>
            <button class="tab-button" onclick="switchTab('bpmn')">üìä BPMN Browser</button>
            <button class="tab-button" onclick="switchTab('agentcards')">üé¥ Agent Cards</button>
            <button class="tab-button" onclick="switchTab('metrics')">üìà Metrics</button>
            <button class="tab-button" onclick="switchTab('platform')" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">‚ö° Platform Admin (V2)</button>
        </div>

        <!-- Agent Explorer Tab -->
        <div id="tab-agents" class="tab-content active">
            <div class="main-content">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üîç Agent Explorer - Search & Filter</h2>
                    <!-- Quick Actions -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn" onclick="switchTab('agentcards'); openCardGeneratorModal();" style="background: linear-gradient(135deg, #27ae60, #2ecc71); padding: 8px 14px; font-size: 0.85em;">
                            ‚ûï New Agent Card
                        </button>
                        <button class="btn" onclick="switchTab('execute');" style="background: linear-gradient(135deg, #3498db, #2980b9); padding: 8px 14px; font-size: 0.85em;">
                            üöÄ Run Workflow
                        </button>
                        <button class="btn" onclick="switchTab('ai'); runAIDemo('finance');" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); padding: 8px 14px; font-size: 0.85em;">
                            ü§ñ AI Demo
                        </button>
                        <div class="dropdown" style="position: relative;">
                            <button class="btn secondary" onclick="toggleQuickMenu()" style="padding: 8px 14px; font-size: 0.85em;">
                                ‚ö° More ‚ñº
                            </button>
                            <div id="quickActionsMenu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 5px; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 100; min-width: 200px;">
                                <a href="#" onclick="switchTab('agentcards'); exportAgentCards(); return false;" style="display: block; padding: 12px 16px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">üì§ Export Agent Cards</a>
                                <a href="#" onclick="switchTab('integrations'); return false;" style="display: block; padding: 12px 16px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">üîå View Integrations</a>
                                <a href="#" onclick="switchTab('bpmn'); return false;" style="display: block; padding: 12px 16px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">üìä BPMN Browser</a>
                                <a href="#" onclick="switchTab('metrics'); return false;" style="display: block; padding: 12px 16px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">üìà Platform Metrics</a>
                                <a href="/docs" target="_blank" style="display: block; padding: 12px 16px; color: #333; text-decoration: none;">üìö API Docs</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="search-section">
                    <input type="text" id="agentSearch" class="search-input" placeholder="Search agents (use * for wildcard, e.g., manage*)" onkeypress="if(event.key==='Enter') searchAgents()">
                    <select id="categoryFilter" class="filter-select">
                        <option value="">All Categories</option>
                    </select>
                    <button class="btn" onclick="searchAgents()">üîç Search</button>
                    <button class="btn secondary" onclick="resetSearch()">‚Üª Reset</button>
                </div>
                <div style="margin-bottom: 20px; padding: 12px; background: #f0f0f0; border-radius: 8px; font-size: 0.9em; color: #555;">
                    <strong>üí° Search Tips:</strong> Use <code>*</code> for wildcard (e.g., <code>manage*</code>), <code>?</code> for single character, or search by name, ID, APQC code, or category. Select a category to filter further. Press Enter to search.
                </div>

                <div id="agentsContainer" class="agents-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div id="agentsPagination" class="pagination"></div>
            </div>
        </div>

        <!-- Categories Browse Tab - APQC Hierarchy Drill-Down -->
        <div id="tab-categories" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 10px;">üìÇ APQC Process Classification Framework</h2>
                <p style="color: #666; margin-bottom: 20px;">Click any card to drill down into its children. All 1,300+ APQC PCF items organized by hierarchy.</p>

                <!-- Breadcrumb Navigation -->
                <div id="apqcBreadcrumb" style="display: flex; align-items: center; gap: 8px; margin-bottom: 25px; padding: 12px 15px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 10px; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #667eea;">üìç Path:</span>
                    <button class="breadcrumb-item active" onclick="drillToLevel(0)" style="background: #667eea; color: white; border: none; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 500;">üè† All Categories</button>
                </div>

                <!-- Cards Container -->
                <div id="apqcCardsContainer" class="category-browser">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Item Count -->
                <div id="apqcItemCount" style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;"></div>
            </div>
        </div>

        <!-- Integrations Tab -->
        <div id="tab-integrations" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 10px;">üîå Integration Catalog</h2>
                <p style="color: #666; margin-bottom: 20px;">Browse all available API integrations and services that power APQC agent workflows.</p>

                <!-- Category Filter -->
                <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button class="integration-category-btn active" onclick="filterIntegrations('all')" data-category="all">All</button>
                    <button class="integration-category-btn" onclick="filterIntegrations('finance')" data-category="finance">üí∞ Finance</button>
                    <button class="integration-category-btn" onclick="filterIntegrations('hr')" data-category="hr">üë• HR</button>
                    <button class="integration-category-btn" onclick="filterIntegrations('crm')" data-category="crm">üìä CRM</button>
                    <button class="integration-category-btn" onclick="filterIntegrations('documents')" data-category="documents">üìÑ Documents</button>
                    <button class="integration-category-btn" onclick="filterIntegrations('communication')" data-category="communication">üí¨ Communication</button>
                    <button class="integration-category-btn" onclick="filterIntegrations('ai')" data-category="ai">ü§ñ AI</button>
                    <button class="integration-category-btn" onclick="filterIntegrations('storage')" data-category="storage">üíæ Storage</button>
                    <button class="integration-category-btn" onclick="filterIntegrations('automation')" data-category="automation">‚ö° Automation</button>
                </div>

                <!-- Stats Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea15, #764ba215); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: 700; color: #667eea;" id="totalIntegrations">-</div>
                        <div style="color: #888; font-size: 0.85em;">Total Integrations</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b15, #38f9d715); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: 700; color: #2d8a4e;" id="totalCategories">-</div>
                        <div style="color: #888; font-size: 0.85em;">Categories</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffecd215, #fcb69f15); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: 700; color: #e67e22;" id="totalCapabilities">-</div>
                        <div style="color: #888; font-size: 0.85em;">Capabilities</div>
                    </div>
                </div>

                <!-- Integrations Grid -->
                <div id="integrationsContainer" class="integrations-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Processing Tab -->
        <div id="tab-ai" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 10px;">ü§ñ AI-Powered Processing</h2>
                <p style="color: #666; margin-bottom: 25px;">Intelligent processing using domain-specific AI processors. 78 agents enhanced with smart processing capabilities.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Left: AI Status & Domains -->
                    <div>
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>üìä AI Service Status</h3>
                            <div id="aiStatusContent" style="padding: 15px 0;">
                                <div class="spinner"></div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>üè¢ Domain Processors</h3>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Select a domain to run a demo</p>
                            <div id="aiDomainsContent" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <button class="btn" onclick="runAIDemo('finance')" style="background: #10b981;">üí∞ Finance</button>
                                <button class="btn" onclick="runAIDemo('hr')" style="background: #8b5cf6;">üë• HR</button>
                                <button class="btn" onclick="runAIDemo('operations')" style="background: #f59e0b;">üè≠ Operations</button>
                                <button class="btn" onclick="runAIDemo('customer_service')" style="background: #3b82f6;">üéß Customer Service</button>
                                <button class="btn" onclick="runAIDemo('it')" style="background: #ef4444;">üíª IT</button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Demo Results -->
                    <div>
                        <div class="card">
                            <h3>üß™ Demo Results</h3>
                            <div id="aiDemoResults" style="padding: 15px 0;">
                                <p style="color: #666; text-align: center;">Click a domain button to run a demo</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Agents List -->
                <div class="card" style="margin-top: 20px;">
                    <h3>ü§ñ AI-Powered Agents (78 Total)</h3>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Agents enhanced with smart processing capabilities by domain</p>
                    <div id="aiAgentsContent" style="max-height: 400px; overflow-y: auto;">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- API Endpoints Reference -->
                <div class="card" style="margin-top: 20px;">
                    <h3>üì° AI API Endpoints</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <code style="color: #10b981;">GET /api/ai/status</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Get AI service status and capabilities</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <code style="color: #3b82f6;">GET /api/ai/domains</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">List available domain processors</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                            <code style="color: #8b5cf6;">POST /api/ai/process</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Process data with domain processor</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <code style="color: #f59e0b;">POST /api/ai/analyze</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">AI-powered data analysis</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <code style="color: #ef4444;">POST /api/ai/recommend</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Generate AI recommendations</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1;">
                            <code style="color: #6366f1;">POST /api/ai/demo/{domain}</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Run domain demo with sample data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orchestration Tab -->
        <div id="tab-orchestration" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 10px;">üé≠ Composite Agent Orchestration</h2>
                <p style="color: #666; margin-bottom: 25px;">Execute composite workflows with AI-powered orchestration. Coordinate multiple agents for complex business processes.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Left: Composite Selection -->
                    <div>
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>üìä Orchestration Status</h3>
                            <div id="orchestrationStatusContent" style="padding: 15px 0;">
                                <div class="spinner"></div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>üè¢ Available Composite Agents</h3>
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Select a composite to execute</p>
                            <div id="compositesListContent" style="max-height: 350px; overflow-y: auto;">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Execution -->
                    <div>
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>üöÄ Execute Composite Workflow</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Selected Composite:</label>
                                <input type="text" id="selectedComposite" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;" placeholder="Select from list...">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Max Agents to Execute:</label>
                                <input type="number" id="maxAgents" value="5" min="1" max="20" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Input Data (JSON):</label>
                                <textarea id="orchestrationInput" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace;">{}</textarea>
                            </div>
                            <button class="btn" onclick="executeComposite()" style="width: 100%; background: #10b981;">‚ñ∂Ô∏è Execute Composite Workflow</button>
                        </div>

                        <div class="card">
                            <h3>üìã Execution Results</h3>
                            <div id="orchestrationResults" style="padding: 15px 0; max-height: 300px; overflow-y: auto;">
                                <p style="color: #666; text-align: center;">Select and execute a composite workflow</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Executions -->
                <div class="card" style="margin-top: 20px;">
                    <h3>üìú Recent Executions</h3>
                    <div id="recentOrchestrations" style="max-height: 300px; overflow-y: auto;">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- API Reference -->
                <div class="card" style="margin-top: 20px;">
                    <h3>üì° Orchestration API Endpoints</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <code style="color: #10b981;">GET /api/orchestration/status</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Get orchestration engine status</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <code style="color: #3b82f6;">GET /api/orchestration/composites</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">List available composite agents</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                            <code style="color: #8b5cf6;">POST /api/orchestration/execute</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Execute custom workflow</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <code style="color: #f59e0b;">POST /api/orchestration/composite/{level}/{id}</code>
                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Execute composite agent</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execute Workflows Tab -->
        <div id="tab-execute" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 10px;">üöÄ Execute Workflows</h2>
                <p style="color: #666; margin-bottom: 25px;">Run APQC processes with the execution engine. Select a workflow, provide input data, and execute.</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Left: Workflow Selection & Input -->
                    <div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                            <h3 style="color: #667eea; margin: 0 0 15px 0;">Select Workflow</h3>
                            <select id="executeWorkflowSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; margin-bottom: 15px;">
                                <option value="">-- Select a workflow --</option>
                            </select>
                            <div id="selectedWorkflowInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-weight: 600;" id="workflowInfoName">-</span>
                                    <span style="background: #667eea20; color: #667eea; padding: 3px 10px; border-radius: 12px; font-size: 0.8em;" id="workflowInfoSteps">- steps</span>
                                </div>
                                <div style="font-size: 0.85em; color: #666;" id="workflowInfoCategory">-</div>
                                <div style="margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap;" id="workflowInfoIntegrations"></div>
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0;">
                            <h3 style="color: #667eea; margin: 0 0 15px 0;">Input Data (JSON)</h3>
                            <textarea id="executeInputData" rows="12" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 0.9em; resize: vertical; box-sizing: border-box;"></textarea>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn" onclick="executeWorkflow()" style="flex: 1; background: linear-gradient(135deg, #43e97b, #38f9d7);">
                                    üöÄ Execute Workflow
                                </button>
                                <button class="btn secondary" onclick="loadSampleInput()" style="padding: 10px 20px;">
                                    Load Sample
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Execution Progress & Results -->
                    <div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                            <h3 style="color: #667eea; margin: 0 0 15px 0;">Execution Progress</h3>
                            <div id="executionProgress">
                                <div style="text-align: center; padding: 30px; color: #888;">
                                    Select a workflow and click Execute to begin
                                </div>
                            </div>
                        </div>

                        <div id="executionResultsContainer" style="display: none; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0;">
                            <h3 style="color: #667eea; margin: 0 0 15px 0;">Execution Results</h3>
                            <div id="executionResults"></div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea15, #764ba215); padding: 20px; border-radius: 12px; text-align: center;">
                        <div id="wfStatTotal" style="font-size: 2em; font-weight: bold; color: #667eea;">--</div>
                        <div style="color: #666; font-size: 0.85em;">Total Executions</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #27ae6015, #2ecc7115); padding: 20px; border-radius: 12px; text-align: center;">
                        <div id="wfStatSuccess" style="font-size: 2em; font-weight: bold; color: #27ae60;">--%</div>
                        <div style="color: #666; font-size: 0.85em;">Success Rate</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db15, #2980b915); padding: 20px; border-radius: 12px; text-align: center;">
                        <div id="wfStatRunning" style="font-size: 2em; font-weight: bold; color: #3498db;">--</div>
                        <div style="color: #666; font-size: 0.85em;">Running</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f39c1215, #e67e2215); padding: 20px; border-radius: 12px; text-align: center;">
                        <div id="wfStatAvgTime" style="font-size: 2em; font-weight: bold; color: #f39c12;">--</div>
                        <div style="color: #666; font-size: 0.85em;">Avg Time (ms)</div>
                    </div>
                </div>

                <!-- Recent Executions -->
                <div style="margin-top: 20px; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #667eea; margin: 0;">Recent Executions</h3>
                        <div style="display: flex; gap: 10px;">
                            <select id="wfStatusFilter" onchange="loadRecentExecutions()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="running">Running</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                            <button class="btn secondary" onclick="loadRecentExecutions()" style="padding: 8px 16px; font-size: 0.9em;">Refresh</button>
                        </div>
                    </div>
                    <div id="recentExecutions">
                        <div style="text-align: center; padding: 20px; color: #888;">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow Testing Tab -->
        <div id="tab-workflow" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 20px;">üìã Test Invoice Processing Workflow</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">Submit Invoice</h3>
                        <form id="invoiceForm">
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; margin-bottom: 5px; display: block;">Invoice Number</label>
                                <input type="text" id="invoiceNumber" required placeholder="INV-2025-001" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; margin-bottom: 5px; display: block;">Vendor Name</label>
                                <input type="text" id="vendorName" required placeholder="Acme Corp" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; margin-bottom: 5px; display: block;">Date</label>
                                <input type="date" id="invoiceDate" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; margin-bottom: 5px; display: block;">Line Items (JSON)</label>
                                <textarea id="lineItems" rows="6" required placeholder='[{"desc": "Item", "qty": 1, "price": 100}]' style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 0.9em;"></textarea>
                            </div>
                            <button type="submit" class="btn" style="width: 100%;">Process Invoice</button>
                        </form>
                    </div>

                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">Pipeline Visualization</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div id="node-extract" style="padding: 20px; background: #f0f0f0; border-radius: 10px; text-align: center;">
                                <strong>Extract</strong><br>
                                <small style="color: #999;" id="dur-extract"></small>
                            </div>
                            <div style="text-align: center; color: #667eea; font-size: 1.5em;">‚Üì</div>
                            <div id="node-validate" style="padding: 20px; background: #f0f0f0; border-radius: 10px; text-align: center;">
                                <strong>Validate</strong><br>
                                <small style="color: #999;" id="dur-validate"></small>
                            </div>
                            <div style="text-align: center; color: #667eea; font-size: 1.5em;">‚Üì</div>
                            <div id="node-calculate" style="padding: 20px; background: #f0f0f0; border-radius: 10px; text-align: center;">
                                <strong>Calculate</strong><br>
                                <small style="color: #999;" id="dur-calculate"></small>
                            </div>
                            <div style="text-align: center; color: #667eea; font-size: 1.5em;">‚Üì</div>
                            <div id="node-approve" style="padding: 20px; background: #f0f0f0; border-radius: 10px; text-align: center;">
                                <strong>Approve</strong><br>
                                <small style="color: #999;" id="dur-approve"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="resultsSection" class="results-section" style="display: none; margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Results</h3>
                    <div id="resultsContainer"></div>
                </div>
            </div>
        </div>

        <!-- BPMN Browser Tab -->
        <div id="tab-bpmn" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 10px;">üìä BPMN Process Diagrams</h2>
                <p style="color: #666; margin-bottom: 20px;">Browse all available BPMN 2.0 process diagrams. Click any process to view its interactive workflow diagram.</p>

                <!-- Stats Bar -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="bpmnTotalCount">--</div>
                        <div style="color: #666; font-size: 0.9em;">Total BPMN Files</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #27ae6015 0%, #2ecc7115 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #27ae60;" id="bpmnLevel2Count">--</div>
                        <div style="color: #666; font-size: 0.9em;">Process Groups (L2)</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db15 0%, #2980b915 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #3498db;" id="bpmnLevel3Count">--</div>
                        <div style="color: #666; font-size: 0.9em;">Processes (L3)</div>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="bpmnSearchInput" class="search-input" placeholder="Search by APQC code (e.g., 9.1 or 10.2)" style="flex: 1; min-width: 200px;" onkeypress="if(event.key==='Enter') filterBpmnList()">
                    <select id="bpmnLevelFilter" class="filter-select" onchange="filterBpmnList()">
                        <option value="">All Levels</option>
                        <option value="2">Level 2 - Process Groups</option>
                        <option value="3">Level 3 - Processes</option>
                    </select>
                    <button class="btn" onclick="filterBpmnList()">üîç Filter</button>
                    <button class="btn secondary" onclick="resetBpmnFilter()">‚Üª Reset</button>
                </div>

                <!-- BPMN Files Grid -->
                <div id="bpmnFilesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Results Count -->
                <div id="bpmnResultsCount" style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;"></div>
            </div>
        </div>

        <!-- Agent Cards Tab -->
        <div id="tab-agentcards" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 10px;">üé¥ Agent Card Catalog</h2>
                <p style="color: #666; margin-bottom: 20px;">Browse executable agent card specifications aligned to APQC Process Classification Framework. Each card defines a complete workflow with input/output schemas, integrations, and decision rules.</p>

                <!-- Stats Bar -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="agentCardsTotalCount">--</div>
                        <div style="color: #666; font-size: 0.9em;">Total Agent Cards</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #27ae6015 0%, #2ecc7115 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #27ae60;" id="agentCardsTotalSteps">--</div>
                        <div style="color: #666; font-size: 0.9em;">Total Workflow Steps</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db15 0%, #2980b915 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #3498db;" id="agentCardsCategories">--</div>
                        <div style="color: #666; font-size: 0.9em;">APQC Categories</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #9b59b615 0%, #8e44ad15 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #9b59b6;" id="agentCardsIntegrations">--</div>
                        <div style="color: #666; font-size: 0.9em;">Integration Types</div>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="agentCardsSearchInput" class="search-input" placeholder="Search by APQC code or name (e.g., 8.2.1.1 or payroll)" style="flex: 1; min-width: 200px;" onkeypress="if(event.key==='Enter') filterAgentCards()">
                    <select id="agentCardsCategoryFilter" class="filter-select" onchange="filterAgentCards()">
                        <option value="">All Categories</option>
                        <option value="1.0">1.0 - Vision & Strategy</option>
                        <option value="2.0">2.0 - Products & Services</option>
                        <option value="3.0">3.0 - Market & Sell</option>
                        <option value="4.0">4.0 - Deliver Products</option>
                        <option value="5.0">5.0 - Deliver Services</option>
                        <option value="6.0">6.0 - Customer Service</option>
                        <option value="7.0">7.0 - Human Capital</option>
                        <option value="8.0">8.0 - IT</option>
                        <option value="9.0">9.0 - Financial Resources</option>
                        <option value="10.0">10.0 - Assets</option>
                        <option value="11.0">11.0 - Risk & Compliance</option>
                        <option value="12.0">12.0 - External Relations</option>
                        <option value="13.0">13.0 - Business Capabilities</option>
                    </select>
                    <select id="agentCardsPatternFilter" class="filter-select" onchange="filterAgentCards()">
                        <option value="">All Patterns</option>
                        <option value="sequential">Sequential</option>
                        <option value="parallel">Parallel</option>
                        <option value="event_driven">Event Driven</option>
                    </select>
                    <button class="btn" onclick="filterAgentCards()">üîç Filter</button>
                    <button class="btn secondary" onclick="resetAgentCardsFilter()">‚Üª Reset</button>
                    <div style="margin-left: auto; display: flex; gap: 8px;">
                        <button class="btn" onclick="exportAgentCards()" style="background: linear-gradient(135deg, #3498db, #2980b9);">üì§ Export</button>
                        <label class="btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); cursor: pointer; margin: 0;">
                            üì• Import
                            <input type="file" id="importCardInput" accept=".json,.zip" onchange="importAgentCards(this)" style="display: none;" multiple>
                        </label>
                        <button class="btn" onclick="openCardGeneratorModal()" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">‚ûï Create</button>
                    </div>
                </div>

                <!-- Agent Cards Grid -->
                <div id="agentCardsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Results Count -->
                <div id="agentCardsResultsCount" style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;"></div>
            </div>
        </div>

        <!-- Metrics Tab -->
        <div id="tab-metrics" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 10px;">üìà Platform Metrics</h2>
                <p style="color: #666; margin-bottom: 20px;">Real-time observability into agent executions, AI processing, and platform performance.</p>

                <!-- Metrics Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="metricsAgentExecutions">--</div>
                        <div style="color: #666; font-size: 0.9em;">Agent Executions</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #27ae6015 0%, #2ecc7115 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #27ae60;" id="metricsAICalls">--</div>
                        <div style="color: #666; font-size: 0.9em;">AI Processing Calls</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db15 0%, #2980b915 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #3498db;" id="metricsOrchestrations">--</div>
                        <div style="color: #666; font-size: 0.9em;">Orchestrations</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e74c3c15 0%, #c0392b15 100%); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #e74c3c;" id="metricsErrors">--</div>
                        <div style="color: #666; font-size: 0.9em;">Errors</div>
                    </div>
                </div>

                <!-- Refresh Button -->
                <div style="text-align: right; margin-bottom: 15px;">
                    <button class="btn secondary" onclick="loadMetricsTab()" style="font-size: 0.9em;">‚Üª Refresh Metrics</button>
                </div>

                <!-- Metrics Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Available Series -->
                    <div style="background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">üìä Metric Series</h3>
                        <div id="metricSeriesList" style="max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; padding: 20px; color: #888;">Loading...</div>
                        </div>
                    </div>

                    <!-- Recent Events -->
                    <div style="background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">üìã Recent Events</h3>
                        <div id="metricsEventsList" style="max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; padding: 20px; color: #888;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Counters Section -->
                <div style="margin-top: 20px; background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üî¢ Counters</h3>
                    <div id="metricsCountersList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div style="text-align: center; padding: 20px; color: #888;">Loading...</div>
                    </div>
                </div>

                <!-- Status -->
                <div id="metricsStatus" style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;"></div>
            </div>
        </div>
    </div>

    <!-- Agent Detail Modal -->
    <div id="agentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agent Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody" class="modal-body"></div>
            <div style="text-align: right;">
                <button class="btn secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Integration Credentials Modal -->
    <div id="credentialsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="credentialsModalTitle">Configure Integration</h2>
                <button class="close-btn" onclick="closeCredentialsModal()">&times;</button>
            </div>
            <div id="credentialsModalBody" class="modal-body">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <div id="credentialsSaveStatus" style="color: #27ae60; font-size: 0.9em;"></div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn secondary" onclick="closeCredentialsModal()">Cancel</button>
                    <button class="btn" onclick="saveIntegrationCredentials()" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">Save Credentials</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Card Execution Modal -->
    <div id="executeModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="executeModalTitle">Execute Workflow</h2>
                <button class="close-btn" onclick="closeExecuteModal()">&times;</button>
            </div>
            <div id="executeModalBody" class="modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- BPMN Viewer Modal -->
    <div id="bpmnModal" class="modal">
        <div class="bpmn-modal-content">
            <div class="modal-header">
                <h2 id="bpmnModalTitle">BPMN Process Diagram</h2>
                <button class="close-btn" onclick="closeBpmnModal()">&times;</button>
            </div>
            <div class="bpmn-info">
                <div class="bpmn-info-item">
                    <label>APQC Code:</label>
                    <span id="bpmnApqcCode">-</span>
                </div>
                <div class="bpmn-info-item">
                    <label>Process:</label>
                    <span id="bpmnProcessName">-</span>
                </div>
                <div class="bpmn-info-item">
                    <label>Standard:</label>
                    <span>BPMN 2.0 (OMG Spec)</span>
                </div>
                <div style="flex: 1;"></div>
                <button onclick="downloadBpmn()" style="padding: 6px 14px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Download .bpmn</button>
                <span id="bpmnStatus" style="color: #666; font-size: 0.9em; margin-left: 10px;"></span>
            </div>
            <!-- View Tabs -->
            <div class="bpmn-view-tabs">
                <button id="tabStandard" class="bpmn-view-tab active" onclick="switchBpmnTab('standard')">Standard BPMN Diagram</button>
                <button id="tabSimple" class="bpmn-view-tab" onclick="switchBpmnTab('simple')">Simple Flow View</button>
                <button id="tabAgentCards" class="bpmn-view-tab" onclick="switchBpmnTab('agentCards')">Agent Cards & Integrations</button>
                <button id="tabXml" class="bpmn-view-tab" onclick="switchBpmnTab('xml')">XML Source</button>
            </div>
            <!-- View Panes -->
            <div class="bpmn-container" style="position: relative;">
                <!-- Standard BPMN Diagram (bpmn-js) -->
                <div id="paneStandard" class="bpmn-view-pane active" style="height: 100%;">
                    <div class="bpmn-diagram-controls">
                        <button class="bpmn-control-btn" onclick="bpmnZoomIn()" title="Zoom In">+</button>
                        <button class="bpmn-control-btn" onclick="bpmnZoomOut()" title="Zoom Out">‚àí</button>
                        <button class="bpmn-control-btn" onclick="bpmnFitView()" title="Fit to View">‚ä°</button>
                        <button class="bpmn-control-btn" onclick="bpmnResetZoom()" title="Reset Zoom">‚Ü∫</button>
                        <span style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></span>
                        <button class="bpmn-control-btn" onclick="bpmnUndo()" title="Undo">‚Ü∂</button>
                        <button class="bpmn-control-btn" onclick="bpmnRedo()" title="Redo">‚Ü∑</button>
                        <span style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></span>
                        <button class="bpmn-control-btn" onclick="saveModifiedBpmn()" title="Save Changes" style="background: #43e97b; color: white; border-color: #38d46e;">üíæ</button>
                    </div>
                    <div style="position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 6px; font-size: 0.85em; color: #667eea; border: 1px solid #e0e0e0;">
                        üí° Drag elements to reposition ‚Ä¢ Click elements to select ‚Ä¢ Use toolbar to edit
                    </div>
                    <div id="bpmnStandardCanvas" class="bpmn-standard-container"></div>
                </div>
                <!-- Simple Flow View -->
                <div id="paneSimple" class="bpmn-view-pane" style="height: 100%; overflow: auto;">
                    <div id="bpmnDiagramContainer" style="width: 100%; height: 100%;"></div>
                </div>
                <!-- Agent Cards & Integrations View -->
                <div id="paneAgentCards" class="bpmn-view-pane" style="height: 100%; overflow: auto; padding: 15px;">
                    <div id="agentCardsContainer">
                        <div style="text-align: center; padding: 40px; color: #888;">
                            Loading agent card data...
                        </div>
                    </div>
                </div>
                <!-- XML Source View -->
                <div id="paneXml" class="bpmn-view-pane" style="height: 100%;">
                    <textarea id="bpmnXmlContainer" class="bpmn-xml-view" readonly style="width: 100%; height: 100%;"></textarea>
                </div>
            </div>
            <div style="text-align: right; margin-top: 15px;">
                <button class="btn secondary" onclick="closeBpmnModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Agent Card Generator Modal -->
    <div id="cardGeneratorModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Create New Agent Card</h3>
                <span class="close-btn" onclick="closeCardGeneratorModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Template Selector -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: white;">Start from Template</label>
                            <select id="gen_template" onchange="applyTemplate(this.value)"
                                style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; background: white;">
                                <option value="">-- Select a template to get started --</option>
                                <option value="approval_workflow">Approval Workflow (4 steps)</option>
                                <option value="data_processing">Data Processing Pipeline (5 steps)</option>
                                <option value="customer_service">Customer Service Flow (6 steps)</option>
                                <option value="compliance_audit">Compliance & Audit (7 steps)</option>
                                <option value="procurement">Procurement Process (5 steps)</option>
                                <option value="onboarding">Employee Onboarding (6 steps)</option>
                                <option value="incident_response">Incident Response (7 steps)</option>
                                <option value="product_development">Product Development (5 steps)</option>
                            </select>
                        </div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 13px; max-width: 300px;">
                            Select a template to pre-fill the form with a common workflow pattern, then customize as needed.
                        </div>
                    </div>
                </div>

                <form id="cardGeneratorForm" onsubmit="generateAgentCard(event)">
                    <!-- Basic Information -->
                    <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #3498db;">Basic Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">APQC ID *</label>
                                <input type="text" id="gen_apqc_id" required placeholder="e.g., 7.3.1.1"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <small style="color: #888;">Format: X.X.X.X (matches APQC PCF structure)</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Process Name *</label>
                                <input type="text" id="gen_name" required placeholder="e.g., Manage vendor relationships"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category *</label>
                            <select id="gen_category" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">Select APQC Category...</option>
                                <option value="1.0 - Develop Vision and Strategy">1.0 - Develop Vision and Strategy</option>
                                <option value="2.0 - Develop and Manage Products and Services">2.0 - Develop and Manage Products and Services</option>
                                <option value="3.0 - Market and Sell Products and Services">3.0 - Market and Sell Products and Services</option>
                                <option value="4.0 - Deliver Physical Products">4.0 - Deliver Physical Products</option>
                                <option value="5.0 - Deliver Services">5.0 - Deliver Services</option>
                                <option value="6.0 - Manage Customer Service">6.0 - Manage Customer Service</option>
                                <option value="7.0 - Develop and Manage Human Capital">7.0 - Develop and Manage Human Capital</option>
                                <option value="8.0 - Manage Information Technology">8.0 - Manage Information Technology</option>
                                <option value="9.0 - Manage Financial Resources">9.0 - Manage Financial Resources</option>
                                <option value="10.0 - Acquire, Construct, and Manage Assets">10.0 - Acquire, Construct, and Manage Assets</option>
                                <option value="11.0 - Manage Enterprise Risk, Compliance, Remediation, & Resiliency">11.0 - Manage Enterprise Risk, Compliance, Remediation, & Resiliency</option>
                                <option value="12.0 - Manage External Relationships">12.0 - Manage External Relationships</option>
                                <option value="13.0 - Develop and Manage Business Capabilities">13.0 - Develop and Manage Business Capabilities</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description *</label>
                            <textarea id="gen_description" required rows="3" placeholder="Describe the end-to-end workflow..."
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                        </div>
                    </div>

                    <!-- Workflow Configuration -->
                    <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #27ae60;">Workflow Configuration</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Orchestration Pattern *</label>
                                <select id="gen_pattern" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <option value="sequential">Sequential</option>
                                    <option value="parallel">Parallel</option>
                                    <option value="conditional">Conditional</option>
                                    <option value="hybrid">Hybrid</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Number of Steps *</label>
                                <input type="number" id="gen_steps" required min="1" max="20" value="5"
                                    onchange="generateStepFields()"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Est. Duration (seconds)</label>
                                <input type="number" id="gen_duration" min="60" value="3600"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Compliance Frameworks</label>
                                <input type="text" id="gen_compliance" placeholder="SOX, GDPR, ISO27001 (comma-separated)"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Data Retention (days)</label>
                                <input type="number" id="gen_retention" min="30" value="365"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                    </div>

                    <!-- Workflow Steps -->
                    <div style="background: rgba(155, 89, 182, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #9b59b6;">Workflow Steps</h4>
                        <div id="stepFieldsContainer">
                            <!-- Dynamic step fields will be generated here -->
                        </div>
                        <button type="button" onclick="addStepField()"
                            style="margin-top: 10px; padding: 8px 15px; background: #9b59b6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            + Add Step
                        </button>
                    </div>

                    <!-- KPIs -->
                    <div style="background: rgba(241, 196, 15, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #f39c12;">Key Performance Indicators</h4>
                        <div id="kpiFieldsContainer">
                            <div class="kpi-field" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px;">
                                <input type="text" placeholder="Metric name" class="kpi-metric"
                                    style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                <input type="text" placeholder="Target (e.g., < 24 hours)" class="kpi-target"
                                    style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                <input type="text" placeholder="Measurement method" class="kpi-measurement"
                                    style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                <button type="button" onclick="removeKpiField(this)"
                                    style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer;">√ó</button>
                            </div>
                        </div>
                        <button type="button" onclick="addKpiField()"
                            style="margin-top: 10px; padding: 8px 15px; background: #f39c12; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            + Add KPI
                        </button>
                    </div>

                    <!-- Form Actions -->
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" onclick="previewAgentCard()"
                            style="padding: 12px 25px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Preview JSON
                        </button>
                        <button type="submit"
                            style="padding: 12px 25px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            Generate & Save
                        </button>
                        <button type="button" onclick="closeCardGeneratorModal()"
                            style="padding: 12px 25px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </form>

                <!-- Preview Panel -->
                <div id="cardPreviewPanel" style="display: none; margin-top: 20px; background: #2c3e50; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #ecf0f1;">JSON Preview</h4>
                        <button onclick="copyCardJson()"
                            style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            Copy to Clipboard
                        </button>
                    </div>
                    <pre id="cardJsonPreview" style="background: #1a252f; color: #2ecc71; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 12px; max-height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>
    </div>

        <!-- Platform Admin Tab (V2 Real Implementations) -->
        <div id="tab-platform" class="tab-content">
            <div class="main-content">
                <h2 style="margin-bottom: 20px;">‚ö° Platform Admin - Real Database Operations</h2>
                <p style="color: #666; margin-bottom: 25px;">These features use the V2 API with real database persistence, authentication, and AI integration.</p>

                <!-- V2 Status Banner -->
                <div id="v2StatusBanner" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <strong>V2 API Status:</strong> <span id="v2ApiStatus">Checking...</span>
                        </div>
                        <div id="v2Stats" style="display: flex; gap: 20px; flex-wrap: wrap;"></div>
                    </div>
                </div>

                <!-- Platform Admin Sections -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">

                    <!-- Authentication Section -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">üîê Authentication</h3>
                        <div id="authSection">
                            <div id="loginForm">
                                <input type="email" id="v2LoginEmail" placeholder="Email" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                                <input type="password" id="v2LoginPassword" placeholder="Password" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                                <button onclick="v2Login()" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Login</button>
                                <p style="margin-top: 10px; font-size: 12px; color: #64748b;">Or create a new user below</p>
                            </div>
                            <div id="v2AuthResult" style="margin-top: 10px;"></div>
                        </div>
                    </div>

                    <!-- Organization Management -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">üè¢ Organizations</h3>
                        <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="v2OrgName" placeholder="Organization name" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <input type="text" id="v2OrgSlug" placeholder="URL slug (optional)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <button onclick="v2CreateOrg()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">Create Organization</button>
                        </div>
                        <div id="v2OrgResult" style="margin-top: 10px;"></div>
                    </div>

                    <!-- User Management -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">üë• Users</h3>
                        <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                            <input type="email" id="v2UserEmail" placeholder="Email" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <input type="password" id="v2UserPassword" placeholder="Password" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <input type="text" id="v2UserOrgId" placeholder="Organization ID (optional)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <button onclick="v2CreateUser()" style="padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Create User</button>
                        </div>
                        <div id="v2UserResult" style="margin-top: 10px;"></div>
                    </div>

                    <!-- API Keys -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">üîë API Keys</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="v2ApiKeyName" placeholder="Key name" style="flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <button onclick="v2CreateApiKey()" style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">Generate Key</button>
                        </div>
                        <div id="v2ApiKeyResult" style="margin-top: 10px;"></div>
                    </div>

                    <!-- AI Chat (Real) -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; grid-column: span 2;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">ü§ñ AI Chat (Real API Calls)</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <select id="v2AiProvider" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                                <option value="openai">OpenAI (GPT-4)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                            </select>
                            <button onclick="v2CreateConversation()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">New Conversation</button>
                        </div>
                        <div id="v2AiResult" style="height: 300px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="v2AiMessage" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px;" disabled onkeypress="if(event.key==='Enter')v2SendMessage()">
                            <button id="v2AiSendBtn" onclick="v2SendMessage()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" disabled>Send</button>
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; color: #64748b;">Start a new conversation to enable chat</p>
                    </div>

                    <!-- Webhooks -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">üîî Webhooks</h3>
                        <div style="display: grid; gap: 10px; margin-bottom: 15px;">
                            <input type="url" id="v2WebhookUrl" placeholder="https://your-endpoint.com/webhook" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <input type="text" id="v2WebhookEvents" placeholder="Events (e.g., user.created, order.completed)" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <button onclick="v2CreateWebhook()" style="padding: 12px; background: #ec4899; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Create Webhook</button>
                        </div>
                        <div id="v2WebhookResult" style="margin-top: 10px;"></div>
                    </div>

                    <!-- Rate Limiting Test -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">‚è±Ô∏è Rate Limiting</h3>
                        <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">Test the real sliding window rate limiter (100 requests/minute)</p>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="v2RateLimitId" placeholder="User identifier (e.g., user_123)" value="test_user" style="flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            <button onclick="v2CheckRateLimit()" style="padding: 10px 20px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer;">Check Limit</button>
                        </div>
                        <div id="v2RateLimitResult" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentPage = 1;
        const pageSize = 12;
        let allAgents = [];
        let workflowCount = 0;
        let successCount = 0;

        // ========================================
        // APQC HIERARCHY DRILL-DOWN STATE
        // ========================================
        let apqcPath = [];  // Array of {id, name, level} objects representing the drill-down path
        let apqcCurrentItems = [];  // Current level's items

        // Initialize
        async function initialize() {
            await loadStats();
            await loadCategories();
            await loadAllAgents();
            await checkApiHealth();

            // Set default invoice date
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('lineItems').value = JSON.stringify([
                {"desc": "Software License", "qty": 10, "price": 450.00},
                {"desc": "Support Contract", "qty": 1, "price": 500.00}
            ], null, 2);

            // Close quick menu when clicking outside
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('quickActionsMenu');
                const btn = e.target.closest('.dropdown');
                if (!btn && menu) {
                    menu.style.display = 'none';
                }
            });

            // Periodically check API health
            setInterval(checkApiHealth, 60000); // Every 60 seconds
        }

        // Check API health status
        async function checkApiHealth() {
            const dot = document.getElementById('apiHealthDot');
            const text = document.getElementById('apiHealthText');
            const card = document.getElementById('apiHealthCard');

            try {
                const startTime = Date.now();
                const response = await fetch(`${API_URL}/api/health`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                const latency = Date.now() - startTime;

                if (response.ok) {
                    const data = await response.json();
                    dot.style.background = '#27ae60';
                    text.textContent = `${latency}ms`;
                    card.title = `API Healthy - v${data.version || '1.0.0'}\nLatency: ${latency}ms\nClick to refresh`;
                } else {
                    dot.style.background = '#e74c3c';
                    text.textContent = 'Error';
                    card.title = `API returned ${response.status}. Click to retry.`;
                }
            } catch (error) {
                dot.style.background = '#e74c3c';
                text.textContent = 'Offline';
                card.title = `API unreachable: ${error.message}. Click to retry.`;
            }
        }

        // Toggle quick actions menu
        function toggleQuickMenu() {
            const menu = document.getElementById('quickActionsMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            event.stopPropagation();
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'categories') {
                loadCategoryAgents();
            } else if (tabName === 'integrations') {
                loadIntegrations();
            } else if (tabName === 'ai') {
                loadAITab();
            } else if (tabName === 'orchestration') {
                loadOrchestrationTab();
            } else if (tabName === 'execute') {
                loadExecuteTab();
            } else if (tabName === 'bpmn') {
                loadBpmnFiles();
            } else if (tabName === 'agentcards') {
                loadAgentCards();
            } else if (tabName === 'metrics') {
                loadMetricsTab();
            }
        }

        // Load Metrics Tab
        async function loadMetricsTab() {
            try {
                // Check status first
                const statusRes = await fetch(`${API_URL}/api/metrics/status`);
                const status = await statusRes.json();

                if (!status.available) {
                    document.getElementById('metricsStatus').innerHTML = '<span style="color: #e74c3c;">‚ö†Ô∏è Metrics service not available</span>';
                    return;
                }

                // Load dashboard metrics
                const dashRes = await fetch(`${API_URL}/api/metrics/dashboard`);
                if (dashRes.ok) {
                    const data = await dashRes.json();

                    // Update stat cards
                    document.getElementById('metricsAgentExecutions').textContent = data.total_agent_executions || 0;
                    document.getElementById('metricsAICalls').textContent = data.total_ai_calls || 0;
                    document.getElementById('metricsOrchestrations').textContent = data.total_orchestrations || 0;
                    document.getElementById('metricsErrors').textContent = data.total_errors || 0;
                }

                // Load series list
                const seriesRes = await fetch(`${API_URL}/api/metrics/series`);
                if (seriesRes.ok) {
                    const seriesData = await seriesRes.json();
                    const seriesHtml = seriesData.series.map(s => `
                        <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #333;">${s.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                                <div style="font-size: 0.85em; color: #888;">${s.total_points} data points</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: #667eea;">${s.recent_stats?.count || 0}</div>
                                <div style="font-size: 0.8em; color: #888;">last hour</div>
                            </div>
                        </div>
                    `).join('') || '<div style="padding: 20px; color: #888; text-align: center;">No series data</div>';
                    document.getElementById('metricSeriesList').innerHTML = seriesHtml;
                }

                // Load events
                const eventsRes = await fetch(`${API_URL}/api/metrics/events?limit=20`);
                if (eventsRes.ok) {
                    const eventsData = await eventsRes.json();
                    const eventsHtml = eventsData.events.length > 0
                        ? eventsData.events.slice().reverse().map(e => `
                            <div style="padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 500; color: #333;">${e.event || e.name || 'Event'}</span>
                                    <span style="color: #888; font-size: 0.85em;">${new Date(e.timestamp).toLocaleTimeString()}</span>
                                </div>
                                ${e.details ? `<div style="color: #666; font-size: 0.85em; margin-top: 4px;">${e.details}</div>` : ''}
                            </div>
                        `).join('')
                        : '<div style="padding: 20px; color: #888; text-align: center;">No recent events</div>';
                    document.getElementById('metricsEventsList').innerHTML = eventsHtml;
                }

                // Load counters
                const countersRes = await fetch(`${API_URL}/api/metrics/counters`);
                if (countersRes.ok) {
                    const countersData = await countersRes.json();
                    const counters = Object.entries(countersData.counters || {});
                    const countersHtml = counters.length > 0
                        ? counters.map(([name, value]) => `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #333;">${value}</div>
                                <div style="font-size: 0.85em; color: #666;">${name.replace(/_/g, ' ')}</div>
                            </div>
                        `).join('')
                        : '<div style="padding: 20px; color: #888; text-align: center; grid-column: 1 / -1;">No counters recorded yet</div>';
                    document.getElementById('metricsCountersList').innerHTML = countersHtml;
                }

                document.getElementById('metricsStatus').innerHTML = `<span style="color: #27ae60;">‚úì Last updated: ${new Date().toLocaleTimeString()}</span>`;

            } catch (error) {
                console.error('Error loading metrics:', error);
                document.getElementById('metricsStatus').innerHTML = `<span style="color: #e74c3c;">Error loading metrics: ${error.message}</span>`;
            }
        }

        // Selected composite state
        let selectedCompositeData = null;

        // Load Orchestration Tab
        async function loadOrchestrationTab() {
            await Promise.all([
                loadOrchestrationStatus(),
                loadCompositesList(),
                loadRecentOrchestrations()
            ]);
        }

        // Load Orchestration Status
        async function loadOrchestrationStatus() {
            try {
                const response = await fetch(`${API_URL}/api/orchestration/status`);
                const data = await response.json();

                const statusHtml = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: ${data.available ? '#d1fae5' : '#fee2e2'}; padding: 12px; border-radius: 8px;">
                            <strong>Engine:</strong> ${data.available ? '‚úÖ Available' : '‚ùå Unavailable'}
                        </div>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px;">
                            <strong>Active:</strong> ${data.active_executions || 0} running
                        </div>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px;">
                            <strong>Total:</strong> ${data.total_executions || 0} executions
                        </div>
                    </div>
                `;
                document.getElementById('orchestrationStatusContent').innerHTML = statusHtml;
            } catch (error) {
                document.getElementById('orchestrationStatusContent').innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }

        // Load Composites List
        async function loadCompositesList() {
            try {
                const response = await fetch(`${API_URL}/api/orchestration/composites`);
                const data = await response.json();

                let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

                // Group by level
                const level1 = data.composites.filter(c => c.level === 1);
                const level2 = data.composites.filter(c => c.level === 2);

                html += '<div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Level 1 Categories (${level1.length})</div>';
                for (const comp of level1) {
                    html += `
                        <div onclick="selectComposite(${comp.level}, '${comp.id}', '${comp.name.replace(/'/g, "\\'")}', ${comp.child_agents})"
                             style="background: #f8f9fa; padding: 12px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                             onmouseover="this.style.borderColor='#10b981'" onmouseout="this.style.borderColor='transparent'"
                             id="comp-${comp.level}-${comp.id}">
                            <strong style="color: #374151;">${comp.id}. ${comp.name}</strong>
                            <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 8px;">${comp.child_agents} agents</span>
                        </div>
                    `;
                }

                if (level2.length > 0) {
                    html += '<div style="font-weight: 600; color: #374151; margin: 15px 0 5px;">Level 2 Processes (${level2.length})</div>';
                    for (const comp of level2.slice(0, 10)) {
                        html += `
                            <div onclick="selectComposite(${comp.level}, '${comp.id}', '${comp.name.replace(/'/g, "\\'")}', ${comp.child_agents})"
                                 style="background: #f0f9ff; padding: 10px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; font-size: 0.9em;"
                                 onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='transparent'"
                                 id="comp-${comp.level}-${comp.id}">
                                <strong>${comp.id}</strong> - ${comp.name}
                                <span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75em; margin-left: 5px;">${comp.child_agents}</span>
                            </div>
                        `;
                    }
                    if (level2.length > 10) {
                        html += `<p style="color: #666; font-size: 0.85em; text-align: center;">...and ${level2.length - 10} more Level 2 composites</p>`;
                    }
                }

                html += '</div>';
                document.getElementById('compositesListContent').innerHTML = html;
            } catch (error) {
                document.getElementById('compositesListContent').innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }

        // Select Composite
        function selectComposite(level, id, name, childCount) {
            selectedCompositeData = { level, id, name, childCount };
            document.getElementById('selectedComposite').value = `Level ${level}: ${id} - ${name} (${childCount} agents)`;

            // Highlight selected
            document.querySelectorAll('[id^="comp-"]').forEach(el => el.style.borderColor = 'transparent');
            document.getElementById(`comp-${level}-${id}`).style.borderColor = '#10b981';
        }

        // Execute Composite
        async function executeComposite() {
            if (!selectedCompositeData) {
                alert('Please select a composite agent first');
                return;
            }

            const resultsDiv = document.getElementById('orchestrationResults');
            resultsDiv.innerHTML = '<div class="spinner"></div><p style="text-align: center; color: #666;">Executing workflow...</p>';

            try {
                const maxAgents = parseInt(document.getElementById('maxAgents').value) || 5;
                let inputData = {};
                try {
                    inputData = JSON.parse(document.getElementById('orchestrationInput').value || '{}');
                } catch (e) {
                    inputData = {};
                }

                const response = await fetch(`${API_URL}/api/orchestration/composite/${selectedCompositeData.level}/${selectedCompositeData.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        composite_level: selectedCompositeData.level,
                        composite_id: selectedCompositeData.id,
                        input_data: inputData,
                        max_agents: maxAgents
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const exec = data.execution;
                    const resultHtml = `
                        <div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>‚úÖ ${exec.status}</strong>
                            <span style="float: right; font-size: 0.85em; color: #666;">ID: ${exec.execution_id}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="background: #f3f4f6; padding: 10px; border-radius: 6px;">
                                <strong>Steps:</strong> ${exec.steps_completed}/${exec.steps_total}
                            </div>
                            <div style="background: #f3f4f6; padding: 10px; border-radius: 6px;">
                                <strong>Duration:</strong> ${exec.duration_ms ? (exec.duration_ms/1000).toFixed(2) + 's' : 'N/A'}
                            </div>
                        </div>
                        ${exec.ai_orchestration?.summary ? `
                            <div style="background: #e0e7ff; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                <strong>ü§ñ AI Summary:</strong><br>
                                ${exec.ai_orchestration.summary.summary || 'N/A'}
                            </div>
                        ` : ''}
                        <div>
                            <strong>Steps:</strong>
                            <div style="max-height: 150px; overflow-y: auto; margin-top: 8px;">
                                ${exec.steps.map((s, i) => `
                                    <div style="background: ${s.status === 'completed' ? '#d1fae5' : s.status === 'failed' ? '#fee2e2' : '#f3f4f6'}; padding: 8px; border-radius: 4px; margin-bottom: 4px; font-size: 0.85em;">
                                        ${i+1}. ${s.agent_name} - ${s.status} ${s.duration_ms ? '(' + s.duration_ms.toFixed(0) + 'ms)' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    resultsDiv.innerHTML = resultHtml;

                    // Reload recent executions
                    loadRecentOrchestrations();
                } else {
                    resultsDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${data.detail || 'Execution failed'}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${error.message}</p>`;
            }
        }

        // Load Recent Orchestrations
        async function loadRecentOrchestrations() {
            try {
                const response = await fetch(`${API_URL}/api/orchestration/executions?limit=5`);
                const data = await response.json();

                if (data.executions.length === 0) {
                    document.getElementById('recentOrchestrations').innerHTML = '<p style="color: #666; text-align: center;">No executions yet</p>';
                    return;
                }

                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                for (const exec of data.executions) {
                    const statusColor = exec.status === 'completed' ? '#10b981' : exec.status === 'failed' ? '#ef4444' : '#f59e0b';
                    html += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${exec.workflow_name}</strong>
                                <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">${exec.status}</span>
                            </div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                                ${exec.steps_completed}/${exec.steps_total} steps ‚Ä¢ ${exec.duration_ms ? (exec.duration_ms/1000).toFixed(2) + 's' : 'N/A'} ‚Ä¢ ${new Date(exec.created_at).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                document.getElementById('recentOrchestrations').innerHTML = html;
            } catch (error) {
                document.getElementById('recentOrchestrations').innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }

        // Load AI Processing Tab
        async function loadAITab() {
            await Promise.all([
                loadAIStatus(),
                loadAIAgents()
            ]);
        }

        // Load AI Status
        async function loadAIStatus() {
            try {
                const response = await fetch(`${API_URL}/api/ai/status`);
                const data = await response.json();

                const statusHtml = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: ${data.available ? '#d1fae5' : '#fee2e2'}; padding: 12px; border-radius: 8px;">
                            <strong>Status:</strong> ${data.available ? '‚úÖ Available' : '‚ùå Unavailable'}
                        </div>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px;">
                            <strong>Version:</strong> ${data.version || 'N/A'}
                        </div>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px;">
                            <strong>AI Agents:</strong> ${data.smart_agents_count || 0}
                        </div>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px;">
                            <strong>Providers:</strong> ${(data.ai_providers || []).join(', ')}
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>Capabilities:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${(data.capabilities || []).map(c => `<span style="background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">${c}</span>`).join('')}
                        </div>
                    </div>
                `;
                document.getElementById('aiStatusContent').innerHTML = statusHtml;
            } catch (error) {
                document.getElementById('aiStatusContent').innerHTML = `<p style="color: #ef4444;">Error loading AI status: ${error.message}</p>`;
            }
        }

        // Load AI Agents List
        async function loadAIAgents() {
            try {
                const response = await fetch(`${API_URL}/api/ai/agents`);
                const data = await response.json();

                // Group by domain folder
                const byDomain = {};
                data.ai_powered_agents.forEach(agent => {
                    const domain = agent.domain_folder;
                    if (!byDomain[domain]) byDomain[domain] = [];
                    byDomain[domain].push(agent);
                });

                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                for (const [domain, agents] of Object.entries(byDomain)) {
                    html += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <strong style="color: #374151; text-transform: capitalize;">${domain}</strong>
                            <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 8px;">${agents.length}</span>
                            <ul style="margin-top: 8px; padding-left: 20px; font-size: 0.85em; color: #6b7280;">
                                ${agents.slice(0, 3).map(a => `<li>${a.class_name}</li>`).join('')}
                                ${agents.length > 3 ? `<li style="color: #9ca3af;">...and ${agents.length - 3} more</li>` : ''}
                            </ul>
                        </div>
                    `;
                }
                html += '</div>';

                document.getElementById('aiAgentsContent').innerHTML = html;
            } catch (error) {
                document.getElementById('aiAgentsContent').innerHTML = `<p style="color: #ef4444;">Error loading AI agents: ${error.message}</p>`;
            }
        }

        // Run AI Demo
        async function runAIDemo(domain) {
            const resultsDiv = document.getElementById('aiDemoResults');
            resultsDiv.innerHTML = '<div class="spinner"></div><p style="text-align: center; color: #666;">Running demo...</p>';

            try {
                const response = await fetch(`${API_URL}/api/ai/demo/${domain}`, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    const resultHtml = `
                        <div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>‚úÖ ${data.domain} Demo Completed</strong>
                            <span style="float: right; color: #666; font-size: 0.85em;">${new Date(data.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Scenario:</strong> ${data.demo_scenario}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Input Data:</strong>
                            <pre style="background: #f3f4f6; padding: 10px; border-radius: 6px; font-size: 0.85em; overflow-x: auto; max-height: 150px;">${JSON.stringify(data.input_data, null, 2)}</pre>
                        </div>
                        <div>
                            <strong>Result:</strong>
                            <pre style="background: #f3f4f6; padding: 10px; border-radius: 6px; font-size: 0.85em; overflow-x: auto; max-height: 200px;">${JSON.stringify(data.result, null, 2)}</pre>
                        </div>
                    `;
                    resultsDiv.innerHTML = resultHtml;
                } else {
                    resultsDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${data.detail || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${error.message}</p>`;
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const [stats, workflows] = await Promise.all([
                    fetch(`${API_URL}/api/agents/stats/overview`).then(r => r.json()),
                    fetch(`${API_URL}/api/admin/workflows/all`).then(r => r.json()).catch(() => [])
                ]);

                document.getElementById('totalAgents').textContent = stats.total_agents;
                document.getElementById('totalCategories').textContent = stats.total_categories;
                document.getElementById('totalWorkflows').textContent = workflows.length;

                if (workflows.length > 0) {
                    const successful = workflows.filter(w => w.success).length;
                    const rate = ((successful / workflows.length) * 100).toFixed(0);
                    document.getElementById('successRate').textContent = rate + '%';
                } else {
                    document.getElementById('successRate').textContent = '-';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load all agents
        async function loadAllAgents() {
            const container = document.getElementById('agentsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_URL}/api/agents?limit=1500`);
                if (!response.ok) throw new Error('API error');

                allAgents = await response.json();

                if (!allAgents || allAgents.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No agents loaded</h3></div>';
                    return;
                }

                displayAgents(allAgents, 1);
            } catch (error) {
                console.error('Error loading agents:', error);
                container.innerHTML = `<div class="empty-state"><h3>Failed to load agents</h3><p>${error.message}</p></div>`;
            }
        }

        // Display agents in grid
        function displayAgents(agents, page = 1) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            const paginated = agents.slice(start, end);

            if (paginated.length === 0) {
                document.getElementById('agentsContainer').innerHTML = '<div class="empty-state"><h3>No agents found</h3></div>';
                document.getElementById('agentsPagination').innerHTML = '';
                return;
            }

            document.getElementById('agentsContainer').innerHTML = paginated.map(agent => `
                <div class="agent-card">
                    <h4>${agent.name}</h4>
                    <div class="id">${agent.agent_id}</div>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">${agent.description || 'No description'}</p>
                    <div class="category">${agent.apqc_category}</div>
                    <button class="action-btn" onclick="showAgentDetails('${agent.agent_id}')">View Details</button>
                </div>
            `).join('');

            renderPagination(agents.length, page);
        }

        // Render pagination
        function renderPagination(total, current) {
            const totalPages = Math.ceil(total / pageSize);
            let html = '';

            if (totalPages > 1) {
                if (current > 1) html += `<button onclick="displayAgents(allAgents, ${current - 1})">‚Üê Prev</button>`;

                for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                    html += `<button ${i === current ? 'class="active"' : ''} onclick="displayAgents(allAgents, ${i})">${i}</button>`;
                }

                if (current < totalPages) html += `<button onclick="displayAgents(allAgents, ${current + 1})">Next ‚Üí</button>`;
            }

            document.getElementById('agentsPagination').innerHTML = html;
        }

        // Search agents with wildcard support
        async function searchAgents() {
            const query = document.getElementById('agentSearch').value.trim();
            const category = document.getElementById('categoryFilter').value.trim();

            try {
                let url = `${API_URL}/api/agents?limit=1500`;

                // Add search with wildcard support (* and ?)
                if (query) {
                    url += `&search=${encodeURIComponent(query)}`;
                }

                // Add category filter
                if (category) {
                    url += `&category=${encodeURIComponent(category)}`;
                }

                const response = await fetch(url);
                const agents = await response.json();

                if (!agents || agents.length === 0) {
                    allAgents = [];
                    document.getElementById('agentsContainer').innerHTML = '<div class="empty-state"><h3>No agents found matching your criteria</h3><p>Try adjusting your search or category filter</p></div>';
                    document.getElementById('agentsPagination').innerHTML = '';
                    return;
                }

                allAgents = agents;
                displayAgents(agents, 1);
            } catch (error) {
                console.error('Error searching agents:', error);
                document.getElementById('agentsContainer').innerHTML = `<div class="empty-state"><h3>Error searching agents</h3><p>${error.message}</p></div>`;
            }
        }

        // Reset search
        function resetSearch() {
            document.getElementById('agentSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            loadAllAgents();
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/api/agents/categories/list`);
                const categories = await response.json();

                const select = document.getElementById('categoryFilter');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category;
                    option.textContent = `${cat.category} (${cat.count})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // ========================================
        // APQC HIERARCHY DRILL-DOWN FUNCTIONS
        // ========================================

        // Load APQC items for current level (using new hierarchy endpoint)
        async function loadApqcLevel() {
            const container = document.getElementById('apqcCardsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const currentLevel = apqcPath.length + 1;
                const parentCode = apqcPath.length > 0 ? apqcPath[apqcPath.length - 1].code : null;

                // Use the new hierarchy endpoint
                let url = `${API_URL}/api/apqc/hierarchy?level=${currentLevel}`;
                if (parentCode) {
                    url += `&parent_code=${encodeURIComponent(parentCode)}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                apqcCurrentItems = data.items || [];
                renderApqcCards();
                updateApqcBreadcrumb();
            } catch (error) {
                console.error('Error loading APQC level:', error);
                container.innerHTML = `<div class="empty-state"><h3>Error loading items</h3><p>${error.message}</p></div>`;
            }
        }

        // Render cards for current level
        function renderApqcCards() {
            const container = document.getElementById('apqcCardsContainer');
            const countEl = document.getElementById('apqcItemCount');

            if (apqcCurrentItems.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No items at this level</h3><p>Try navigating back up.</p></div>';
                countEl.textContent = '';
                return;
            }

            // Category colors and icons
            const levelColors = ['#667eea', '#56ab2f', '#ff6b6b', '#feca57', '#48dbfb'];
            const currentLevel = apqcPath.length + 1;
            const color = levelColors[(currentLevel - 1) % levelColors.length];

            const html = apqcCurrentItems.map(item => {
                const hasChildren = item.children_count > 0;
                const isActivity = item.type === 'activity' && item.children_count === 0;
                const icon = item.icon || ['üéØ', 'üìÇ', 'üìã', 'üìÑ', '‚öôÔ∏è'][currentLevel - 1] || 'üìÅ';
                const itemCode = item.code || item.id;

                // Check if BPMN is available (Level 2 & 3 items with 2 or 3-part codes like "1.1" or "1.1.1")
                const codeParts = itemCode.split('.');
                const hasBpmn = (codeParts.length === 2 || codeParts.length === 3) && !codeParts.includes('0');
                const escapedName = item.name.replace(/'/g, "\\'");

                return `
                    <div class="category-card" onclick="${hasChildren ? `drillDown('${itemCode}', '${escapedName}')` : `showApqcItemDetails('${itemCode}', '${escapedName}', '${item.type}')`}"
                         style="border-color: ${item.color || color}30; transition: all 0.3s ease;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.8em;">${icon}</span>
                            <div style="flex: 1;">
                                <h4 style="color: ${item.color || color}; font-size: 1em; margin: 0;">${item.name}</h4>
                                <span style="font-size: 0.75em; color: #999; font-family: monospace;">${itemCode}</span>
                            </div>
                            ${hasBpmn ? `<span style="background: #43e97b20; color: #2d8a4e; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600;">BPMN</span>` : ''}
                        </div>
                        <p style="color: #666; font-size: 0.85em; margin-bottom: 12px; line-height: 1.4;">${item.description || `APQC ${item.type?.replace('_', ' ') || 'item'}`}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                            ${hasChildren ? `<span style="background: ${item.color || color}20; color: ${item.color || color}; padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600;">${item.children_count} sub-items</span>` : `<span style="background: #f0f0f0; color: #666; padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">Leaf item</span>`}
                            <div style="display: flex; gap: 8px;">
                                ${hasBpmn ? `<button class="btn-bpmn" onclick="event.stopPropagation(); viewBpmn('${itemCode}', '${escapedName}')">View BPMN</button>` : ''}
                                <button class="btn" style="padding: 8px 16px; font-size: 0.85em;">
                                    ${hasChildren ? 'Drill Down ‚Üí' : 'View Details'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            countEl.textContent = `Showing ${apqcCurrentItems.length} items at Level ${currentLevel}`;
        }

        // Drill down into an item
        function drillDown(itemCode, itemName) {
            const currentLevel = apqcPath.length + 1;
            apqcPath.push({
                id: itemCode,
                code: itemCode,
                name: itemName,
                level: currentLevel
            });
            loadApqcLevel();
        }

        // Navigate to a specific level in the breadcrumb
        function drillToLevel(targetIndex) {
            // targetIndex 0 = root (all categories)
            apqcPath = apqcPath.slice(0, targetIndex);
            loadApqcLevel();
        }

        // Update breadcrumb navigation
        function updateApqcBreadcrumb() {
            const breadcrumb = document.getElementById('apqcBreadcrumb');

            let html = '<span style="font-weight: 600; color: #667eea;">üìç Path:</span>';

            // Root (always present)
            const isAtRoot = apqcPath.length === 0;
            html += `<button onclick="drillToLevel(0)" style="background: ${isAtRoot ? '#667eea' : '#f0f0f0'}; color: ${isAtRoot ? 'white' : '#667eea'}; border: none; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 500; transition: all 0.2s;">üè† All Categories</button>`;

            // Path items
            apqcPath.forEach((item, index) => {
                const isLast = index === apqcPath.length - 1;
                html += `<span style="color: #999;">‚Ä∫</span>`;
                html += `<button onclick="drillToLevel(${index + 1})" style="background: ${isLast ? '#667eea' : '#f0f0f0'}; color: ${isLast ? 'white' : '#667eea'}; border: none; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 500; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: all 0.2s;" title="${item.name}">${item.name.length > 25 ? item.name.substring(0, 25) + '...' : item.name}</button>`;
            });

            // Back button if not at root
            if (apqcPath.length > 0) {
                html += `<button onclick="drillToLevel(${apqcPath.length - 1})" style="background: #ff6b6b; color: white; border: none; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 500; margin-left: auto;">‚Üê Back</button>`;
            }

            breadcrumb.innerHTML = html;
        }

        // Show details for a leaf APQC item
        function showApqcItemDetails(code, name, type) {
            const html = `
                <div class="detail-item">
                    <label>APQC Code</label>
                    <div class="value" style="font-family: monospace; font-size: 1.1em;">${code}</div>
                </div>
                <div class="detail-item">
                    <label>Name</label>
                    <div class="value">${name}</div>
                </div>
                <div class="detail-item">
                    <label>Type</label>
                    <div class="value">${type ? type.replace('_', ' ').charAt(0).toUpperCase() + type.replace('_', ' ').slice(1) : 'Activity'}</div>
                </div>
                <div class="detail-item">
                    <label>Hierarchy Level</label>
                    <div class="value">Level ${code.split('.').length} (${['Category', 'Process Group', 'Process', 'Activity', 'Task'][code.split('.').length - 1] || 'Item'})</div>
                </div>
                <div class="detail-item">
                    <label>Full Path</label>
                    <div class="value">${apqcPath.map(p => p.name).join(' ‚Üí ')}${apqcPath.length > 0 ? ' ‚Üí ' : ''}${name}</div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea15, #764ba215); border-radius: 10px;">
                    <p style="margin: 0; color: #667eea; font-weight: 600;">üí° This is a leaf-level APQC PCF item</p>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">This represents an atomic business activity from the APQC Process Classification Framework.</p>
                </div>
            `;
            document.getElementById('modalBody').innerHTML = html;
            document.querySelector('.modal-header h2').textContent = 'APQC Item Details';
            document.getElementById('agentModal').classList.add('active');
        }

        // ========================================
        // BPMN BROWSER FUNCTIONS
        // ========================================

        let allBpmnFiles = [];
        let filteredBpmnFiles = [];

        // Load all BPMN files for the browser tab
        async function loadBpmnFiles() {
            const grid = document.getElementById('bpmnFilesGrid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_URL}/api/apqc/bpmn-list`);
                if (!response.ok) throw new Error('Failed to load BPMN list');

                const data = await response.json();
                allBpmnFiles = data.bpmn_files || [];
                filteredBpmnFiles = [...allBpmnFiles];

                // Update stats
                document.getElementById('bpmnTotalCount').textContent = data.total || 0;
                document.getElementById('bpmnLevel2Count').textContent = data.level_2_count || 0;
                document.getElementById('bpmnLevel3Count').textContent = data.level_3_count || 0;

                renderBpmnGrid();
            } catch (error) {
                console.error('Error loading BPMN files:', error);
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                        <span style="font-size: 3em; display: block; margin-bottom: 15px;">‚ö†Ô∏è</span>
                        <p style="font-size: 1.1em;">Unable to load BPMN files</p>
                        <p style="font-size: 0.9em;">${error.message}</p>
                        <button class="btn" onclick="loadBpmnFiles()" style="margin-top: 15px;">Retry</button>
                    </div>
                `;
            }
        }

        // Render the BPMN files grid
        function renderBpmnGrid() {
            const grid = document.getElementById('bpmnFilesGrid');
            const countEl = document.getElementById('bpmnResultsCount');

            if (filteredBpmnFiles.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                        <span style="font-size: 3em; display: block; margin-bottom: 15px;">üìÇ</span>
                        <p style="font-size: 1.1em;">No BPMN files found</p>
                        <p style="font-size: 0.9em;">Try adjusting your search or filter criteria</p>
                    </div>
                `;
                countEl.textContent = '';
                return;
            }

            const cards = filteredBpmnFiles.map(file => {
                const levelColor = file.level === 2 ? '#27ae60' : '#3498db';
                const levelBg = file.level === 2 ? '#27ae6015' : '#3498db15';
                const levelIcon = file.level === 2 ? 'üìÅ' : 'üìÑ';

                return `
                    <div class="bpmn-file-card" style="background: white; border: 2px solid #f0f0f0; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease;"
                         onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.2)';"
                         onmouseout="this.style.borderColor='#f0f0f0'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                         onclick="viewBpmn('${file.apqc_code}', '${file.level_name}: ${file.apqc_code}')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="font-size: 2em;">${levelIcon}</div>
                            <span style="background: ${levelBg}; color: ${levelColor}; padding: 4px 12px; border-radius: 15px; font-size: 0.75em; font-weight: 600;">
                                Level ${file.level}
                            </span>
                        </div>
                        <div style="font-size: 1.4em; font-weight: 600; color: #667eea; margin-bottom: 8px; font-family: monospace;">
                            ${file.apqc_code}
                        </div>
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 12px;">
                            ${file.level_name}
                        </div>
                        <div style="font-size: 0.8em; color: #999; font-family: monospace; background: #f8f9fa; padding: 6px 10px; border-radius: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${file.filename}
                        </div>
                        <button class="btn" style="width: 100%; margin-top: 12px; padding: 10px;" onclick="event.stopPropagation(); viewBpmn('${file.apqc_code}', '${file.level_name}: ${file.apqc_code}')">
                            üìä View Diagram
                        </button>
                    </div>
                `;
            }).join('');

            grid.innerHTML = cards;
            countEl.textContent = `Showing ${filteredBpmnFiles.length} of ${allBpmnFiles.length} BPMN files`;
        }

        // Filter BPMN files based on search and level filter
        function filterBpmnList() {
            const searchTerm = document.getElementById('bpmnSearchInput').value.toLowerCase().trim();
            const levelFilter = document.getElementById('bpmnLevelFilter').value;

            filteredBpmnFiles = allBpmnFiles.filter(file => {
                // Level filter
                if (levelFilter && file.level !== parseInt(levelFilter)) {
                    return false;
                }

                // Search filter (by APQC code)
                if (searchTerm) {
                    if (!file.apqc_code.toLowerCase().includes(searchTerm)) {
                        return false;
                    }
                }

                return true;
            });

            renderBpmnGrid();
        }

        // Reset BPMN filters
        function resetBpmnFilter() {
            document.getElementById('bpmnSearchInput').value = '';
            document.getElementById('bpmnLevelFilter').value = '';
            filteredBpmnFiles = [...allBpmnFiles];
            renderBpmnGrid();
        }

        // ========================================
        // BPMN VIEWER FUNCTIONS (with Standard BPMN 2.0 Rendering)
        // ========================================

        let currentBpmnXml = null;
        let currentBpmnCode = null;
        let bpmnViewer = null;
        let currentZoom = 1;

        // View BPMN diagram for an APQC code
        async function viewBpmn(code, name) {
            const modal = document.getElementById('bpmnModal');
            const statusEl = document.getElementById('bpmnStatus');

            // Update modal info
            document.getElementById('bpmnApqcCode').textContent = code;
            document.getElementById('bpmnProcessName').textContent = name;
            document.getElementById('bpmnModalTitle').textContent = `BPMN: ${code} - ${name.substring(0, 50)}${name.length > 50 ? '...' : ''}`;

            // Reset to standard view tab
            switchBpmnTab('standard');

            // Show modal with loading state
            modal.classList.add('active');
            statusEl.textContent = 'Loading BPMN...';

            try {
                // Fetch the BPMN XML
                const response = await fetch(`${API_URL}/api/apqc/bpmn/${code}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`No BPMN file found for ${code}`);
                    }
                    throw new Error(`Failed to load BPMN: ${response.status}`);
                }

                const bpmnXml = await response.text();
                currentBpmnXml = bpmnXml;
                currentBpmnCode = code;

                // Display the XML
                document.getElementById('bpmnXmlContainer').value = bpmnXml;

                // Render the standard BPMN diagram
                await renderStandardBpmn(bpmnXml);

                // Also render the simple flow view
                renderSimpleFlowDiagram(bpmnXml);

                statusEl.textContent = 'Loaded successfully';
            } catch (error) {
                console.error('Error loading BPMN:', error);
                statusEl.textContent = `Error: ${error.message}`;
                document.getElementById('bpmnXmlContainer').value = `Error loading BPMN:\n${error.message}`;
                document.getElementById('bpmnStandardCanvas').innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <span style="font-size: 3em; margin-bottom: 10px;">‚ö†Ô∏è</span>
                        <p style="font-size: 1.1em;">Error loading BPMN diagram</p>
                        <p style="font-size: 0.9em;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Render Standard BPMN 2.0 diagram using bpmn-js Modeler (interactive/draggable)
        async function renderStandardBpmn(bpmnXml) {
            const container = document.getElementById('bpmnStandardCanvas');
            container.innerHTML = ''; // Clear previous

            try {
                // Check if BpmnJS Modeler is available
                if (typeof BpmnJS === 'undefined') {
                    throw new Error('BPMN.js Modeler library not loaded');
                }

                // Destroy previous modeler if exists
                if (bpmnViewer) {
                    bpmnViewer.destroy();
                }

                // Create new Modeler (enables drag-and-drop, editing)
                bpmnViewer = new BpmnJS({
                    container: container,
                    keyboard: {
                        bindTo: document
                    }
                });

                // Import the BPMN XML
                await bpmnViewer.importXML(bpmnXml);

                // Fit to viewport
                const canvas = bpmnViewer.get('canvas');
                canvas.zoom('fit-viewport');
                currentZoom = canvas.zoom();

                // Add click handler for call activities (expand sub-process)
                const eventBus = bpmnViewer.get('eventBus');
                eventBus.on('element.dblclick', function(event) {
                    const element = event.element;
                    if (element.type === 'bpmn:CallActivity') {
                        const calledElement = element.businessObject.calledElement;
                        if (calledElement) {
                            // Extract APQC code from calledElement (e.g., "Process_1_1_1_1" -> "1.1.1.1")
                            const match = calledElement.match(/Process_(\d+)_(\d+)_(\d+)(?:_(\d+))?/);
                            if (match) {
                                const subCode = match[4]
                                    ? `${match[1]}.${match[2]}.${match[3]}.${match[4]}`
                                    : `${match[1]}.${match[2]}.${match[3]}`;
                                const subName = element.businessObject.name || `Sub-process ${subCode}`;

                                // Check if sub-process BPMN exists and open it
                                expandSubProcess(subCode, subName);
                            }
                        }
                    }
                });

                console.log('Interactive BPMN Modeler rendered successfully');
            } catch (error) {
                console.error('Error rendering BPMN Modeler:', error);
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #666; padding: 40px;">
                        <span style="font-size: 3em; margin-bottom: 15px;">üìä</span>
                        <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">Interactive Diagram</p>
                        <p style="font-size: 0.9em; color: #999; text-align: center;">
                            ${error.message}<br><br>
                            Try the "Simple Flow View" tab for a fallback visualization,<br>
                            or view the raw XML in the "XML Source" tab.
                        </p>
                    </div>
                `;
            }
        }

        // Expand sub-process - open BPMN for child process
        async function expandSubProcess(code, name) {
            try {
                // Check if BPMN exists for this sub-process
                const checkResponse = await fetch(`${API_URL}/api/apqc/bpmn-check/${code}`);
                const checkData = await checkResponse.json();

                if (checkData.has_bpmn) {
                    // Open the sub-process BPMN
                    viewBpmn(code, name);
                } else {
                    alert(`No BPMN diagram available for sub-process ${code}\n\nThis process has not been expanded to a detailed workflow yet.`);
                }
            } catch (error) {
                console.error('Error checking sub-process:', error);
            }
        }

        // Undo last action
        function bpmnUndo() {
            if (bpmnViewer) {
                try {
                    const commandStack = bpmnViewer.get('commandStack');
                    commandStack.undo();
                } catch (e) {
                    console.error('Undo error:', e);
                }
            }
        }

        // Redo last undone action
        function bpmnRedo() {
            if (bpmnViewer) {
                try {
                    const commandStack = bpmnViewer.get('commandStack');
                    commandStack.redo();
                } catch (e) {
                    console.error('Redo error:', e);
                }
            }
        }

        // Save modified BPMN diagram
        async function saveModifiedBpmn() {
            if (!bpmnViewer || !currentBpmnCode) {
                alert('No diagram loaded to save');
                return;
            }

            try {
                // Export the modified XML
                const { xml } = await bpmnViewer.saveXML({ format: true });
                currentBpmnXml = xml;

                // Update the XML view
                document.getElementById('bpmnXmlContainer').value = xml;

                // Download the modified file
                const blob = new Blob([xml], { type: 'application/xml' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `APQC_${currentBpmnCode.replace(/\./g, '_')}_modified.bpmn`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                document.getElementById('bpmnStatus').textContent = 'Saved! File downloaded.';
            } catch (error) {
                console.error('Save error:', error);
                alert('Error saving diagram: ' + error.message);
            }
        }

        // Load and render Agent Cards for a process
        async function loadAgentCards(apqcCode) {
            const container = document.getElementById('agentCardsContainer');

            if (!apqcCode) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">No APQC code selected</div>';
                return;
            }

            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">Loading agent cards...</div>';

            try {
                const response = await fetch(`${API_URL}/api/agent-cards/${apqcCode}`);

                if (!response.ok) {
                    // Show placeholder for processes without agent cards yet
                    container.innerHTML = renderAgentCardPlaceholder(apqcCode);
                    return;
                }

                const agentCard = await response.json();
                container.innerHTML = renderAgentCardFull(agentCard);

            } catch (error) {
                console.log('Agent card not available:', error);
                container.innerHTML = renderAgentCardPlaceholder(apqcCode);
            }
        }

        // Render placeholder for processes without agent cards
        function renderAgentCardPlaceholder(apqcCode) {
            return `
                <div style="background: linear-gradient(135deg, #667eea10, #764ba210); padding: 30px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 3em; margin-bottom: 15px;">üîß</div>
                    <h3 style="color: #667eea; margin: 0 0 10px 0;">Agent Card Coming Soon</h3>
                    <p style="color: #666; margin: 0 0 20px 0;">
                        The detailed agent card specification for <strong>${apqcCode}</strong> is being developed.
                    </p>
                    <div style="background: white; padding: 20px; border-radius: 10px; text-align: left; max-width: 500px; margin: 0 auto;">
                        <h4 style="color: #333; margin: 0 0 15px 0;">Agent Card includes:</h4>
                        <ul style="color: #555; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Step-by-step workflow definition</li>
                            <li>Input/Output schemas for each step</li>
                            <li>Required API integrations</li>
                            <li>Decision rules and thresholds</li>
                            <li>Error handling specifications</li>
                            <li>Compliance requirements</li>
                        </ul>
                    </div>
                    <p style="color: #999; font-size: 0.85em; margin-top: 20px;">
                        Currently available: 9.2.1.1 (Invoice Processing)
                    </p>
                </div>
            `;
        }

        // Render full agent card with all details
        function renderAgentCardFull(card) {
            const integrationBadgeColors = {
                'finance': '#2ecc71',
                'hr': '#3498db',
                'crm': '#9b59b6',
                'documents': '#e67e22',
                'communication': '#1abc9c',
                'ai': '#e74c3c',
                'storage': '#34495e',
                'automation': '#f39c12'
            };

            let html = `
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 20px; border-radius: 12px; font-size: 1.5em; font-weight: 700;">${card.apqc_id}</span>
                        <div>
                            <h2 style="margin: 0; color: #333;">${card.apqc_name}</h2>
                            <span style="color: #888; font-size: 0.9em;">${card.category}</span>
                        </div>
                    </div>
                    <p style="color: #555; margin: 0 0 15px 0;">${card.description}</p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <span style="background: #667eea20; color: #667eea; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                            ${card.total_steps} Steps
                        </span>
                        <span style="background: #43e97b20; color: #2d8a4e; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                            ${Math.round(card.estimated_duration_seconds / 60)} min estimated
                        </span>
                        <span style="background: #ff6b6b20; color: #c0392b; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                            ${card.compliance_frameworks?.join(', ') || 'Standard'}
                        </span>
                    </div>
                </div>
            `;

            // Integration Summary
            if (card.integration_summary) {
                html += `
                    <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="color: #333; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3em;">üîå</span> Required Integrations
                        </h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${card.integration_summary.required.map(int => `
                                <div style="background: white; padding: 10px 15px; border-radius: 8px; border-left: 4px solid ${integrationBadgeColors[int.category] || '#667eea'}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="font-weight: 600; color: #333;">${int.id.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                                    <div style="font-size: 0.8em; color: #888;">${int.purpose}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${card.integration_summary.optional?.length > 0 ? `
                            <h4 style="color: #666; margin: 20px 0 10px 0;">Optional Integrations</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${card.integration_summary.optional.map(int => `
                                    <span style="background: white; padding: 6px 12px; border-radius: 15px; font-size: 0.85em; color: #666; border: 1px dashed #ccc;">
                                        ${int.id.replace(/_/g, ' ')}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // KPIs
            if (card.kpis?.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #43e97b15, #38f9d715); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="color: #333; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3em;">üìä</span> Key Performance Indicators
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            ${card.kpis.map(kpi => `
                                <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="font-size: 0.8em; color: #888; margin-bottom: 4px;">${kpi.name}</div>
                                    <div style="font-weight: 700; color: #2d8a4e; font-size: 1.1em;">${kpi.target}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Agent Cards (Steps)
            html += `
                <h3 style="color: #333; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3em;">ü§ñ</span> Workflow Steps (Agent Cards)
                </h3>
            `;

            card.agent_cards?.forEach((agent, index) => {
                const isExpanded = index === 0; // Expand first step by default
                html += `
                    <div style="border: 1px solid #e0e0e0; border-radius: 10px; margin-bottom: 12px; overflow: hidden;">
                        <div onclick="toggleAgentStep(${index})" style="background: ${isExpanded ? '#667eea10' : '#fafafa'}; padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 15px;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">${agent.step_number}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333;">${agent.step_name}</div>
                                <div style="font-size: 0.85em; color: #888;">${agent.description?.substring(0, 100)}${agent.description?.length > 100 ? '...' : ''}</div>
                            </div>
                            <span style="color: #888; font-size: 1.2em;" id="stepChevron${index}">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                        </div>
                        <div id="stepContent${index}" style="display: ${isExpanded ? 'block' : 'none'}; padding: 20px; border-top: 1px solid #e0e0e0;">
                            ${renderAgentStepDetails(agent)}
                        </div>
                    </div>
                `;
            });

            return html;
        }

        // Render details for a single agent step
        function renderAgentStepDetails(agent) {
            let html = '';

            // Purpose & Business Value
            if (agent.purpose || agent.business_value) {
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        ${agent.purpose ? `<p style="margin: 0 0 8px 0;"><strong>Purpose:</strong> ${agent.purpose}</p>` : ''}
                        ${agent.business_value ? `<p style="margin: 0; color: #2d8a4e;"><strong>Business Value:</strong> ${agent.business_value}</p>` : ''}
                    </div>
                `;
            }

            // Capabilities
            if (agent.capabilities?.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h5 style="color: #667eea; margin: 0 0 10px 0;">Capabilities</h5>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${agent.capabilities.map(cap => `
                                <span style="background: #667eea15; color: #667eea; padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">${cap.replace(/_/g, ' ')}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Input/Output Schema
            if (agent.input_schema?.length > 0 || agent.output_schema?.length > 0) {
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">`;

                if (agent.input_schema?.length > 0) {
                    html += `
                        <div>
                            <h5 style="color: #e67e22; margin: 0 0 10px 0;">üì• Input Schema</h5>
                            <div style="background: #fff5eb; padding: 12px; border-radius: 8px; font-size: 0.85em;">
                                ${agent.input_schema.map(field => `
                                    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #ffd9b3;">
                                        <code style="color: #e67e22; font-weight: 600;">${field.name}</code>
                                        <span style="color: #888; font-size: 0.9em;"> : ${field.type}</span>
                                        ${field.required ? '<span style="color: #e74c3c; font-size: 0.75em;"> *required</span>' : ''}
                                        <div style="color: #666; font-size: 0.85em; margin-top: 2px;">${field.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                if (agent.output_schema?.length > 0) {
                    html += `
                        <div>
                            <h5 style="color: #27ae60; margin: 0 0 10px 0;">üì§ Output Schema</h5>
                            <div style="background: #e8f8f0; padding: 12px; border-radius: 8px; font-size: 0.85em;">
                                ${agent.output_schema.map(field => `
                                    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #a8e6cf;">
                                        <code style="color: #27ae60; font-weight: 600;">${field.name}</code>
                                        <span style="color: #888; font-size: 0.9em;"> : ${field.type}</span>
                                        <div style="color: #666; font-size: 0.85em; margin-top: 2px;">${field.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`;
            }

            // Decision Rules
            if (agent.decision_rules?.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h5 style="color: #9b59b6; margin: 0 0 10px 0;">‚öñÔ∏è Decision Rules</h5>
                        ${agent.decision_rules.map(rule => `
                            <div style="background: #f4ecf7; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #9b59b6;">${rule.name}</div>
                                <div style="font-size: 0.85em; color: #666; margin: 5px 0;">${rule.description}</div>
                                <div style="font-family: monospace; font-size: 0.8em; background: white; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                    <span style="color: #8e44ad;">IF</span> ${rule.condition}
                                    <span style="color: #27ae60;">‚Üí</span> ${rule.action_if_true}
                                    <span style="color: #e74c3c;">‚äó</span> ${rule.action_if_false}
                                </div>
                                ${rule.configurable ? `<span style="font-size: 0.75em; color: #888; margin-top: 5px; display: inline-block;">‚úèÔ∏è User configurable (default: ${rule.default_threshold})</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Integrations
            if (agent.required_integrations?.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h5 style="color: #3498db; margin: 0 0 10px 0;">üîå Required Integrations</h5>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${agent.required_integrations.map(int => `
                                <span style="background: #3498db20; color: #3498db; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500;">${int.replace(/_/g, ' ')}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Error Handlers
            if (agent.error_handlers?.length > 0) {
                html += `
                    <div>
                        <h5 style="color: #e74c3c; margin: 0 0 10px 0;">üö® Error Handling</h5>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${agent.error_handlers.map(eh => `
                                <div style="background: #fdecea; padding: 8px 12px; border-radius: 8px; font-size: 0.85em;">
                                    <span style="color: #e74c3c; font-weight: 600;">${eh.error_type.replace(/_/g, ' ')}</span>
                                    <span style="color: #888;"> ‚Üí ${eh.action}</span>
                                    ${eh.max_retries > 0 ? `<span style="color: #888;"> (${eh.max_retries} retries)</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // Toggle agent step expansion
        function toggleAgentStep(index) {
            const content = document.getElementById(`stepContent${index}`);
            const chevron = document.getElementById(`stepChevron${index}`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                chevron.textContent = '‚ñ∂';
            }
        }

        // Render Simple Flow diagram (HTML-based fallback)
        function renderSimpleFlowDiagram(bpmnXml) {
            const container = document.getElementById('bpmnDiagramContainer');

            try {
                // Parse the XML to extract process information
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(bpmnXml, 'text/xml');

                // Extract tasks/activities from the BPMN
                const callActivities = xmlDoc.querySelectorAll('callActivity');
                const tasks = xmlDoc.querySelectorAll('task, serviceTask, userTask');
                const documentation = xmlDoc.querySelector('documentation');

                let diagramHtml = '<div style="padding: 20px; height: 100%; overflow: auto;">';

                // Process documentation
                if (documentation && documentation.textContent) {
                    diagramHtml += `
                        <div style="background: linear-gradient(135deg, #667eea15, #764ba215); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #667eea; margin: 0 0 10px 0;">Process Documentation</h4>
                            <pre style="white-space: pre-wrap; color: #555; font-size: 0.9em; margin: 0; font-family: inherit;">${documentation.textContent.trim()}</pre>
                        </div>
                    `;
                }

                // Process flow visualization
                diagramHtml += '<div style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px;">';
                diagramHtml += '<h4 style="color: #333; margin: 0 0 15px 0;">Process Flow</h4>';

                // Start event
                diagramHtml += `
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #43e97b; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">‚ñ∂</div>
                        <span style="margin-left: 10px; color: #666;">Start Event</span>
                    </div>
                `;

                // Call activities (sub-processes)
                if (callActivities.length > 0) {
                    diagramHtml += '<div style="margin-left: 20px; border-left: 3px solid #667eea; padding-left: 20px;">';
                    callActivities.forEach((activity, index) => {
                        const actName = activity.getAttribute('name') || `Step ${index + 1}`;
                        const calledElement = activity.getAttribute('calledElement') || '';
                        diagramHtml += `
                            <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="background: #667eea; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold;">${index + 1}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #333;">${actName}</div>
                                        ${calledElement ? `<div style="font-size: 0.8em; color: #999; font-family: monospace;">${calledElement}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    diagramHtml += '</div>';
                }

                // Regular tasks
                if (tasks.length > 0 && callActivities.length === 0) {
                    diagramHtml += '<div style="margin-left: 20px; border-left: 3px solid #56ab2f; padding-left: 20px;">';
                    tasks.forEach((task, index) => {
                        const taskName = task.getAttribute('name') || `Task ${index + 1}`;
                        diagramHtml += `
                            <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 15px; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="background: #56ab2f; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold;">${index + 1}</span>
                                    <div style="font-weight: 600; color: #333;">${taskName}</div>
                                </div>
                            </div>
                        `;
                    });
                    diagramHtml += '</div>';
                }

                // End event
                diagramHtml += `
                    <div style="display: flex; align-items: center; margin-top: 15px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #ff6b6b; border: 3px solid #ff4757; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">‚ñ†</div>
                        <span style="margin-left: 10px; color: #666;">End Event</span>
                    </div>
                `;

                diagramHtml += '</div></div>';

                container.innerHTML = diagramHtml;
            } catch (error) {
                console.error('Error rendering simple flow:', error);
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <span style="font-size: 3em; margin-bottom: 10px;">üìÑ</span>
                        <p>View XML Source tab for the raw BPMN content</p>
                    </div>
                `;
            }
        }

        // Switch between view tabs
        function switchBpmnTab(tab) {
            // Update tab buttons
            ['tabStandard', 'tabSimple', 'tabAgentCards', 'tabXml'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

            // Update panes
            ['paneStandard', 'paneSimple', 'paneAgentCards', 'paneXml'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById('pane' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

            // If switching to standard view, fit the diagram
            if (tab === 'standard' && bpmnViewer) {
                setTimeout(() => {
                    try {
                        const canvas = bpmnViewer.get('canvas');
                        canvas.zoom('fit-viewport');
                    } catch (e) {
                        console.log('Could not fit viewport:', e);
                    }
                }, 100);
            }

            // If switching to agent cards, load the data
            if (tab === 'agentCards') {
                loadAgentCards(currentBpmnCode);
            }
        }

        // Zoom controls for standard BPMN diagram
        function bpmnZoomIn() {
            if (bpmnViewer) {
                try {
                    const canvas = bpmnViewer.get('canvas');
                    currentZoom = Math.min(currentZoom * 1.2, 4);
                    canvas.zoom(currentZoom);
                } catch (e) {
                    console.error('Zoom in error:', e);
                }
            }
        }

        function bpmnZoomOut() {
            if (bpmnViewer) {
                try {
                    const canvas = bpmnViewer.get('canvas');
                    currentZoom = Math.max(currentZoom / 1.2, 0.2);
                    canvas.zoom(currentZoom);
                } catch (e) {
                    console.error('Zoom out error:', e);
                }
            }
        }

        function bpmnFitView() {
            if (bpmnViewer) {
                try {
                    const canvas = bpmnViewer.get('canvas');
                    canvas.zoom('fit-viewport');
                    currentZoom = canvas.zoom();
                } catch (e) {
                    console.error('Fit view error:', e);
                }
            }
        }

        function bpmnResetZoom() {
            if (bpmnViewer) {
                try {
                    const canvas = bpmnViewer.get('canvas');
                    canvas.zoom(1);
                    currentZoom = 1;
                } catch (e) {
                    console.error('Reset zoom error:', e);
                }
            }
        }

        // Download current BPMN file
        function downloadBpmn() {
            if (!currentBpmnXml || !currentBpmnCode) {
                alert('No BPMN file loaded');
                return;
            }

            const blob = new Blob([currentBpmnXml], { type: 'application/xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `APQC_${currentBpmnCode.replace(/\./g, '_')}.bpmn`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Close BPMN modal
        function closeBpmnModal() {
            document.getElementById('bpmnModal').classList.remove('active');

            // Cleanup viewer
            if (bpmnViewer) {
                try {
                    bpmnViewer.destroy();
                } catch (e) {}
                bpmnViewer = null;
            }

            currentBpmnXml = null;
            currentBpmnCode = null;
        }

        // ========================================
        // AGENT CARDS TAB FUNCTIONS
        // ========================================
        let allAgentCards = [];
        let agentCardStats = null;

        async function loadAgentCards() {
            const grid = document.getElementById('agentCardsGrid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                // Fetch cards and stats in parallel
                const [cardsResponse, statsResponse] = await Promise.all([
                    fetch(`${API_URL}/api/agent-cards`),
                    fetch(`${API_URL}/api/agent-cards-stats`)
                ]);

                if (!cardsResponse.ok) throw new Error(`API returned ${cardsResponse.status}`);

                const data = await cardsResponse.json();
                allAgentCards = data.agent_cards || [];

                // Use stats from API if available
                if (statsResponse.ok) {
                    agentCardStats = await statsResponse.json();
                    document.getElementById('agentCardsTotalCount').textContent = agentCardStats.total_cards;
                    document.getElementById('agentCardsTotalSteps').textContent = agentCardStats.total_steps;
                    document.getElementById('agentCardsCategories').textContent = `${agentCardStats.coverage?.categories_covered || 0}/13`;
                    document.getElementById('agentCardsIntegrations').textContent = agentCardStats.compliance_frameworks?.length || 0;

                    // Update the last stat label to say "Compliance Frameworks"
                    const statsLabels = document.querySelectorAll('#tab-agentcards .main-content > div:first-of-type > div');
                    if (statsLabels[3]) {
                        const label = statsLabels[3].querySelector('div:last-child');
                        if (label) label.textContent = 'Compliance Frameworks';
                    }
                } else {
                    // Fallback to client-side calculation
                    const totalSteps = allAgentCards.reduce((sum, card) => sum + (card.total_steps || 0), 0);
                    const categories = new Set(allAgentCards.map(c => c.category?.split(' - ')[0] || '').filter(c => c));
                    document.getElementById('agentCardsTotalCount').textContent = allAgentCards.length;
                    document.getElementById('agentCardsTotalSteps').textContent = totalSteps;
                    document.getElementById('agentCardsCategories').textContent = categories.size;
                    document.getElementById('agentCardsIntegrations').textContent = '--';
                }

                renderAgentCardsGrid();
            } catch (error) {
                console.error('Error loading agent cards:', error);
                grid.innerHTML = `<div style="text-align: center; padding: 40px; color: #e74c3c;">Error: ${error.message}</div>`;
            }
        }

        function renderAgentCardsGrid(cardsToRender = allAgentCards) {
            const grid = document.getElementById('agentCardsGrid');

            if (cardsToRender.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">No agent cards found</div>';
                document.getElementById('agentCardsResultsCount').textContent = '';
                return;
            }

            const patternColors = {
                'sequential': '#3498db',
                'parallel': '#27ae60',
                'event_driven': '#9b59b6'
            };

            const patternIcons = {
                'sequential': '‚ûî',
                'parallel': '‚ö°',
                'event_driven': 'üì°'
            };

            grid.innerHTML = cardsToRender.map(card => {
                const pattern = card.orchestration_pattern || 'sequential';
                const patternColor = patternColors[pattern] || '#667eea';
                const patternIcon = patternIcons[pattern] || 'üìã';
                const categoryName = card.category?.split(' - ')[1] || card.category || 'Unknown';
                const categoryNum = card.category?.split('.')[0] || '?';

                return `
                    <div class="agent-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s ease; border-left: 4px solid ${patternColor};" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <span style="background: ${patternColor}15; color: ${patternColor}; padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 600;">${card.apqc_id}</span>
                            <span style="background: #f0f0f0; color: #666; padding: 4px 10px; border-radius: 20px; font-size: 0.75em;">${patternIcon} ${pattern.replace('_', ' ')}</span>
                        </div>
                        <h3 style="font-size: 1.1em; margin-bottom: 8px; color: #333; line-height: 1.3; cursor: pointer;" onclick="viewAgentCard('${card.apqc_id}')">${card.apqc_name}</h3>
                        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${card.description || 'No description'}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.8em; color: #888;">
                                <span title="Category"><span style="color: #667eea;">${categoryNum}</span> ${categoryName}</span>
                                <span title="Workflow Steps">üìä ${card.total_steps || 0} steps</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="event.stopPropagation(); openExecuteModal('${card.apqc_id}', '${card.apqc_name?.replace(/'/g, "\\'")}', true)" style="padding: 6px 12px; background: #f0f0f0; color: #666; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 500;" title="Simulate execution">üß™ Dry Run</button>
                                <button onclick="event.stopPropagation(); openExecuteModal('${card.apqc_id}', '${card.apqc_name?.replace(/'/g, "\\'")}', false)" style="padding: 6px 12px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 500;" title="Execute workflow">‚ñ∂ Execute</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('agentCardsResultsCount').textContent = `Showing ${cardsToRender.length} of ${allAgentCards.length} agent cards`;
        }

        function filterAgentCards() {
            const searchTerm = document.getElementById('agentCardsSearchInput').value.toLowerCase().trim();
            const categoryFilter = document.getElementById('agentCardsCategoryFilter')?.value || '';
            const patternFilter = document.getElementById('agentCardsPatternFilter').value;

            let filtered = allAgentCards;

            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(card =>
                    card.apqc_id?.toLowerCase().includes(searchTerm) ||
                    card.apqc_name?.toLowerCase().includes(searchTerm) ||
                    card.description?.toLowerCase().includes(searchTerm) ||
                    card.category?.toLowerCase().includes(searchTerm)
                );
            }

            // Category filter
            if (categoryFilter) {
                filtered = filtered.filter(card => {
                    const cardCategory = card.category?.split(' - ')[0] || '';
                    return cardCategory === categoryFilter;
                });
            }

            // Pattern filter
            if (patternFilter) {
                filtered = filtered.filter(card => card.orchestration_pattern === patternFilter);
            }

            renderAgentCardsGrid(filtered);
        }

        function resetAgentCardsFilter() {
            document.getElementById('agentCardsSearchInput').value = '';
            document.getElementById('agentCardsCategoryFilter').value = '';
            document.getElementById('agentCardsPatternFilter').value = '';
            renderAgentCardsGrid();
        }

        async function viewAgentCard(apqcCode) {
            try {
                const response = await fetch(`${API_URL}/api/agent-cards/${apqcCode}`);
                if (!response.ok) throw new Error(`Agent card not found for ${apqcCode}`);
                const card = await response.json();

                const patternColors = {
                    'sequential': '#3498db',
                    'parallel': '#27ae60',
                    'event_driven': '#9b59b6'
                };
                const patternColor = patternColors[card.orchestration_pattern] || '#667eea';

                // Build workflow steps visualization
                const steps = card.agent_cards || [];
                const stepsHtml = steps.map((step, idx) => `
                    <div style="display: flex; align-items: flex-start; margin-bottom: 20px;">
                        <div style="min-width: 40px; height: 40px; background: ${patternColor}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1em;">${step.step_number || idx + 1}</div>
                        <div style="flex: 1; margin-left: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 3px solid ${patternColor};">
                            <h4 style="margin: 0 0 8px 0; color: #333;">${step.step_name}</h4>
                            <p style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;">${step.description || ''}</p>
                            ${step.capabilities ? `<div style="margin-top: 10px;"><strong style="font-size: 0.8em; color: #888;">Capabilities:</strong> <span style="font-size: 0.8em; color: #667eea;">${step.capabilities.slice(0, 5).join(', ')}${step.capabilities.length > 5 ? '...' : ''}</span></div>` : ''}
                            ${step.required_integrations ? `<div style="margin-top: 5px;"><strong style="font-size: 0.8em; color: #888;">Integrations:</strong> <span style="font-size: 0.8em; color: #27ae60;">${step.required_integrations.map(i => i.system).join(', ')}</span></div>` : ''}
                        </div>
                    </div>
                `).join('');

                // Build KPIs section
                const kpis = card.kpis || [];
                const kpisHtml = kpis.length > 0 ? `
                    <div style="margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">Key Performance Indicators</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                            ${kpis.map(kpi => `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 5px;">${kpi.name}</div>
                                    <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">${kpi.description || ''}</div>
                                    <div style="font-size: 0.9em; color: #27ae60; font-weight: 600;">Target: ${kpi.target || 'N/A'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';

                // Build integrations summary
                const integrationSummary = card.integration_summary || {};
                const integrationHtml = Object.keys(integrationSummary).length > 0 ? `
                    <div style="margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">Integration Summary</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${Object.entries(integrationSummary).map(([key, values]) => `
                                <div style="background: #667eea15; padding: 10px 15px; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #667eea; font-size: 0.85em; margin-bottom: 5px;">${key.replace(/_/g, ' ').toUpperCase()}</div>
                                    <div style="font-size: 0.8em; color: #666;">${Array.isArray(values) ? values.slice(0, 3).join(', ') : values}${Array.isArray(values) && values.length > 3 ? '...' : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';

                const html = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span style="background: ${patternColor}15; color: ${patternColor}; padding: 6px 15px; border-radius: 20px; font-weight: 600;">${card.apqc_id}</span>
                            <span style="background: #f0f0f0; color: #666; padding: 6px 15px; border-radius: 20px; font-size: 0.9em;">${card.orchestration_pattern?.replace('_', ' ') || 'sequential'}</span>
                        </div>
                        <p style="margin-top: 15px; color: #666; line-height: 1.5;">${card.description || ''}</p>
                        <div style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.9em; color: #888;">
                            <span>Category: <strong>${card.category || 'Unknown'}</strong></span>
                            <span>Duration: <strong>${card.estimated_duration_seconds ? (card.estimated_duration_seconds / 3600).toFixed(1) + ' hours' : 'N/A'}</strong></span>
                            <span>Data Retention: <strong>${card.data_retention_days ? card.data_retention_days + ' days' : 'N/A'}</strong></span>
                        </div>
                        ${card.compliance_frameworks ? `<div style="margin-top: 10px;"><strong style="font-size: 0.85em; color: #888;">Compliance:</strong> ${card.compliance_frameworks.map(f => `<span style="background: #e74c3c15; color: #e74c3c; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${f}</span>`).join('')}</div>` : ''}
                    </div>

                    <div style="margin-top: 25px;">
                        <h3 style="margin-bottom: 15px; color: #333;">Workflow Steps (${steps.length})</h3>
                        <div style="position: relative;">
                            ${stepsHtml}
                        </div>
                    </div>

                    ${kpisHtml}
                    ${integrationHtml}
                `;

                document.getElementById('modalBody').innerHTML = html;
                document.querySelector('#agentModal .modal-header h2').textContent = card.apqc_name;
                document.getElementById('agentModal').classList.add('active');
            } catch (error) {
                console.error('Error loading agent card:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // ========================================
        // AGENT CARD EXECUTION FUNCTIONS
        // ========================================
        let currentExecuteApqcCode = null;
        let currentExecuteDryRun = false;

        async function openExecuteModal(apqcCode, apqcName, isDryRun) {
            currentExecuteApqcCode = apqcCode;
            currentExecuteDryRun = isDryRun;

            const modal = document.getElementById('executeModal');
            const title = document.getElementById('executeModalTitle');
            const body = document.getElementById('executeModalBody');

            title.textContent = isDryRun ? `üß™ Dry Run: ${apqcName}` : `‚ñ∂ Execute: ${apqcName}`;
            body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            modal.classList.add('active');

            try {
                // Fetch required inputs for this agent card
                const response = await fetch(`${API_URL}/api/agent-cards/${apqcCode}/required-inputs`);
                if (!response.ok) throw new Error('Failed to load input schema');
                const schema = await response.json();

                const requiredInputs = schema.required_inputs || [];
                const optionalInputs = schema.optional_inputs || [];

                let inputFieldsHtml = '';

                if (requiredInputs.length === 0 && optionalInputs.length === 0) {
                    inputFieldsHtml = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="color: #666; margin: 0;">No specific input schema defined. You can provide custom JSON input below.</p>
                        </div>
                    `;
                } else {
                    // Required fields
                    if (requiredInputs.length > 0) {
                        inputFieldsHtml += `<h4 style="margin-bottom: 15px; color: #333;">Required Inputs</h4>`;
                        inputFieldsHtml += requiredInputs.map(field => renderInputField(field, true)).join('');
                    }

                    // Optional fields
                    if (optionalInputs.length > 0) {
                        inputFieldsHtml += `<h4 style="margin: 20px 0 15px 0; color: #666;">Optional Inputs</h4>`;
                        inputFieldsHtml += optionalInputs.map(field => renderInputField(field, false)).join('');
                    }
                }

                body.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                            <span style="background: ${isDryRun ? '#f39c1215' : '#27ae6015'}; color: ${isDryRun ? '#f39c12' : '#27ae60'}; padding: 6px 15px; border-radius: 20px; font-weight: 600;">${apqcCode}</span>
                            <span style="background: ${isDryRun ? '#f39c1215' : '#27ae6015'}; color: ${isDryRun ? '#f39c12' : '#27ae60'}; padding: 6px 15px; border-radius: 20px; font-size: 0.9em;">${isDryRun ? 'üß™ Simulation Mode' : '‚ñ∂ Live Execution'}</span>
                        </div>
                        ${isDryRun ? `<p style="color: #f39c12; font-size: 0.9em; background: #f39c1210; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;">‚ö†Ô∏è Dry run mode: No actual integrations will be called. This simulates the workflow execution.</p>` : `<p style="color: #e74c3c; font-size: 0.9em; background: #e74c3c10; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;">‚ö†Ô∏è Live execution: This will make actual API calls to configured integrations.</p>`}
                    </div>

                    <form id="executeForm" onsubmit="return false;">
                        ${inputFieldsHtml}

                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 10px; color: #666;">Custom JSON Input (optional)</h4>
                            <textarea id="executeCustomJson" style="width: 100%; height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 0.9em; resize: vertical;" placeholder='{"key": "value"}'></textarea>
                        </div>
                    </form>

                    <div id="executeResultsContainer" style="display: none; margin-top: 25px;">
                        <h4 style="margin-bottom: 15px; color: #333;">Execution Results</h4>
                        <div id="executeResults"></div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <button class="btn secondary" onclick="closeExecuteModal()">Cancel</button>
                        <button id="executeBtn" class="btn" onclick="runExecution()" style="background: ${isDryRun ? 'linear-gradient(135deg, #f39c12, #e67e22)' : 'linear-gradient(135deg, #27ae60, #2ecc71)'};">${isDryRun ? 'üß™ Run Simulation' : '‚ñ∂ Execute Workflow'}</button>
                    </div>
                `;
            } catch (error) {
                body.innerHTML = `<div style="color: #e74c3c; padding: 20px;">Error: ${error.message}</div>`;
            }
        }

        function renderInputField(field, isRequired) {
            const fieldId = `exec_${field.name}`;
            const requiredMark = isRequired ? '<span style="color: #e74c3c;">*</span>' : '';
            const typeHint = field.type === 'array' ? '(JSON array)' : field.type === 'object' ? '(JSON object)' : '';

            let inputHtml = '';
            if (field.validation?.enum) {
                // Dropdown for enum fields
                inputHtml = `
                    <select id="${fieldId}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;" ${isRequired ? 'required' : ''}>
                        <option value="">Select...</option>
                        ${field.validation.enum.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                `;
            } else if (field.type === 'array' || field.type === 'object') {
                // Textarea for complex types
                inputHtml = `<textarea id="${fieldId}" style="width: 100%; height: 80px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 0.9em;" placeholder='${field.example ? JSON.stringify(field.example) : (field.type === 'array' ? '[]' : '{}')}' ${isRequired ? 'required' : ''}></textarea>`;
            } else if (field.type === 'number' || field.type === 'integer') {
                inputHtml = `<input type="number" id="${fieldId}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;" placeholder="${field.example || ''}" ${isRequired ? 'required' : ''} step="any">`;
            } else if (field.type === 'boolean') {
                inputHtml = `
                    <select id="${fieldId}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
                        <option value="">Select...</option>
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                `;
            } else {
                inputHtml = `<input type="text" id="${fieldId}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;" placeholder="${field.example || ''}" ${isRequired ? 'required' : ''}>`;
            }

            return `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">${field.name} ${requiredMark} <span style="font-weight: normal; color: #888; font-size: 0.85em;">${typeHint}</span></label>
                    ${field.description ? `<p style="color: #666; font-size: 0.85em; margin-bottom: 8px;">${field.description}</p>` : ''}
                    ${inputHtml}
                </div>
            `;
        }

        async function runExecution() {
            const btn = document.getElementById('executeBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Executing...';

            try {
                // Collect input data from form fields
                const inputData = {};
                const form = document.getElementById('executeForm');
                const inputs = form.querySelectorAll('input, select, textarea');

                inputs.forEach(input => {
                    if (input.id === 'executeCustomJson') return; // Handle separately
                    if (!input.id.startsWith('exec_')) return;

                    const fieldName = input.id.replace('exec_', '');
                    let value = input.value.trim();

                    if (value) {
                        // Try to parse JSON for complex types
                        if (input.tagName === 'TEXTAREA') {
                            try {
                                value = JSON.parse(value);
                            } catch (e) {
                                // Keep as string if not valid JSON
                            }
                        } else if (input.type === 'number') {
                            value = parseFloat(value);
                        } else if (value === 'true') {
                            value = true;
                        } else if (value === 'false') {
                            value = false;
                        }
                        inputData[fieldName] = value;
                    }
                });

                // Merge custom JSON if provided
                const customJson = document.getElementById('executeCustomJson').value.trim();
                if (customJson) {
                    try {
                        const custom = JSON.parse(customJson);
                        Object.assign(inputData, custom);
                    } catch (e) {
                        throw new Error('Invalid custom JSON: ' + e.message);
                    }
                }

                // Execute the workflow
                const response = await fetch(`${API_URL}/api/agent-cards/${currentExecuteApqcCode}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input_data: inputData,
                        dry_run: currentExecuteDryRun
                    })
                });

                const result = await response.json();

                // Display results
                const resultsContainer = document.getElementById('executeResultsContainer');
                const resultsDiv = document.getElementById('executeResults');
                resultsContainer.style.display = 'block';

                if (result.success || result.dry_run) {
                    resultsDiv.innerHTML = renderExecutionResults(result);
                } else {
                    resultsDiv.innerHTML = `
                        <div style="background: #e74c3c15; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                            <strong style="color: #e74c3c;">Execution Failed</strong>
                            <p style="color: #666; margin-top: 10px;">${result.detail || result.error || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                const resultsContainer = document.getElementById('executeResultsContainer');
                const resultsDiv = document.getElementById('executeResults');
                resultsContainer.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div style="background: #e74c3c15; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <strong style="color: #e74c3c;">Error</strong>
                        <p style="color: #666; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function renderExecutionResults(result) {
            const isDryRun = result.dry_run;
            const statusColor = result.success ? '#27ae60' : '#e74c3c';
            const statusBg = result.success ? '#27ae6015' : '#e74c3c15';

            let stepsHtml = '';
            const steps = isDryRun ? result.simulated_steps : (result.step_results || []);

            if (steps && steps.length > 0) {
                stepsHtml = `
                    <div style="margin-top: 20px;">
                        <h5 style="margin-bottom: 15px; color: #333;">${isDryRun ? 'Simulated Steps' : 'Step Results'}</h5>
                        ${steps.map((step, idx) => `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${isDryRun ? '#f39c12' : statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="color: #333;">Step ${step.step_number || idx + 1}: ${step.step_name || 'Unknown'}</strong>
                                    <span style="background: ${isDryRun ? '#f39c1215' : statusBg}; color: ${isDryRun ? '#f39c12' : statusColor}; padding: 2px 10px; border-radius: 10px; font-size: 0.8em;">${step.status || 'simulated'}</span>
                                </div>
                                ${step.would_call_integrations ? `<div style="margin-top: 10px; font-size: 0.85em; color: #666;"><strong>Integrations:</strong> ${step.would_call_integrations.join(', ')}</div>` : ''}
                                ${step.decision_rules_to_evaluate ? `<div style="margin-top: 5px; font-size: 0.85em; color: #666;"><strong>Decision Rules:</strong> ${step.decision_rules_to_evaluate.join(', ')}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            return `
                <div style="background: ${statusBg}; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="color: ${statusColor};">${isDryRun ? 'üß™ Dry Run Complete' : (result.success ? '‚úì Execution Successful' : '‚úó Execution Failed')}</strong>
                        <span style="color: #666; font-size: 0.85em;">ID: ${result.execution_id || 'N/A'}</span>
                    </div>
                    ${result.message ? `<p style="color: #666; margin-top: 10px; font-size: 0.9em;">${result.message}</p>` : ''}
                </div>

                ${result.required_integrations_summary ? `
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #333; font-size: 0.9em;">Required Integrations:</strong>
                        <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                            ${result.required_integrations_summary.map(int => `<span style="background: #667eea15; color: #667eea; padding: 4px 10px; border-radius: 15px; font-size: 0.8em;">${int}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}

                ${stepsHtml}

                <div style="margin-top: 15px;">
                    <details style="cursor: pointer;">
                        <summary style="color: #666; font-size: 0.9em; padding: 10px 0;">View Raw Response</summary>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow: auto; max-height: 300px; font-size: 0.8em; margin-top: 10px;">${JSON.stringify(result, null, 2)}</pre>
                    </details>
                </div>
            `;
        }

        function closeExecuteModal() {
            document.getElementById('executeModal').classList.remove('active');
            currentExecuteApqcCode = null;
            currentExecuteDryRun = false;
        }

        // Legacy function - redirect to drill-down
        async function loadCategoryAgents() {
            loadApqcLevel();
        }

        // Browse agents by category - DRILL DOWN
        async function browseCategoryAgents(category) {
            const container = document.getElementById('agentsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                // Fetch agents for this specific category
                const response = await fetch(`${API_URL}/api/agents?category=${encodeURIComponent(category)}&limit=1500`);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const agents = await response.json();

                if (!agents || agents.length === 0) {
                    container.innerHTML = `<div class="empty-state"><h3>No agents in ${category}</h3></div>`;
                    document.getElementById('agentsPagination').innerHTML = '';
                    allAgents = [];
                } else {
                    allAgents = agents;
                    displayAgents(agents, 1);
                }

                // Update search box to show category filter
                document.getElementById('categoryFilter').value = category;

                // Switch to agents tab
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
                document.getElementById('tab-agents').classList.add('active');
                document.querySelector('[onclick="switchTab(\'agents\')"]').classList.add('active');
            } catch (error) {
                console.error('Error loading category agents:', error);
                document.getElementById('agentsContainer').innerHTML = `<div class="empty-state"><h3>Error loading agents</h3><p>${error.message}</p></div>`;
            }
        }

        // Show agent details modal
        async function showAgentDetails(agentId) {
            try {
                const response = await fetch(`${API_URL}/api/agents/${agentId}`);
                const agent = await response.json();

                const html = `
                    <div class="detail-item">
                        <label>Agent ID</label>
                        <div class="value">${agent.agent_id}</div>
                    </div>
                    <div class="detail-item">
                        <label>Name</label>
                        <div class="value">${agent.name}</div>
                    </div>
                    <div class="detail-item">
                        <label>Description</label>
                        <div class="value">${agent.description || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <label>APQC Category</label>
                        <div class="value">${agent.apqc_category}</div>
                    </div>
                    <div class="detail-item">
                        <label>APQC ID</label>
                        <div class="value">${agent.apqc_id || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <label>Agent Type</label>
                        <div class="value">${agent.agent_type}</div>
                    </div>
                    <div class="detail-item">
                        <label>Status</label>
                        <div class="value"><span class="result-badge ${agent.is_active ? 'success' : 'error'}">${agent.is_active ? 'Active' : 'Inactive'}</span></div>
                    </div>
                    <div class="detail-item">
                        <label>Version</label>
                        <div class="value">${agent.version}</div>
                    </div>
                `;

                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('agentModal').classList.add('active');
            } catch (error) {
                console.error('Error loading agent details:', error);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('agentModal').classList.remove('active');
        }

        // Invoice workflow
        document.getElementById('invoiceForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const invoiceData = {
                source: 'dashboard',
                invoice_number: document.getElementById('invoiceNumber').value,
                vendor_name: document.getElementById('vendorName').value,
                date: document.getElementById('invoiceDate').value,
                items: JSON.parse(document.getElementById('lineItems').value)
            };

            try {
                const response = await fetch(`${API_URL}/api/workflows/invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(invoiceData)
                });

                const result = await response.json();
                pollWorkflowStatus(result.workflow_id);
            } catch (error) {
                alert('Error submitting workflow: ' + error.message);
            }
        });

        // Poll workflow status
        async function pollWorkflowStatus(workflowId) {
            let attempts = 0;
            const maxAttempts = 20;

            const poll = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/workflows/${workflowId}`);
                    const data = await response.json();

                    if (data.status === 'pending' || data.status === 'running') {
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(poll, 200);
                        }
                    } else {
                        displayWorkflowResults(data);
                    }
                } catch (error) {
                    console.error('Error polling workflow:', error);
                }
            };

            poll();
        }

        // Display workflow results
        function displayWorkflowResults(workflow) {
            workflowCount++;
            if (workflow.success) successCount++;

            const isApproved = workflow.output_data?.final_decision?.action?.includes('APPROVE');
            const icon = isApproved ? '‚úÖ' : '‚ùå';

            const resultsHtml = `
                <div style="background: ${isApproved ? '#d4fc79' : '#ffecd2'}; padding: 20px; border-radius: 10px;">
                    <h4>${icon} ${workflow.output_data?.final_decision?.action || 'COMPLETED'}</h4>
                    <p><strong>Workflow ID:</strong> ${workflow.workflow_id}</p>
                    <p><strong>Execution Time:</strong> ${(workflow.execution_time_ms || 0).toFixed(2)}ms</p>
                    <p><strong>Success:</strong> ${workflow.success ? 'Yes' : 'No'}</p>
                </div>
            `;

            document.getElementById('resultsContainer').innerHTML = resultsHtml;
            document.getElementById('resultsSection').style.display = 'block';

            // Update stats
            loadStats();
        }

        // ========================================
        // INTEGRATIONS PAGE
        // ========================================
        let allIntegrations = [];
        let currentIntegrationFilter = 'all';

        const integrationCategoryColors = {
            'finance': { bg: '#2ecc7120', color: '#27ae60', icon: 'üí∞' },
            'hr': { bg: '#3498db20', color: '#2980b9', icon: 'üë•' },
            'crm': { bg: '#9b59b620', color: '#8e44ad', icon: 'üìä' },
            'documents': { bg: '#e67e2220', color: '#d35400', icon: 'üìÑ' },
            'communication': { bg: '#1abc9c20', color: '#16a085', icon: 'üí¨' },
            'ai': { bg: '#e74c3c20', color: '#c0392b', icon: 'ü§ñ' },
            'storage': { bg: '#34495e20', color: '#2c3e50', icon: 'üíæ' },
            'automation': { bg: '#f39c1220', color: '#e67e22', icon: '‚ö°' }
        };

        async function loadIntegrations() {
            const container = document.getElementById('integrationsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_URL}/api/integrations`);
                const data = await response.json();

                allIntegrations = data.integrations;

                // Update stats
                document.getElementById('totalIntegrations').textContent = data.total;
                document.getElementById('totalCategories').textContent = Object.keys(data.categories).length;

                // Calculate total capabilities
                let totalCaps = 0;
                allIntegrations.forEach(i => totalCaps += i.capabilities_count);
                document.getElementById('totalCapabilities').textContent = totalCaps;

                renderIntegrations(allIntegrations);
            } catch (error) {
                console.error('Error loading integrations:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">Error loading integrations</div>';
            }
        }

        function filterIntegrations(category) {
            currentIntegrationFilter = category;

            // Update button states
            document.querySelectorAll('.integration-category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                }
            });

            // Filter and render
            const filtered = category === 'all'
                ? allIntegrations
                : allIntegrations.filter(i => i.category === category);

            renderIntegrations(filtered);
        }

        function renderIntegrations(integrations) {
            const container = document.getElementById('integrationsContainer');

            if (integrations.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">No integrations found in this category</div>';
                return;
            }

            const html = integrations.map(integration => {
                const catStyle = integrationCategoryColors[integration.category] || { bg: '#66666620', color: '#666', icon: 'üîó' };
                const isConfigured = isIntegrationConfigured(integration.id);

                return `
                    <div class="integration-card" style="position: relative;">
                        <div class="config-status ${isConfigured ? 'configured' : ''}" title="${isConfigured ? 'Configured' : 'Not configured'}"></div>
                        <div class="icon" style="background: ${catStyle.bg};">
                            ${catStyle.icon}
                        </div>
                        <div class="name">${integration.name}</div>
                        <span class="category-badge" style="background: ${catStyle.bg}; color: ${catStyle.color};">
                            ${integration.category}
                        </span>
                        <div class="description">${integration.type.replace(/_/g, ' ')} integration</div>
                        <div class="capabilities">
                            <span class="capability-tag">${integration.capabilities_count} capabilities</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn-configure ${isConfigured ? 'configured' : ''}" onclick="event.stopPropagation(); openCredentialsModal('${integration.id}')">
                                ${isConfigured ? '‚úì Configured' : '‚öôÔ∏è Configure'}
                            </button>
                            <button style="padding: 8px 12px; border: 1px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer;" onclick="event.stopPropagation(); showIntegrationDetail('${integration.id}')">
                                Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        async function showIntegrationDetail(integrationId) {
            try {
                const response = await fetch(`${API_URL}/api/integrations/${integrationId}`);
                const integration = await response.json();

                const catStyle = integrationCategoryColors[integration.category] || { bg: '#66666620', color: '#666', icon: 'üîó' };

                const modalBody = `
                    <div style="padding: 10px 0;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div style="width: 60px; height: 60px; background: ${catStyle.bg}; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2em;">
                                ${catStyle.icon}
                            </div>
                            <div>
                                <h3 style="margin: 0; color: #333;">${integration.name}</h3>
                                <span style="background: ${catStyle.bg}; color: ${catStyle.color}; padding: 3px 10px; border-radius: 10px; font-size: 0.8em; font-weight: 600; text-transform: uppercase;">${integration.category}</span>
                            </div>
                        </div>

                        <p style="color: #555; margin-bottom: 20px;">${integration.description}</p>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #667eea; margin: 0 0 10px 0;">Connection Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                                <div><strong>Type:</strong> ${integration.type.replace(/_/g, ' ')}</div>
                                <div><strong>Auth:</strong> ${integration.auth_type}</div>
                                ${integration.base_url ? `<div style="grid-column: span 2;"><strong>Base URL:</strong> <code style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.85em;">${integration.base_url}</code></div>` : ''}
                            </div>
                        </div>

                        ${integration.required_credentials?.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #e67e22; margin: 0 0 10px 0;">Required Credentials</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${integration.required_credentials.map(c => `
                                        <span style="background: #fff5eb; color: #e67e22; padding: 5px 12px; border-radius: 15px; font-size: 0.85em;">${c}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #27ae60; margin: 0 0 10px 0;">Capabilities (${integration.capabilities?.length || 0})</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${(integration.capabilities || []).map(c => `
                                    <span style="background: #e8f8f0; color: #27ae60; padding: 5px 12px; border-radius: 15px; font-size: 0.85em;">${c.replace(/_/g, ' ')}</span>
                                `).join('')}
                            </div>
                        </div>

                        ${integration.rate_limit ? `
                            <div style="background: #fef3e2; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                <strong style="color: #e67e22;">Rate Limit:</strong>
                                ${Object.entries(integration.rate_limit).map(([k, v]) => `${v} ${k.replace(/_/g, ' ')}`).join(', ')}
                            </div>
                        ` : ''}

                        ${integration.documentation_url ? `
                            <a href="${integration.documentation_url}" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; background: #667eea; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 500;">
                                üìö View Documentation ‚Üí
                            </a>
                        ` : ''}
                    </div>
                `;

                document.getElementById('modalBody').innerHTML = modalBody;
                document.querySelector('#agentModal h2').textContent = 'Integration Details';
                document.getElementById('agentModal').style.display = 'flex';

            } catch (error) {
                console.error('Error loading integration details:', error);
                alert('Error loading integration details');
            }
        }

        // ========================================
        // WORKFLOW EXECUTION
        // ========================================
        let availableWorkflows = [];
        let currentExecutionId = null;

        async function loadExecuteTab() {
            await loadAvailableWorkflows();
            await loadRecentExecutions();
        }

        async function loadAvailableWorkflows() {
            try {
                const response = await fetch(`${API_URL}/api/execute/available`);
                const data = await response.json();
                availableWorkflows = data.workflows || [];

                const select = document.getElementById('executeWorkflowSelect');
                select.innerHTML = '<option value="">-- Select a workflow --</option>';

                availableWorkflows.forEach(wf => {
                    const option = document.createElement('option');
                    option.value = wf.apqc_code;
                    option.textContent = `${wf.apqc_code || 'N/A'} - ${wf.apqc_name} (${wf.total_steps} steps)`;
                    select.appendChild(option);
                });

                // Add change handler
                select.onchange = () => onWorkflowSelected(select.value);

            } catch (error) {
                console.error('Error loading workflows:', error);
            }
        }

        function onWorkflowSelected(apqcCode) {
            const infoDiv = document.getElementById('selectedWorkflowInfo');

            if (!apqcCode) {
                infoDiv.style.display = 'none';
                return;
            }

            const workflow = availableWorkflows.find(w => w.apqc_code === apqcCode);
            if (workflow) {
                document.getElementById('workflowInfoName').textContent = workflow.apqc_name;
                document.getElementById('workflowInfoSteps').textContent = `${workflow.total_steps} steps`;
                document.getElementById('workflowInfoCategory').textContent = workflow.category || 'General';

                const integrationsDiv = document.getElementById('workflowInfoIntegrations');
                integrationsDiv.innerHTML = (workflow.required_integrations || []).map(int =>
                    `<span style="background: #3498db15; color: #3498db; padding: 3px 8px; border-radius: 10px; font-size: 0.75em;">${int}</span>`
                ).join('');

                infoDiv.style.display = 'block';

                // Load sample input
                loadSampleInput();
            }
        }

        function loadSampleInput() {
            const sampleData = {
                invoice_number: `INV-${new Date().toISOString().slice(0,10).replace(/-/g, '')}-001`,
                vendor_name: "Acme Corporation",
                invoice_date: new Date().toISOString().slice(0, 10),
                due_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().slice(0, 10),
                total_amount: 15750.00,
                currency: "USD",
                po_number: "PO-2025-00123",
                line_items: [
                    { description: "Software License", quantity: 10, unit_price: 1000.00, total: 10000.00 },
                    { description: "Implementation Services", quantity: 50, unit_price: 115.00, total: 5750.00 }
                ]
            };

            document.getElementById('executeInputData').value = JSON.stringify(sampleData, null, 2);
        }

        async function executeWorkflow() {
            const apqcCode = document.getElementById('executeWorkflowSelect').value;
            if (!apqcCode) {
                alert('Please select a workflow to execute');
                return;
            }

            let inputData;
            try {
                inputData = JSON.parse(document.getElementById('executeInputData').value || '{}');
            } catch (e) {
                alert('Invalid JSON in input data');
                return;
            }

            // Get stored credentials
            const stored = localStorage.getItem('apqc_integration_credentials');
            const credentials = stored ? JSON.parse(stored) : {};

            // Show progress
            const progressDiv = document.getElementById('executionProgress');
            progressDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner" style="margin: 0 auto 15px;"></div>
                    <div style="color: #667eea; font-weight: 600;">Executing workflow...</div>
                    <div style="color: #888; font-size: 0.9em;">Processing steps...</div>
                </div>
            `;

            document.getElementById('executionResultsContainer').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/api/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apqc_code: apqcCode,
                        input_data: inputData,
                        credentials: credentials
                    })
                });

                const result = await response.json();
                currentExecutionId = result.execution_id;

                // Show results
                displayExecutionResults(result);
                loadRecentExecutions();

            } catch (error) {
                progressDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        <div style="font-size: 2em; margin-bottom: 10px;">‚ùå</div>
                        <div>Execution failed: ${error.message}</div>
                    </div>
                `;
            }
        }

        function displayExecutionResults(result) {
            const progressDiv = document.getElementById('executionProgress');
            const resultsDiv = document.getElementById('executionResults');
            const resultsContainer = document.getElementById('executionResultsContainer');

            // Update progress with final status
            const statusColors = {
                'completed': { bg: '#43e97b20', color: '#27ae60', icon: '‚úì' },
                'failed': { bg: '#e74c3c20', color: '#e74c3c', icon: '‚úó' },
                'waiting_approval': { bg: '#f39c1220', color: '#e67e22', icon: '‚è∏' }
            };
            const status = statusColors[result.status] || statusColors['completed'];

            progressDiv.innerHTML = `
                <div style="background: ${status.bg}; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.5em;">${status.icon}</span>
                        <span style="font-weight: 600; color: ${status.color}; text-transform: uppercase;">${result.status}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                        <div><strong>Duration:</strong> ${result.total_duration_ms}ms</div>
                        <div><strong>Steps:</strong> ${result.steps_completed}/${result.total_steps}</div>
                    </div>
                </div>

                <div style="font-weight: 600; margin-bottom: 10px;">Step Progress:</div>
                ${result.step_executions.map((step, i) => {
                    const stepStatus = step.status === 'success' ? '#27ae60' : step.status === 'failure' ? '#e74c3c' : '#f39c12';
                    return `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            <span style="width: 24px; height: 24px; background: ${stepStatus}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: 600;">${step.step_number}</span>
                            <span style="flex: 1; font-size: 0.9em;">${step.step_name}</span>
                            <span style="color: #888; font-size: 0.8em;">${step.duration_ms}ms</span>
                        </div>
                    `;
                }).join('')}
            `;

            // Show detailed results
            resultsDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Execution ID</div>
                    <code style="background: #f0f0f0; padding: 5px 10px; border-radius: 5px; font-size: 0.85em;">${result.execution_id}</code>
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Integration Calls (${result.integration_calls?.length || 0})</div>
                    <div style="max-height: 150px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px;">
                        ${(result.integration_calls || []).map(call => `
                            <div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0; font-size: 0.85em;">
                                <span style="color: ${call.success ? '#27ae60' : '#e74c3c'};">${call.success ? '‚úì' : '‚úó'}</span>
                                <strong>${call.integration_id}</strong> ‚Üí ${call.operation}
                                <span style="color: #888;">(${call.duration_ms}ms, ${call.mode})</span>
                            </div>
                        `).join('') || '<div style="color: #888;">No integration calls made</div>'}
                    </div>
                </div>

                <div>
                    <div style="font-weight: 600; margin-bottom: 8px;">Audit Log (${result.audit_log?.length || 0} entries)</div>
                    <div style="max-height: 200px; overflow-y: auto; background: #1a1a2e; color: #a0ffa0; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 0.75em;">
                        ${(result.audit_log || []).map(log => `
                            <div style="padding: 3px 0;">
                                <span style="color: #888;">${log.timestamp.split('T')[1].split('.')[0]}</span>
                                <span style="color: ${log.level === 'error' ? '#ff6b6b' : '#a0ffa0'};">[${log.level.toUpperCase()}]</span>
                                ${log.event_type}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            resultsContainer.style.display = 'block';
        }

        async function loadRecentExecutions() {
            const container = document.getElementById('recentExecutions');
            const statusFilter = document.getElementById('wfStatusFilter')?.value || '';

            try {
                // Load stats and history in parallel
                const [statsResponse, historyResponse] = await Promise.all([
                    fetch(`${API_URL}/api/workflows/stats`),
                    fetch(`${API_URL}/api/workflows/history?limit=15${statusFilter ? '&status=' + statusFilter : ''}`)
                ]);

                // Update stats
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('wfStatTotal').textContent = stats.total_workflows || 0;
                    document.getElementById('wfStatSuccess').textContent = (stats.success_rate || 0) + '%';
                    document.getElementById('wfStatRunning').textContent = stats.by_status?.running || 0;
                    document.getElementById('wfStatAvgTime').textContent = Math.round(stats.average_execution_time_ms || 0);
                }

                // Render history
                if (historyResponse.ok) {
                    const data = await historyResponse.json();
                    const workflows = data.workflows || [];

                    if (workflows.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No workflow executions found</div>';
                        return;
                    }

                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e0e0e0;">
                                    <th style="text-align: left; padding: 10px;">Status</th>
                                    <th style="text-align: left; padding: 10px;">Workflow</th>
                                    <th style="text-align: left; padding: 10px;">Type</th>
                                    <th style="text-align: left; padding: 10px;">Agents</th>
                                    <th style="text-align: left; padding: 10px;">Duration</th>
                                    <th style="text-align: left; padding: 10px;">Started</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${workflows.map(wf => {
                                    const statusColors = {
                                        'completed': '#27ae60',
                                        'failed': '#e74c3c',
                                        'running': '#3498db',
                                        'pending': '#f39c12'
                                    };
                                    const color = statusColors[wf.status] || '#888';
                                    const statusIcon = wf.success ? '‚úì' : wf.status === 'failed' ? '‚úó' : wf.status === 'running' ? '‚ü≥' : '‚óã';
                                    return `
                                        <tr style="border-bottom: 1px solid #f0f0f0; cursor: pointer;" onclick="viewWorkflowDetails('${wf.workflow_id}')" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                            <td style="padding: 10px;">
                                                <span style="background: ${color}20; color: ${color}; padding: 3px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                                    ${statusIcon} ${wf.status}
                                                </span>
                                            </td>
                                            <td style="padding: 10px; font-weight: 500;">${wf.workflow_name || 'N/A'}</td>
                                            <td style="padding: 10px; color: #666;">${wf.workflow_type || '-'}</td>
                                            <td style="padding: 10px;">
                                                <span style="color: #27ae60;">${wf.agents_succeeded || 0}</span>/<span style="color: ${wf.agents_failed ? '#e74c3c' : '#666'}">${wf.agents_failed || 0}</span>/${wf.total_agents || 0}
                                            </td>
                                            <td style="padding: 10px;">${wf.execution_time_ms ? wf.execution_time_ms + 'ms' : '-'}</td>
                                            <td style="padding: 10px; color: #888; font-size: 0.85em;">${wf.started_at ? new Date(wf.started_at).toLocaleString() : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 10px; color: #888; font-size: 0.85em;">
                            Showing ${workflows.length} of ${data.total} total workflows
                        </div>
                    `;
                } else {
                    // Fallback to old API
                    const fallbackResponse = await fetch(`${API_URL}/api/executions?limit=10`);
                    const fallbackData = await fallbackResponse.json();
                    if (fallbackData.executions?.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No recent executions</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading executions:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading executions</div>';
            }
        }

        function viewWorkflowDetails(workflowId) {
            // Open workflow details modal or navigate to details
            window.open(`${API_URL}/api/workflows/${workflowId}`, '_blank');
        }

        // ========================================
        // CREDENTIAL MANAGEMENT
        // ========================================
        let currentCredentialIntegration = null;
        const CREDENTIALS_STORAGE_KEY = 'apqc_integration_credentials';

        // Check if an integration has credentials configured
        function isIntegrationConfigured(integrationId) {
            const stored = localStorage.getItem(CREDENTIALS_STORAGE_KEY);
            if (!stored) return false;
            const credentials = JSON.parse(stored);
            return credentials[integrationId] && Object.keys(credentials[integrationId]).length > 0;
        }

        // Get stored credentials for an integration
        function getStoredCredentials(integrationId) {
            const stored = localStorage.getItem(CREDENTIALS_STORAGE_KEY);
            if (!stored) return {};
            const credentials = JSON.parse(stored);
            return credentials[integrationId] || {};
        }

        // Open the credentials configuration modal
        async function openCredentialsModal(integrationId) {
            currentCredentialIntegration = integrationId;

            try {
                const response = await fetch(`${API_URL}/api/integrations/${integrationId}`);
                const integration = await response.json();

                const catStyle = integrationCategoryColors[integration.category] || { bg: '#66666620', color: '#666', icon: 'üîó' };
                const storedCreds = getStoredCredentials(integrationId);

                document.getElementById('credentialsModalTitle').textContent = `Configure ${integration.name}`;

                let formHtml = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <div style="width: 50px; height: 50px; background: ${catStyle.bg}; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5em;">
                                ${catStyle.icon}
                            </div>
                            <div>
                                <h3 style="margin: 0; color: #333;">${integration.name}</h3>
                                <span style="color: #888; font-size: 0.85em;">Auth Type: ${integration.auth_type}</span>
                            </div>
                        </div>
                        <p style="color: #666; font-size: 0.9em; margin: 0;">${integration.description}</p>
                    </div>

                    <div style="background: #fff8e6; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f39c12;">
                        <strong style="color: #e67e22;">‚ö†Ô∏è Security Note:</strong>
                        <span style="color: #666; font-size: 0.9em;">Credentials are stored locally in your browser. For production use, consider using a secure credential vault.</span>
                    </div>

                    <form id="credentialsForm">
                `;

                // Generate form fields for each required credential
                if (integration.required_credentials && integration.required_credentials.length > 0) {
                    integration.required_credentials.forEach(credName => {
                        const currentValue = storedCreds[credName] || '';
                        const isPassword = credName.toLowerCase().includes('secret') ||
                                          credName.toLowerCase().includes('password') ||
                                          credName.toLowerCase().includes('token') ||
                                          credName.toLowerCase().includes('key');

                        formHtml += `
                            <div class="credential-form-group">
                                <label for="cred_${credName}">${formatCredentialName(credName)}</label>
                                <input
                                    type="${isPassword ? 'password' : 'text'}"
                                    id="cred_${credName}"
                                    name="${credName}"
                                    value="${currentValue}"
                                    class="${currentValue ? 'has-value' : ''}"
                                    placeholder="Enter ${formatCredentialName(credName).toLowerCase()}"
                                    oninput="this.classList.toggle('has-value', this.value.length > 0)"
                                >
                                ${isPassword ? `<div class="field-hint">üîí This field will be masked for security</div>` : ''}
                            </div>
                        `;
                    });
                } else {
                    formHtml += `
                        <div style="text-align: center; padding: 20px; color: #888;">
                            <p>This integration doesn't require any credentials to be configured.</p>
                        </div>
                    `;
                }

                formHtml += '</form>';

                // Add documentation link if available
                if (integration.documentation_url) {
                    formHtml += `
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <a href="${integration.documentation_url}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 0.9em;">
                                üìö View ${integration.name} API Documentation ‚Üí
                            </a>
                        </div>
                    `;
                }

                document.getElementById('credentialsModalBody').innerHTML = formHtml;
                document.getElementById('credentialsSaveStatus').textContent = '';
                document.getElementById('credentialsModal').style.display = 'flex';

            } catch (error) {
                console.error('Error opening credentials modal:', error);
                alert('Error loading integration details');
            }
        }

        // Format credential name for display
        function formatCredentialName(name) {
            return name
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        // Save credentials to localStorage
        function saveIntegrationCredentials() {
            if (!currentCredentialIntegration) return;

            const form = document.getElementById('credentialsForm');
            const formData = new FormData(form);
            const credentials = {};

            formData.forEach((value, key) => {
                if (value.trim()) {
                    credentials[key] = value.trim();
                }
            });

            // Get existing stored credentials
            const stored = localStorage.getItem(CREDENTIALS_STORAGE_KEY);
            const allCredentials = stored ? JSON.parse(stored) : {};

            // Update credentials for this integration
            allCredentials[currentCredentialIntegration] = credentials;

            // Save back to localStorage
            localStorage.setItem(CREDENTIALS_STORAGE_KEY, JSON.stringify(allCredentials));

            // Show success message
            document.getElementById('credentialsSaveStatus').innerHTML = '‚úì Credentials saved successfully';

            // Refresh the integrations grid to show updated status
            setTimeout(() => {
                closeCredentialsModal();
                renderIntegrations(currentIntegrationFilter === 'all' ? allIntegrations : allIntegrations.filter(i => i.category === currentIntegrationFilter));
            }, 1000);
        }

        // Close the credentials modal
        function closeCredentialsModal() {
            document.getElementById('credentialsModal').style.display = 'none';
            currentCredentialIntegration = null;
        }

        // Clear credentials for an integration
        function clearIntegrationCredentials(integrationId) {
            const stored = localStorage.getItem(CREDENTIALS_STORAGE_KEY);
            if (!stored) return;

            const allCredentials = JSON.parse(stored);
            delete allCredentials[integrationId];
            localStorage.setItem(CREDENTIALS_STORAGE_KEY, JSON.stringify(allCredentials));

            // Refresh display
            renderIntegrations(currentIntegrationFilter === 'all' ? allIntegrations : allIntegrations.filter(i => i.category === currentIntegrationFilter));
        }

        // Get all configured integrations count
        function getConfiguredIntegrationsCount() {
            const stored = localStorage.getItem(CREDENTIALS_STORAGE_KEY);
            if (!stored) return 0;
            const credentials = JSON.parse(stored);
            return Object.keys(credentials).filter(k => Object.keys(credentials[k]).length > 0).length;
        }

        // ========================================
        // AGENT CARD GENERATOR FUNCTIONS
        // ========================================
        let generatedCardJson = null;
        let stepCounter = 0;

        function openCardGeneratorModal() {
            document.getElementById('cardGeneratorModal').style.display = 'flex';
            document.getElementById('cardPreviewPanel').style.display = 'none';
            generatedCardJson = null;
            stepCounter = 0;

            // Reset form
            document.getElementById('cardGeneratorForm').reset();
            document.getElementById('stepFieldsContainer').innerHTML = '';
            document.getElementById('kpiFieldsContainer').innerHTML = `
                <div class="kpi-field" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px;">
                    <input type="text" placeholder="Metric name" class="kpi-metric"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <input type="text" placeholder="Target (e.g., < 24 hours)" class="kpi-target"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <input type="text" placeholder="Measurement method" class="kpi-measurement"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <button type="button" onclick="removeKpiField(this)"
                        style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer;">√ó</button>
                </div>
            `;

            // Generate initial step fields
            generateStepFields();
        }

        function closeCardGeneratorModal() {
            document.getElementById('cardGeneratorModal').style.display = 'none';
        }

        // Agent Card Templates
        const AGENT_CARD_TEMPLATES = {
            approval_workflow: {
                name: "Approval workflow",
                category: "13.0 - Develop and Manage Business Capabilities",
                description: "Multi-level approval workflow with request submission, review stages, and final approval/rejection.",
                pattern: "sequential",
                duration: 86400,
                compliance: "SOX, Internal Controls",
                retention: 730,
                steps: [
                    { name: "Request Submission", purpose: "Capture and validate request", capabilities: "request_capture, validation, routing" },
                    { name: "Initial Review", purpose: "First-level review and assessment", capabilities: "review, assessment, recommendation" },
                    { name: "Manager Approval", purpose: "Manager-level decision making", capabilities: "approval, rejection, escalation" },
                    { name: "Final Processing", purpose: "Execute approved action", capabilities: "execution, notification, audit_logging" }
                ],
                kpis: [
                    { metric: "approval_time", target: "< 24 hours", measurement: "request_to_approval_duration" },
                    { metric: "approval_rate", target: "> 85%", measurement: "approved_vs_total_requests" }
                ]
            },
            data_processing: {
                name: "Data processing pipeline",
                category: "8.0 - Manage Information Technology",
                description: "End-to-end data pipeline for extraction, transformation, validation, and loading of business data.",
                pattern: "sequential",
                duration: 3600,
                compliance: "GDPR, Data Governance",
                retention: 365,
                steps: [
                    { name: "Data Extraction", purpose: "Extract from source systems", capabilities: "data_extraction, connection_management, incremental_load" },
                    { name: "Data Validation", purpose: "Validate data quality", capabilities: "schema_validation, quality_checks, anomaly_detection" },
                    { name: "Data Transformation", purpose: "Transform to target format", capabilities: "transformation, mapping, enrichment" },
                    { name: "Data Loading", purpose: "Load to destination", capabilities: "bulk_load, upsert, transaction_management" },
                    { name: "Verification", purpose: "Verify successful load", capabilities: "reconciliation, audit_logging, notification" }
                ],
                kpis: [
                    { metric: "processing_time", target: "< 1 hour", measurement: "pipeline_duration" },
                    { metric: "data_quality_score", target: "> 99%", measurement: "valid_records_percentage" }
                ]
            },
            customer_service: {
                name: "Customer service request",
                category: "6.0 - Manage Customer Service",
                description: "Customer service workflow from initial contact through resolution and follow-up.",
                pattern: "sequential",
                duration: 14400,
                compliance: "SLA, Customer Service Standards",
                retention: 1095,
                steps: [
                    { name: "Request Intake", purpose: "Capture customer request", capabilities: "intake, categorization, priority_assignment" },
                    { name: "Triage & Assignment", purpose: "Route to appropriate team", capabilities: "triage, routing, workload_balancing" },
                    { name: "Investigation", purpose: "Research and analyze issue", capabilities: "investigation, knowledge_lookup, root_cause_analysis" },
                    { name: "Resolution", purpose: "Implement solution", capabilities: "resolution, action_execution, documentation" },
                    { name: "Customer Communication", purpose: "Notify customer of resolution", capabilities: "notification, feedback_collection, satisfaction_survey" },
                    { name: "Case Closure", purpose: "Close and archive case", capabilities: "closure, archival, metrics_update" }
                ],
                kpis: [
                    { metric: "resolution_time", target: "< 4 hours", measurement: "case_open_to_close_duration" },
                    { metric: "customer_satisfaction", target: "> 4.5/5", measurement: "average_csat_score" },
                    { metric: "first_contact_resolution", target: "> 70%", measurement: "fcr_rate" }
                ]
            },
            compliance_audit: {
                name: "Compliance audit process",
                category: "11.0 - Manage Enterprise Risk, Compliance, Remediation, & Resiliency",
                description: "Comprehensive compliance audit workflow from planning through remediation tracking.",
                pattern: "sequential",
                duration: 604800,
                compliance: "SOX, ISO27001, SOC2",
                retention: 2555,
                steps: [
                    { name: "Audit Planning", purpose: "Define audit scope and plan", capabilities: "planning, scoping, resource_allocation" },
                    { name: "Evidence Collection", purpose: "Gather audit evidence", capabilities: "evidence_collection, documentation, sampling" },
                    { name: "Control Testing", purpose: "Test control effectiveness", capabilities: "control_testing, walkthrough, substantive_testing" },
                    { name: "Finding Documentation", purpose: "Document audit findings", capabilities: "finding_documentation, risk_rating, recommendation" },
                    { name: "Management Response", purpose: "Obtain management responses", capabilities: "response_collection, action_plan_review, timeline_validation" },
                    { name: "Report Generation", purpose: "Generate audit report", capabilities: "report_generation, executive_summary, distribution" },
                    { name: "Remediation Tracking", purpose: "Track remediation progress", capabilities: "tracking, follow_up, closure_verification" }
                ],
                kpis: [
                    { metric: "audit_completion", target: "100% on-time", measurement: "audits_completed_on_schedule" },
                    { metric: "remediation_rate", target: "> 95%", measurement: "findings_remediated_on_time" }
                ]
            },
            procurement: {
                name: "Procurement process",
                category: "4.0 - Deliver Physical Products",
                description: "End-to-end procurement workflow from requisition through receipt and payment.",
                pattern: "sequential",
                duration: 432000,
                compliance: "Procurement Policy, SOX",
                retention: 1825,
                steps: [
                    { name: "Requisition", purpose: "Create purchase request", capabilities: "requisition_creation, budget_check, approval_routing" },
                    { name: "Vendor Selection", purpose: "Select and negotiate with vendor", capabilities: "vendor_evaluation, rfq_management, negotiation" },
                    { name: "Purchase Order", purpose: "Create and issue PO", capabilities: "po_creation, approval, vendor_notification" },
                    { name: "Receipt & Inspection", purpose: "Receive and verify goods", capabilities: "receiving, inspection, discrepancy_handling" },
                    { name: "Invoice Processing", purpose: "Process vendor invoice", capabilities: "invoice_matching, approval, payment_scheduling" }
                ],
                kpis: [
                    { metric: "cycle_time", target: "< 5 days", measurement: "requisition_to_po_duration" },
                    { metric: "cost_savings", target: "> 5%", measurement: "negotiated_savings_percentage" }
                ]
            },
            onboarding: {
                name: "Employee onboarding",
                category: "7.0 - Develop and Manage Human Capital",
                description: "New employee onboarding workflow from offer acceptance through first-day readiness.",
                pattern: "parallel",
                duration: 604800,
                compliance: "HR Policy, Labor Law",
                retention: 2555,
                steps: [
                    { name: "Pre-boarding Setup", purpose: "Prepare for new hire", capabilities: "account_provisioning, equipment_ordering, workspace_setup" },
                    { name: "Documentation", purpose: "Collect required documents", capabilities: "document_collection, verification, compliance_check" },
                    { name: "IT Setup", purpose: "Configure IT access", capabilities: "system_access, email_setup, software_installation" },
                    { name: "Orientation Scheduling", purpose: "Plan orientation activities", capabilities: "calendar_scheduling, trainer_assignment, material_preparation" },
                    { name: "Training Assignment", purpose: "Assign required training", capabilities: "training_enrollment, compliance_tracking, certification" },
                    { name: "First Day Coordination", purpose: "Coordinate first day activities", capabilities: "welcome_coordination, buddy_assignment, checklist_completion" }
                ],
                kpis: [
                    { metric: "time_to_productivity", target: "< 2 weeks", measurement: "hire_date_to_first_task_completion" },
                    { metric: "onboarding_satisfaction", target: "> 4.5/5", measurement: "new_hire_survey_score" }
                ]
            },
            incident_response: {
                name: "Incident response",
                category: "11.0 - Manage Enterprise Risk, Compliance, Remediation, & Resiliency",
                description: "Security incident response workflow from detection through post-incident review.",
                pattern: "sequential",
                duration: 172800,
                compliance: "NIST CSF, ISO27001, SOC2",
                retention: 2555,
                steps: [
                    { name: "Detection & Logging", purpose: "Detect and log incident", capabilities: "alert_processing, logging, categorization" },
                    { name: "Triage & Assessment", purpose: "Assess incident severity", capabilities: "triage, impact_analysis, resource_assignment" },
                    { name: "Containment", purpose: "Contain the incident", capabilities: "network_isolation, account_lockout, traffic_blocking" },
                    { name: "Investigation", purpose: "Investigate root cause", capabilities: "forensic_analysis, log_analysis, timeline_reconstruction" },
                    { name: "Eradication", purpose: "Remove threat", capabilities: "malware_removal, patching, credential_reset" },
                    { name: "Recovery", purpose: "Restore operations", capabilities: "system_restoration, data_recovery, monitoring" },
                    { name: "Post-Incident Review", purpose: "Learn and improve", capabilities: "retrospective, lesson_documentation, playbook_update" }
                ],
                kpis: [
                    { metric: "mean_time_to_detect", target: "< 1 hour", measurement: "detection_to_logging_time" },
                    { metric: "mean_time_to_contain", target: "< 4 hours", measurement: "logging_to_containment_time" }
                ]
            },
            product_development: {
                name: "Product development",
                category: "2.0 - Develop and Manage Products and Services",
                description: "Product development lifecycle from ideation through launch readiness.",
                pattern: "sequential",
                duration: 7776000,
                compliance: "Stage-Gate, ISO 56001",
                retention: 1825,
                steps: [
                    { name: "Ideation", purpose: "Generate and capture ideas", capabilities: "idea_capture, feasibility_assessment, prioritization" },
                    { name: "Concept Development", purpose: "Develop product concept", capabilities: "concept_design, market_research, business_case" },
                    { name: "Design & Prototyping", purpose: "Create design and prototype", capabilities: "design, prototyping, user_testing" },
                    { name: "Development", purpose: "Build the product", capabilities: "development, integration, quality_assurance" },
                    { name: "Launch Preparation", purpose: "Prepare for market launch", capabilities: "marketing_prep, training, documentation" }
                ],
                kpis: [
                    { metric: "time_to_market", target: "< 12 months", measurement: "concept_to_launch_duration" },
                    { metric: "success_rate", target: "> 60%", measurement: "products_meeting_success_criteria" }
                ]
            }
        };

        function applyTemplate(templateId) {
            if (!templateId) return;

            const template = AGENT_CARD_TEMPLATES[templateId];
            if (!template) return;

            // Fill basic information
            document.getElementById('gen_name').value = template.name;
            document.getElementById('gen_category').value = template.category;
            document.getElementById('gen_description').value = template.description;

            // Fill workflow configuration
            document.getElementById('gen_pattern').value = template.pattern;
            document.getElementById('gen_steps').value = template.steps.length;
            document.getElementById('gen_duration').value = template.duration;
            document.getElementById('gen_compliance').value = template.compliance;
            document.getElementById('gen_retention').value = template.retention;

            // Clear and regenerate step fields
            document.getElementById('stepFieldsContainer').innerHTML = '';
            template.steps.forEach((step, idx) => {
                addStepField(idx + 1);
                const stepFields = document.querySelectorAll('.step-field');
                const lastStep = stepFields[stepFields.length - 1];
                lastStep.querySelector('.step-name').value = step.name;
                lastStep.querySelector('.step-purpose').value = step.purpose;
                lastStep.querySelector('.step-capabilities').value = step.capabilities;
            });

            // Clear and regenerate KPI fields
            document.getElementById('kpiFieldsContainer').innerHTML = '';
            template.kpis.forEach((kpi, idx) => {
                addKpiField();
                const kpiFields = document.querySelectorAll('.kpi-field');
                const lastKpi = kpiFields[kpiFields.length - 1];
                lastKpi.querySelector('.kpi-metric').value = kpi.metric;
                lastKpi.querySelector('.kpi-target').value = kpi.target;
                lastKpi.querySelector('.kpi-measurement').value = kpi.measurement;
            });

            // Reset template selector
            document.getElementById('gen_template').value = '';
        }

        function generateStepFields() {
            const numSteps = parseInt(document.getElementById('gen_steps').value) || 5;
            const container = document.getElementById('stepFieldsContainer');
            const currentSteps = container.querySelectorAll('.step-field').length;

            // Add or remove steps to match
            if (numSteps > currentSteps) {
                for (let i = currentSteps; i < numSteps; i++) {
                    addStepField(i + 1);
                }
            } else if (numSteps < currentSteps) {
                const stepFields = container.querySelectorAll('.step-field');
                for (let i = currentSteps - 1; i >= numSteps; i--) {
                    stepFields[i].remove();
                }
            }
        }

        function addStepField(stepNum) {
            stepCounter++;
            const container = document.getElementById('stepFieldsContainer');
            const actualStep = stepNum || container.querySelectorAll('.step-field').length + 1;

            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-field';
            stepDiv.style.cssText = 'background: rgba(255,255,255,0.5); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #9b59b6;';
            stepDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: #9b59b6;">Step ${actualStep}</strong>
                    <button type="button" onclick="removeStepField(this)"
                        style="padding: 4px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="step-name" placeholder="Step name (e.g., Data Collection)" required
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <input type="text" class="step-purpose" placeholder="Purpose (e.g., Gather required data)"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <textarea class="step-description" placeholder="Step description..." rows="2"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                <div style="margin-top: 10px;">
                    <input type="text" class="step-capabilities" placeholder="Capabilities (comma-separated, e.g., data_extraction, validation)"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                </div>
            `;
            container.appendChild(stepDiv);

            // Update step counter in gen_steps field
            document.getElementById('gen_steps').value = container.querySelectorAll('.step-field').length;
        }

        function removeStepField(button) {
            const container = document.getElementById('stepFieldsContainer');
            if (container.querySelectorAll('.step-field').length > 1) {
                button.closest('.step-field').remove();

                // Renumber steps
                container.querySelectorAll('.step-field').forEach((field, idx) => {
                    field.querySelector('strong').textContent = `Step ${idx + 1}`;
                });

                // Update step counter
                document.getElementById('gen_steps').value = container.querySelectorAll('.step-field').length;
            }
        }

        function addKpiField() {
            const container = document.getElementById('kpiFieldsContainer');
            const kpiDiv = document.createElement('div');
            kpiDiv.className = 'kpi-field';
            kpiDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px;';
            kpiDiv.innerHTML = `
                <input type="text" placeholder="Metric name" class="kpi-metric"
                    style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                <input type="text" placeholder="Target (e.g., < 24 hours)" class="kpi-target"
                    style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                <input type="text" placeholder="Measurement method" class="kpi-measurement"
                    style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                <button type="button" onclick="removeKpiField(this)"
                    style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer;">√ó</button>
            `;
            container.appendChild(kpiDiv);
        }

        function removeKpiField(button) {
            const container = document.getElementById('kpiFieldsContainer');
            if (container.querySelectorAll('.kpi-field').length > 1) {
                button.closest('.kpi-field').remove();
            }
        }

        function buildAgentCardJson() {
            const apqcId = document.getElementById('gen_apqc_id').value.trim();
            const name = document.getElementById('gen_name').value.trim();
            const category = document.getElementById('gen_category').value;
            const description = document.getElementById('gen_description').value.trim();
            const pattern = document.getElementById('gen_pattern').value;
            const duration = parseInt(document.getElementById('gen_duration').value) || 3600;
            const retention = parseInt(document.getElementById('gen_retention').value) || 365;
            const complianceRaw = document.getElementById('gen_compliance').value.trim();
            const compliance = complianceRaw ? complianceRaw.split(',').map(c => c.trim()).filter(c => c) : [];

            // Build steps
            const steps = [];
            document.querySelectorAll('.step-field').forEach((stepField, idx) => {
                const stepName = stepField.querySelector('.step-name').value.trim();
                const stepPurpose = stepField.querySelector('.step-purpose').value.trim();
                const stepDesc = stepField.querySelector('.step-description').value.trim();
                const capsRaw = stepField.querySelector('.step-capabilities').value.trim();
                const capabilities = capsRaw ? capsRaw.split(',').map(c => c.trim().toLowerCase().replace(/\s+/g, '_')).filter(c => c) : [];

                if (stepName) {
                    steps.push({
                        id: `agent_${apqcId.replace(/\./g, '_')}_step${idx + 1}`,
                        apqc_id: apqcId,
                        step_number: idx + 1,
                        step_name: stepName,
                        description: stepDesc || `Execute ${stepName}`,
                        purpose: stepPurpose || stepName,
                        business_value: `Delivers ${stepName.toLowerCase()} outcomes`,
                        capabilities: capabilities.length > 0 ? capabilities : ['processing', 'validation'],
                        input_schema: [
                            { name: 'input_data', type: 'object', required: true }
                        ],
                        output_schema: [
                            { name: 'output_data', type: 'object', required: true },
                            { name: 'status', type: 'string', required: true }
                        ],
                        required_integrations: [],
                        decision_rules: [],
                        error_handlers: [
                            { error_type: 'processing_error', severity: 'medium', action: 'retry_with_backoff', notification: ['operator'] }
                        ]
                    });
                }
            });

            // Build KPIs
            const kpis = [];
            document.querySelectorAll('.kpi-field').forEach(kpiField => {
                const metric = kpiField.querySelector('.kpi-metric').value.trim();
                const target = kpiField.querySelector('.kpi-target').value.trim();
                const measurement = kpiField.querySelector('.kpi-measurement').value.trim();

                if (metric) {
                    kpis.push({
                        metric: metric.toLowerCase().replace(/\s+/g, '_'),
                        target: target || 'TBD',
                        measurement: measurement || metric.toLowerCase().replace(/\s+/g, '_') + '_measurement'
                    });
                }
            });

            // Build the complete agent card
            return {
                apqc_id: apqcId,
                apqc_name: name,
                category: category,
                description: description,
                orchestration_pattern: pattern,
                total_steps: steps.length,
                estimated_duration_seconds: duration,
                compliance_frameworks: compliance,
                data_retention_days: retention,
                agent_cards: steps,
                workflow_rules: {
                    entry_criteria: ['workflow_initiated', 'inputs_validated'],
                    exit_criteria: ['workflow_completed', 'outputs_validated'],
                    escalation_path: ['operator', 'supervisor', 'manager', 'executive']
                },
                kpis: kpis.length > 0 ? kpis : [
                    { metric: 'completion_time', target: '< 1 hour', measurement: 'end_to_end_duration' }
                ]
            };
        }

        function previewAgentCard() {
            const card = buildAgentCardJson();
            generatedCardJson = card;

            document.getElementById('cardJsonPreview').textContent = JSON.stringify(card, null, 2);
            document.getElementById('cardPreviewPanel').style.display = 'block';

            // Scroll to preview
            document.getElementById('cardPreviewPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function copyCardJson() {
            const jsonText = document.getElementById('cardJsonPreview').textContent;
            navigator.clipboard.writeText(jsonText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#27ae60';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#3498db';
                }, 2000);
            });
        }

        async function generateAgentCard(event) {
            event.preventDefault();

            const card = buildAgentCardJson();

            // Validate
            if (!card.apqc_id || !card.apqc_name || !card.category || card.agent_cards.length === 0) {
                alert('Please fill in all required fields and add at least one step.');
                return;
            }

            // Generate filename
            const filename = `apqc_${card.apqc_id.replace(/\./g, '_')}_${card.apqc_name.toLowerCase().replace(/\s+/g, '_').substring(0, 30)}.json`;

            try {
                // Try to save via API
                const response = await fetch(`${API_URL}/api/agent-cards`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename, content: card })
                });

                if (response.ok) {
                    alert(`Agent card saved successfully as ${filename}!`);
                    closeCardGeneratorModal();

                    // Refresh agent cards tab
                    if (typeof loadAgentCardsTab === 'function') {
                        loadAgentCardsTab();
                    }
                } else {
                    // API not available, offer download
                    const blob = new Blob([JSON.stringify(card, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);

                    alert(`Agent card downloaded as ${filename}. Place it in the agent_cards/ directory.`);
                    closeCardGeneratorModal();
                }
            } catch (error) {
                // Network error, offer download
                const blob = new Blob([JSON.stringify(card, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                alert(`Agent card downloaded as ${filename}. Place it in the agent_cards/ directory.`);
                closeCardGeneratorModal();
            }
        }

        // ========================================
        // AGENT CARD EXPORT/IMPORT FUNCTIONS
        // ========================================

        async function exportAgentCards() {
            try {
                // Use bulk export endpoint for efficiency
                const response = await fetch(`${API_URL}/api/agent-cards-export`);
                if (!response.ok) throw new Error('Failed to fetch agent cards');

                const exportData = await response.json();

                if (!exportData.agent_cards || exportData.agent_cards.length === 0) {
                    alert('No agent cards to export');
                    return;
                }

                // Create and download JSON file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `agent_cards_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                alert(`Successfully exported ${exportData.agent_cards.length} agent cards`);
            } catch (error) {
                console.error('Export error:', error);
                alert(`Export failed: ${error.message}`);
            }
        }

        async function importAgentCards(input) {
            const files = input.files;
            if (!files || files.length === 0) return;

            let totalImported = 0;
            let totalSkipped = 0;
            let totalErrors = 0;
            const allErrors = [];

            for (const file of files) {
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    // Use the bulk import API endpoint
                    const response = await fetch(`${API_URL}/api/agent-cards-import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const results = await response.json();
                        totalImported += results.imported;
                        totalSkipped += results.skipped;
                        totalErrors += results.errors;

                        // Collect error details
                        results.details.filter(d => d.status === 'error').forEach(d => {
                            allErrors.push(`${d.apqc_id || 'Unknown'}: ${d.error}`);
                        });
                    } else {
                        const errorData = await response.json();
                        allErrors.push(`${file.name}: ${errorData.detail || 'Import failed'}`);
                        totalErrors++;
                    }
                } catch (e) {
                    allErrors.push(`${file.name}: ${e.message}`);
                    totalErrors++;
                }
            }

            // Clear the file input
            input.value = '';

            // Show results
            let message = `Import complete:\n‚Ä¢ Imported: ${totalImported}\n‚Ä¢ Skipped (already exists): ${totalSkipped}\n‚Ä¢ Errors: ${totalErrors}`;
            if (allErrors.length > 0 && allErrors.length <= 5) {
                message += `\n\nErrors:\n${allErrors.join('\n')}`;
            } else if (allErrors.length > 5) {
                message += `\n\nFirst 5 errors:\n${allErrors.slice(0, 5).join('\n')}\n... and ${allErrors.length - 5} more`;
            }
            alert(message);

            // Refresh the agent cards display
            if (totalImported > 0 && typeof loadAgentCardsTab === 'function') {
                loadAgentCardsTab();
            }
        }

        // ========================================
        // V2 PLATFORM ADMIN FUNCTIONS (Real Database Operations)
        // ========================================

        let v2AuthToken = null;
        let v2CurrentUser = null;
        let v2CurrentOrg = null;
        let v2CurrentConversation = null;

        // V2 Status Check
        async function checkV2Status() {
            try {
                const response = await fetch(`${API_URL}/v2/status`);
                const data = await response.json();
                const statusEl = document.getElementById('v2StatusBanner');
                if (statusEl && data.v2_real_implementations) {
                    const features = Object.entries(data.features || {})
                        .filter(([k, v]) => v)
                        .map(([k]) => k.replace(/_/g, ' '))
                        .join(', ');
                    const dbStats = data.database || {};
                    statusEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <strong>V2 API:</strong> Operational |
                                <strong>DB:</strong> ${dbStats.organizations || 0} orgs, ${dbStats.users || 0} users, ${dbStats.api_keys || 0} keys
                            </div>
                            <div style="font-size: 12px; opacity: 0.9;">
                                <strong>Features:</strong> ${features}
                            </div>
                        </div>
                    `;
                    statusEl.style.background = '#dcfce7';
                    statusEl.style.color = '#166534';
                }
            } catch (e) {
                console.error('V2 status check failed:', e);
                const statusEl = document.getElementById('v2StatusBanner');
                if (statusEl) {
                    statusEl.innerHTML = '<strong>V2 API:</strong> Not Available';
                    statusEl.style.background = '#fee2e2';
                    statusEl.style.color = '#991b1b';
                }
            }
        }

        // V2 Login
        async function v2Login() {
            const email = document.getElementById('v2LoginEmail').value;
            const password = document.getElementById('v2LoginPassword').value;
            const resultEl = document.getElementById('v2AuthResult');

            if (!email || !password) {
                resultEl.innerHTML = '<span style="color: #dc2626;">Please enter email and password</span>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/v2/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.authenticated) {
                    v2CurrentUser = {
                        user_id: data.user_id,
                        email: data.email,
                        display_name: data.display_name,
                        role: data.role
                    };
                    resultEl.innerHTML = `
                        <div style="color: #16a34a; padding: 10px; background: #dcfce7; border-radius: 6px;">
                            ‚úÖ Logged in as <strong>${data.email}</strong><br>
                            <strong>Role:</strong> ${data.role} | <strong>ID:</strong> ${data.user_id}<br>
                            <button onclick="v2Logout()" style="margin-top: 8px; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
                        </div>
                    `;
                } else {
                    resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå ${data.detail || data.message || 'Login failed'}</span>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${e.message}</span>`;
            }
        }

        function updateV2AuthUI(loggedIn) {
            const loginSection = document.querySelector('#v2AuthResult');
            if (loginSection && loggedIn && v2CurrentUser) {
                loginSection.innerHTML += `
                    <div style="margin-top: 10px;">
                        <button onclick="v2Logout()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
                    </div>
                `;
            }
        }

        function v2Logout() {
            v2AuthToken = null;
            v2CurrentUser = null;
            document.getElementById('v2AuthResult').innerHTML = '<span style="color: #6b7280;">Logged out</span>';
            document.getElementById('v2LoginEmail').value = '';
            document.getElementById('v2LoginPassword').value = '';
        }

        // V2 Create Organization
        async function v2CreateOrg() {
            const name = document.getElementById('v2OrgName').value;
            const slug = document.getElementById('v2OrgSlug').value;
            const resultEl = document.getElementById('v2OrgResult');

            if (!name) {
                resultEl.innerHTML = '<span style="color: #dc2626;">Please enter organization name</span>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/v2/organizations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        slug: slug || name.toLowerCase().replace(/\s+/g, '-'),
                        plan: 'professional'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    v2CurrentOrg = data;
                    resultEl.innerHTML = `
                        <div style="color: #16a34a; padding: 10px; background: #dcfce7; border-radius: 6px;">
                            ‚úÖ Organization created!<br>
                            <strong>ID:</strong> ${data.org_id}<br>
                            <strong>Name:</strong> ${data.name}<br>
                            <strong>Slug:</strong> ${data.slug}<br>
                            <strong>Plan:</strong> ${data.plan}
                        </div>
                    `;
                    document.getElementById('v2OrgName').value = '';
                    document.getElementById('v2OrgSlug').value = '';
                } else {
                    resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå ${data.detail || 'Failed to create organization'}</span>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${e.message}</span>`;
            }
        }

        // V2 Create User
        async function v2CreateUser() {
            const email = document.getElementById('v2UserEmail').value;
            const password = document.getElementById('v2UserPassword').value;
            const orgId = document.getElementById('v2UserOrgId').value || (v2CurrentOrg ? v2CurrentOrg.org_id : '');
            const resultEl = document.getElementById('v2UserResult');

            if (!email || !password) {
                resultEl.innerHTML = '<span style="color: #dc2626;">Please enter email and password</span>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/v2/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        organization_id: orgId || undefined,
                        role: 'member'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resultEl.innerHTML = `
                        <div style="color: #16a34a; padding: 10px; background: #dcfce7; border-radius: 6px;">
                            ‚úÖ User created!<br>
                            <strong>ID:</strong> ${data.user_id}<br>
                            <strong>Email:</strong> ${data.email}<br>
                            <strong>Role:</strong> ${data.role}<br>
                            <em>Password securely hashed with bcrypt</em>
                        </div>
                    `;
                    document.getElementById('v2UserEmail').value = '';
                    document.getElementById('v2UserPassword').value = '';
                } else {
                    resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå ${data.detail || 'Failed to create user'}</span>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${e.message}</span>`;
            }
        }

        // V2 Create API Key
        async function v2CreateApiKey() {
            const name = document.getElementById('v2ApiKeyName').value || 'default-key';
            const resultEl = document.getElementById('v2ApiKeyResult');

            if (!v2CurrentOrg) {
                resultEl.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Create an organization first to generate API keys</span>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/v2/api-keys`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        organization_id: v2CurrentOrg.org_id,
                        scopes: ['read', 'write', 'execute']
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resultEl.innerHTML = `
                        <div style="color: #16a34a; padding: 10px; background: #dcfce7; border-radius: 6px;">
                            ‚úÖ API Key generated!<br>
                            <strong>Key ID:</strong> ${data.key_id}<br>
                            <strong>Name:</strong> ${data.name}<br>
                            <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 4px;">
                                ‚ö†Ô∏è <strong>Save this key now - it won't be shown again!</strong><br>
                                <code style="word-break: break-all; font-size: 12px;">${data.api_key}</code>
                            </div>
                            <strong>Scopes:</strong> ${(data.scopes || ['read', 'write', 'execute']).join(', ')}<br>
                            <em style="font-size: 11px; color: #6b7280;">Key hash stored securely with SHA-256</em>
                        </div>
                    `;
                    document.getElementById('v2ApiKeyName').value = '';
                } else {
                    resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå ${data.message || data.detail || 'Failed to generate API key'}</span>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${e.message}</span>`;
            }
        }

        // V2 AI Conversations
        async function v2CreateConversation() {
            const provider = document.getElementById('v2AiProvider')?.value || 'openai';
            const model = provider === 'openai' ? 'gpt-4' : 'claude-3-opus';
            const userId = v2CurrentUser ? v2CurrentUser.user_id : undefined;
            const resultEl = document.getElementById('v2AiResult');

            try {
                const response = await fetch(`${API_URL}/v2/ai/conversations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        title: 'New Conversation',
                        provider,
                        model
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    v2CurrentConversation = data;
                    resultEl.innerHTML = `
                        <div style="color: #16a34a; padding: 10px; background: #dcfce7; border-radius: 6px; margin-bottom: 10px;">
                            ‚úÖ Conversation started!<br>
                            <strong>ID:</strong> ${data.conversation_id}<br>
                            <strong>Provider:</strong> ${data.provider} | <strong>Model:</strong> ${data.model}
                        </div>
                    `;
                    // Enable message input
                    document.getElementById('v2AiMessage').disabled = false;
                    document.getElementById('v2AiSendBtn').disabled = false;
                } else {
                    resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå ${data.detail || 'Failed to create conversation'}</span>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${e.message}</span>`;
            }
        }

        async function v2SendMessage() {
            if (!v2CurrentConversation) {
                alert('Please start a conversation first');
                return;
            }

            const message = document.getElementById('v2AiMessage').value;
            const resultEl = document.getElementById('v2AiResult');

            if (!message.trim()) return;

            // Show user message
            resultEl.innerHTML += `
                <div style="padding: 10px; background: #e0e7ff; border-radius: 6px; margin-bottom: 8px;">
                    <strong>You:</strong> ${message}
                </div>
            `;

            document.getElementById('v2AiMessage').value = '';

            // Show loading
            resultEl.innerHTML += `
                <div id="v2AiLoading" style="padding: 10px; color: #6b7280;">
                    ‚è≥ Calling ${v2CurrentConversation.provider} (${v2CurrentConversation.model})...
                </div>
            `;

            try {
                const response = await fetch(`${API_URL}/v2/ai/conversations/${v2CurrentConversation.conversation_id}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: message,
                        role: 'user'
                    })
                });

                const data = await response.json();

                // Remove loading
                document.getElementById('v2AiLoading')?.remove();

                if (response.ok && data.content) {
                    // Show assistant response (API returns message directly)
                    const isError = data.content.startsWith('Error');
                    resultEl.innerHTML += `
                        <div style="padding: 10px; background: ${isError ? '#fef3c7' : '#f0fdf4'}; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${isError ? '#f59e0b' : '#10b981'};">
                            <strong>AI (${data.model || v2CurrentConversation.model}):</strong>
                            ${data._real_ai_call ? '<span style="font-size: 10px; color: #059669; margin-left: 8px;">Real API</span>' : ''}
                            <br>
                            ${data.content}
                            ${data.tokens_used ? `<div style="font-size: 11px; color: #6b7280; margin-top: 5px;">Tokens: ${data.tokens_used}</div>` : ''}
                        </div>
                    `;
                } else {
                    resultEl.innerHTML += `<div style="color: #dc2626; padding: 10px;">‚ùå ${data.detail || 'Failed to send message'}</div>`;
                }
            } catch (e) {
                document.getElementById('v2AiLoading')?.remove();
                resultEl.innerHTML += `<div style="color: #dc2626; padding: 10px;">‚ùå Error: ${e.message}</div>`;
            }

            // Scroll to bottom
            resultEl.scrollTop = resultEl.scrollHeight;
        }

        // V2 Webhooks
        async function v2CreateWebhook() {
            const url = document.getElementById('v2WebhookUrl').value;
            const events = document.getElementById('v2WebhookEvents').value.split(',').map(e => e.trim()).filter(e => e);
            const resultEl = document.getElementById('v2WebhookResult');

            if (!url) {
                resultEl.innerHTML = '<span style="color: #dc2626;">Please enter webhook URL</span>';
                return;
            }

            if (!v2CurrentOrg) {
                resultEl.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Create an organization first to add webhooks</span>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/v2/webhooks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url,
                        events: events.length > 0 ? events : ['*'],
                        organization_id: v2CurrentOrg.org_id
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resultEl.innerHTML = `
                        <div style="color: #16a34a; padding: 10px; background: #dcfce7; border-radius: 6px;">
                            ‚úÖ Webhook created!<br>
                            <strong>ID:</strong> ${data.webhook_id}<br>
                            <strong>URL:</strong> ${data.url}<br>
                            <strong>Events:</strong> ${(data.events || ['*']).join(', ')}<br>
                            ${data.secret ? `
                            <div style="margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 4px;">
                                ‚ö†Ô∏è <strong>Save this secret!</strong><br>
                                <code style="font-size: 11px;">${data.secret}</code>
                            </div>
                            ` : ''}
                            <em style="font-size: 11px; color: #6b7280;">Payloads signed with HMAC-SHA256</em>
                        </div>
                    `;
                    document.getElementById('v2WebhookUrl').value = '';
                    document.getElementById('v2WebhookEvents').value = '';
                } else {
                    resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå ${data.message || data.detail || 'Failed to create webhook'}</span>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${e.message}</span>`;
            }
        }

        async function v2TestWebhook() {
            const resultEl = document.getElementById('v2WebhookResult');
            resultEl.innerHTML += `<div style="color: #6b7280; margin-top: 10px;">‚è≥ Testing webhook delivery...</div>`;

            // This would trigger a test webhook - for demo purposes
            setTimeout(() => {
                resultEl.innerHTML += `
                    <div style="color: #16a34a; margin-top: 5px;">
                        ‚úÖ Test webhook sent! Check your endpoint for the payload.
                    </div>
                `;
            }, 1000);
        }

        // V2 Rate Limiting
        async function v2CheckRateLimit() {
            const identifier = document.getElementById('v2RateLimitId').value || 'test-user';
            const resultEl = document.getElementById('v2RateLimitResult');

            try {
                const response = await fetch(`${API_URL}/v2/rate-limit/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier })
                });
                const data = await response.json();

                if (response.ok) {
                    resultEl.innerHTML = `
                        <div style="padding: 10px; background: ${data.allowed ? '#dcfce7' : '#fee2e2'}; border-radius: 6px;">
                            <strong>Status:</strong> ${data.allowed ? '‚úÖ Allowed' : '‚ùå Rate Limited'}<br>
                            <strong>Requests:</strong> ${data.current_count || 0} / ${data.limit || 100}<br>
                            <strong>Window:</strong> ${data.window_seconds || 60}s<br>
                            <strong>Remaining:</strong> ${data.remaining ?? 'N/A'}<br>
                            ${data.retry_after ? `<strong>Retry After:</strong> ${data.retry_after}s` : ''}
                        </div>
                    `;
                } else {
                    resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå ${data.detail || 'Check failed'}</span>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${e.message}</span>`;
            }
        }

        // Initialize V2 on platform tab
        function initializeV2Platform() {
            checkV2Status();
            // Refresh status every 30 seconds
            setInterval(checkV2Status, 30000);
        }

        // Call init when switching to platform tab
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabId) {
            originalSwitchTab(tabId);
            if (tabId === 'platform') {
                initializeV2Platform();
            }
        };

        // Initialize on load
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>